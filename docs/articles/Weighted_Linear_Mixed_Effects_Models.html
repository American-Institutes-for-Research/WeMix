<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weighted Linear Mixed-Effects Models • WeMix</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Weighted Linear Mixed-Effects Models">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">WeMix</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">4.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction_to_Mixed_Effects_Models_With_WeMix.html">Introduction to Weighted Mixed-Effects Models With WeMix</a>
    </li>
    <li>
      <a href="../articles/Weighted_Linear_Mixed_Effects_Models.html">Weighted Linear Mixed-Effects Models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/American-Institutes-for-Research/WeMix/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Weighted Linear Mixed-Effects Models</h1>
                        <h4 data-toc-skip class="author">Developed by
Paul Bailey </h4>
            
            <h4 data-toc-skip class="date">February 14, 2018</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/American-Institutes-for-Research/WeMix/blob/HEAD/vignettes/Weighted_Linear_Mixed_Effects_Models.Rmd" class="external-link"><code>vignettes/Weighted_Linear_Mixed_Effects_Models.Rmd</code></a></small>
      <div class="hidden name"><code>Weighted_Linear_Mixed_Effects_Models.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>WeMix</code> package aims to fit a linear mixed model where
units are nested inside groups,which may themselves be nested in
groups,a model specified by Rabe-Hesketh and Skrondal (2006) and
Rabe-Hesketh, Skrondal, and Pickles (2002) for the GLLAMM software. The
advantage of fitting the model in nested levels is that survey sampling
weights can be incorporated; the pseudo-likelihood, at the top level, is
an integral that sums across the top-level groups, weighting each group
or unit (in a two-level model) according to sampling weights.</p>
<p>At the highest level, the likelihood
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ℒ</mi><annotation encoding="application/x-tex">\mathcal{L}</annotation></semantics></math>)
is a function of the parameters for the random-effect covariance matrix
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>),
the fixed-effect estimates
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>),
and the outcomes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>.
This equation relates the overall likelihood
[<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ℒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>;</mo><mi>𝐲</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}(\bm{\theta}, \bm{\beta}; \bm{y})</annotation></semantics></math>]
to the integral of the likelihoods of the integrals of the top-level
units
[<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>ℒ</mi><mi>j</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>;</mo><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}^{(L)}_{j}(\bm{\theta}, \bm{\beta} ; \bm{y}| \bm{u}^{(L)})</annotation></semantics></math>,
indexed by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>];
the top-level unit likelihoods have a superscript
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(L)</annotation></semantics></math>
to indicate they are for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>th
(top) level. Here we omit reference to the fixed-effect design matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐗</mi><annotation encoding="application/x-tex">\bm{X}</annotation></semantics></math>
and the random-effect design matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐙</mi><annotation encoding="application/x-tex">\bm{Z}</annotation></semantics></math>,
but the likelihood is conditional on those terms as well.
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>ℒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>;</mo><mi>𝐲</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>∫</mo><msup><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo>;</mo><msup><mi>𝛉</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><munder><mo>∏</mo><mi>j</mi></munder><mrow><mo minsize="2.4" maxsize="2.4" stretchy="false" form="prefix">[</mo><msubsup><mi>ℒ</mi><mi>j</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>;</mo><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><msup><mo minsize="2.4" maxsize="2.4" stretchy="false" form="postfix">]</mo><msubsup><mi>w</mi><mi>j</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup></msup></mrow><mi>d</mi><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\mathcal{L}(\bm{\theta}, \bm{\beta}; \bm{y}) &amp;= \int g^{(L)}(\bm{u}^{(L)};\bm{\theta}^{(L)})\prod_{j}{ \bigg[\mathcal{L}^{(L)}_{j}(\bm{\theta}, \bm{\beta} ; \bm{y}| \bm{u}^{(L)})\bigg]^{w^{(L)}_{j}}} d\bm{u}^{(L)}
\end{align}</annotation></semantics></math> where the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐮</mi><annotation encoding="application/x-tex">\bm{u}</annotation></semantics></math>
terms are the random effects, which are marginalized by integrating over
them; the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
function plays a role similar to a prior, but has its variance (or
covariance matrix) fit using covariance parameter vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>,
while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
represents the indexes of all the top-level units, which have their
likelihood raised to the power of their weight
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>w</mi><mi>j</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><annotation encoding="application/x-tex">w^{(L)}_{j}</annotation></semantics></math>.
Because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐮</mi><annotation encoding="application/x-tex">\bm{u}</annotation></semantics></math>
may be a vector—for example, if there is a random slope and
intercept—the covariance matrix between the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐮</mi><annotation encoding="application/x-tex">\bm{u}</annotation></semantics></math>
terms
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>𝚺</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">\bm{\Sigma}^{(L)}</annotation></semantics></math>)
may be diagonal (no covariance) or dense. In any case, the covariance
matrix is parameterized by a vector of values
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>;
at the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>th
level, the relevant elements are denoted by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>𝛉</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">\bm{\theta}^{(L)}</annotation></semantics></math>.</p>
<p>The conditional likelihood at each level from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
to two—those above the first, or lowest level—is then recursively
defined, for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>th
unit, at level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>ℒ</mi><mi>j</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><annotation encoding="application/x-tex">\mathcal{L}^{(l)}_j</annotation></semantics></math>;
Rabe-Hesketh et al., 2002, eq. 3) as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>ℒ</mi><mi>j</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>;</mo><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><msup><mi>𝐔</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>∫</mo><msup><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo>;</mo><msup><mi>𝛉</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><munder><mo>∏</mo><mrow><mi>j</mi><mi>′</mi></mrow></munder><mrow><mo minsize="2.4" maxsize="2.4" stretchy="false" form="prefix">[</mo><msubsup><mi>ℒ</mi><mrow><mi>j</mi><mi>′</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>;</mo><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><msup><mi>𝐔</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><msup><mo minsize="2.4" maxsize="2.4" stretchy="false" form="postfix">]</mo><msubsup><mi>𝐰</mi><mrow><mi>j</mi><mi>′</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup></msup></mrow><mi>d</mi><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mspace width="1.0em"></mspace><mi>l</mi><mo>=</mo><mn>2</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>L</mi><mo>−</mo><mn>1</mn></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\mathcal{L}^{(l)}_j(\bm{\theta}, \bm{\beta}; \bm{y}| \bm{U}^{(l+1)}) = \int g^{(l)}(\bm{u}^{(l)};\bm{\theta}^{(l)})\prod_{j'}{ \bigg[\mathcal{L}^{(l-1)}_{j'}(\bm{\theta}, \bm{\beta} ; \bm{y}| \bm{U}^{(l)})\bigg]^{\bm{w}^{(l-1)}_{j'}}} d\bm{u}^{(l)} \quad l=2, \ldots, L-1
\end{align}</annotation></semantics></math> where the subscript
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">j'</annotation></semantics></math>
that the product is indexed over indicates that the likelihood
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>ℒ</mi><mrow><mi>j</mi><mi>′</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}^{(l-1)}_{j'}(\cdot)</annotation></semantics></math>
is for the units of level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">l-1</annotation></semantics></math>
nested in unit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>𝐔</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">\bm{U}^{(l)}</annotation></semantics></math>
is all of the random effects at or above level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>,
so that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>𝐔</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">\bm{U}^{(l)}</annotation></semantics></math>
includes
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">{</mo><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo>,</mo><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo>,</mo><mi>…</mi><mo>,</mo><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\left\{\bm{u}^{(l)}, \bm{u}^{(l+1)}, \dots, \bm{u}^{(L)}\right\}</annotation></semantics></math>.
This equation reflects the nested nature of the data; a group (e.g.,
school), annotated as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
has an individual likelihood that is the product of the likelihoods of
the units or groups (e.g., students or classrooms, annotated as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">j'</annotation></semantics></math>)
nested inside of it.</p>
<p>In the case of a Gaussian residual, the likelihood
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>ℒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">\mathcal{L}^{(1)}</annotation></semantics></math>)
at the individual unit level is given by the equation
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>ℒ</mi><mi>i</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>;</mo><mi>𝐲</mi><mo>,</mo><msup><mi>𝐔</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><mi>σ</mi></mfrac><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msubsup><mover><mi>e</mi><mo accent="true">̂</mo></mover><mi>i</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mi>σ</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\mathcal{L}_i^{(1)}(\bm{\theta}, \bm{\beta};\bm{y},\bm{U}^{(2)}) &amp;= \frac{1}{\sigma} \phi \left(  \frac{\hat{e}_i^{(1)} }{\sigma}   \right)
\end{align}</annotation></semantics></math> where the subscript
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
is used to indicate that this is the likelihood of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>i</mi><mrow><mi>t</mi><mi>h</mi></mrow></msup><annotation encoding="application/x-tex">i^{th}</annotation></semantics></math>
individual, the superscript
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(1)</annotation></semantics></math>
on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>i</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><annotation encoding="application/x-tex">\hat{\bm{e}}_i^{(1)}</annotation></semantics></math>
is used to indicate that it is an unpenalized residual—where the
penalized residual will be introduced in the next
section—<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\phi(\cdot)</annotation></semantics></math>
is the standard normal density function and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
is the residual variance (a scalar), and the residuals vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">\hat{\bm{e}}^{(1)}</annotation></semantics></math>
represents the residuals
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>i</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><annotation encoding="application/x-tex">\hat{\bm{e}}_i^{(1)}</annotation></semantics></math>
for each individual and is given, in vector form, by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>𝐲</mi><mo>−</mo><mi>𝐗</mi><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>−</mo><munderover><mo>∑</mo><mrow><mi>l</mi><mo>=</mo><mn>2</mn></mrow><mi>L</mi></munderover><msup><mi>𝐙</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><msup><mover><mi>𝐮</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mspace width="0.222em"></mspace></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\hat {\bm{e}}^{(1)} &amp;= \bm{y} - \bm{X}\hat{\bm{\beta}} - \sum_{l=2}^L \bm{Z}^{(l)}\hat{\bm{u}}^{(l)}  \ 
\end{align}</annotation></semantics></math>\end{align} When solved with
the above integrals (as in Rabe-Hesketh et al., 2002),
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
is fit as a parameter and there is no direct equation for it.</p>
<p>This document describes how <code>WeMix</code> uses symbolic
integration that relies on a mix of both Bates and Pinheiro (1998) and
the <code>lme4</code> package (Bates, Maechler, Bolker, and Walker,
2015), obviating the need for numerical integration in a weighted,
nested model.</p>
<p>The basic model in <code>lme4</code> is of the form (Bates et al.,
2015, eqs. 2 and 3):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><mi>𝐔</mi><mo>=</mo><mi>𝐮</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mi>𝐗</mi><mi>𝛃</mi></mrow><mo>+</mo><mrow><mi>𝐙</mi><mi>𝐮</mi></mrow><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><msup><mi>W</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>𝐔</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mi>𝚺</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\left( \bm{y}|\bm{U}=\bm{u}\right) &amp;\sim N(\bm{X\beta} + \bm{Zu}, \sigma^2 W^{-1} ) \label{eq:lme4A}\\
\bm{U} &amp;\sim N(0, \bm{\Sigma}(\bm{\theta})) \label{eq:lme4B}
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo>,</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(\cdot, \cdot)</annotation></semantics></math>
is the multivariate normal distribution, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝚺</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{\Sigma}(\bm{\theta})</annotation></semantics></math>
is positive semidefinite—allowing, for example, a variance parameter to
be exactly zero—that is parameterized by a vector of parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>.</p>
<p>The likelihood is maximized by integrating (symbolically) over
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐔</mi><annotation encoding="application/x-tex">\bm{U}</annotation></semantics></math>
(Bates et al., 2015, eqs. 20, 21, 22, and 24):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>f</mi><mi>𝐲</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>;</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>∫</mo><msub><mi>f</mi><mrow><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><mrow><mi>𝐔</mi><mo mathvariant="bold">=</mo><mi>𝐮</mi></mrow></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>;</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><mi>𝐮</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><msub><mi>f</mi><mi>𝐔</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐮</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>𝐮</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
f_{\bm{y}}(\bm{y};\bm{\beta},\bm{\theta}) &amp;= \int f_{\bm{y}|\bm{U=u}}\left(\bm{y}; \bm{\beta}, \bm{\theta}, \bm{u} \right) \cdot f_{\bm{U}}(\bm{u}) d\bm{u} \label{eq:lme4C}
\end{align}</annotation></semantics></math></p>
<p>where the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>𝐔</mi></msub><annotation encoding="application/x-tex">f_{\bm{U}}</annotation></semantics></math>
term is analogous to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>𝐮</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g(\bm{u}^{(l)})</annotation></semantics></math>
in the Rabe-Hesketh et al. (2006) formulation but is intentionally
represented in a non-nested structure to allow for crossed terms.</p>
<p>In this document we show how <code>WeMix</code> uses a derivation
similar to that in Bates et al. (2015) and Bates and Pinheiro (1998) to
fit a sample-weighted mixed model, avoiding the integration necessary in
GLLAMM. Comparing <code>WeMix</code> to <code>lmer</code>, the latter is
more general in the sense of allowing crossed terms, while
<code>WeMix</code> allows for sampling weights; unweighted, the models
should agree.</p>
<p>Generally, the Rabe-Hesketh et al. (2006) model can be rewritten in a
form very similar to <code>lme4</code> as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><mi>𝐔</mi><mo>=</mo><mi>𝐮</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><msubsup><mi>T</mi><mn>1</mn><msup><mi>ω</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup></msubsup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>𝐔</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><msubsup><mi>T</mi><mn>2</mn><msup><mi>ω</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup></msubsup><mo>*</mo><msubsup><mi>T</mi><mn>3</mn><msup><mi>ω</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>3</mn><mo stretchy="true" form="postfix">)</mo></mrow></msup></msubsup><mo>*</mo><mi>⋯</mi><mo>*</mo><msubsup><mi>T</mi><mi>L</mi><msup><mi>ω</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\left( \bm{y}|\bm{U}=\bm{u}\right) &amp;\sim  T_1^{\omega^{(1)}} \label{eq:WeMixA}\\
\bm{U} &amp;\sim T_2^{\omega^{(2)}} * T_3^{\omega^{(3)}} * \cdots * T_L^{\omega^{(L)}} \label{eq:WeMixB} 
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>T</mi><mi>k</mi></msup><annotation encoding="application/x-tex">T^k</annotation></semantics></math>
represents the convolution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
instances of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>*</mo><annotation encoding="application/x-tex">*</annotation></semantics></math>
represents the convolution of two distributions, with a likelihood that
is their product;
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>w</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">w^{(l)}</annotation></semantics></math>
are the weights assigned to units
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">l=1</annotation></semantics></math>)
or groups
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">l&gt;1</annotation></semantics></math>)
that are ideally the inverse (unconditional) probability of selecting
the unit or group; and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>s
have distribution
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>T</mi><mn>1</mn></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mi>𝐗</mi><mi>𝛃</mi></mrow><mo>+</mo><mrow><mi>𝐙</mi><mi>𝐮</mi></mrow><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mi>I</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>T</mi><mi>l</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msub><mi>𝚺</mi><mrow><mi>𝐥</mi><mi>𝐥</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="1.0em"></mspace><mi>l</mi><mo>=</mo><mn>2</mn><mo>,</mo><mi>⋯</mi><mo>,</mo><mi>L</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
T_1 &amp;\sim N(\bm{X\beta} + \bm{Zu}, \sigma^2 I ) \label{eq:WeMixA2} \\
T_l &amp;\sim N(0, \bm{\Sigma_{ll}}) \quad l=2, \cdots, L \label{eq:WeMixB2}
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚺</mi><annotation encoding="application/x-tex">\bm{\Sigma}</annotation></semantics></math>
is block diagonal, disallowing nonzero prior correlations across levels,
with the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>th
block being written
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝚺</mi><mrow><mi>l</mi><mi>l</mi></mrow></msub><annotation encoding="application/x-tex">\bm{\Sigma}_{ll}</annotation></semantics></math>.</p>
<p>The next section follows Bates et al. (2015) and shows the
<code>lme4</code> and <code>WeMix</code> model without weights—the only
case where they are identical. The subsequent section then shows the
adaptations to the likelihood for the sample weighted case. Notably,
<code>lme4</code> has unit-level weights, but they are precision weights
and not level-1 sample weights, so even when only the level-1 weights
are nontrivial, the models disagree. The final section describes the
application of the profile likelihood (again, following
<code>lme4</code>) used to estimate linear models in
<code>WeMix</code>.</p>
<p>Following the logic of Bates et al. (2015), the unweighted (unit
weight) case simplifies eqs. and to
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><mi>𝐔</mi><mo>=</mo><mi>𝐮</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><msub><mi>T</mi><mn>1</mn></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>𝐔</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><msub><mi>T</mi><mn>2</mn></msub><mo>*</mo><msub><mi>T</mi><mn>3</mn></msub><mo>*</mo><mi>⋯</mi><mo>*</mo><msub><mi>T</mi><mi>L</mi></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\left( \bm{y}|\bm{U}=\bm{u}\right) &amp;\sim  T_1 \label{eq:WeMixAnoW}\\
\bm{U} &amp;\sim T_2 * T_3 * \cdots * T_L \label{eq:WeMixBnoW} 
\end{align}</annotation></semantics></math> where eqs. and are
simplified to
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>T</mi><mn>1</mn></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mi>𝐗</mi><mi>𝛃</mi></mrow><mo>+</mo><mrow><mi>𝐙</mi><mi>𝐮</mi></mrow><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mi>I</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>T</mi><mi>l</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msub><mi>𝚺</mi><mrow><mi>𝐥</mi><mi>𝐥</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="1.0em"></mspace><mi>l</mi><mo>=</mo><mn>2</mn><mo>,</mo><mi>⋯</mi><mo>,</mo><mi>L</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
T_1 &amp;\sim N(\bm{X\beta} + \bm{Zu}, \sigma^2 I ) \label{eq:WeMixA2noW} \\
T_l &amp;\sim N(0, \bm{\Sigma_{ll}}) \quad l=2, \cdots, L \label{eq:WeMixB2noW}
\end{align}</annotation></semantics></math> the random-effect vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐔</mi><annotation encoding="application/x-tex">\bm{U}</annotation></semantics></math>
is rewritten as the product of a square root-covariance matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚲</mi><annotation encoding="application/x-tex">\bm{\Lambda}</annotation></semantics></math>
and an
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>i</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">iid</annotation></semantics></math>
normal vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝐔</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>𝚲</mi><mi>𝛖</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>𝛖</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mi>𝐈</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\bm{U}&amp;=\bm{\Lambda} \bm{\upsilon} \label{eq:Uf} \\
\bm{\upsilon} &amp;\sim N(0, \sigma^2 \bm{I})
\end{align}</annotation></semantics></math> When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚲</mi><annotation encoding="application/x-tex">\bm{\Lambda}</annotation></semantics></math>
is a <em>square root matrix</em> of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚺</mi><annotation encoding="application/x-tex">\bm{\Sigma}</annotation></semantics></math>,
meaning
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mn>1</mn><msup><mi>σ</mi><mn>2</mn></msup></mfrac><mi>𝚺</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mi>σ</mi><mn>2</mn></msup></mfrac><msup><mi>𝚲</mi><mi>T</mi></msup><mi>𝚲</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\frac{1}{\sigma^2}\bm{\Sigma}&amp;= \frac{1}{\sigma^2} \bm{\Lambda}^T \bm{\Lambda} \label{eq:root}
\end{align}</annotation></semantics></math> it follows that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐔</mi><annotation encoding="application/x-tex">\bm{U}</annotation></semantics></math>
has the distribution shown in eq. , but the equations can use the much
easier to work with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>.
Note that eq. implies
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝚺</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚺</mi><mn>11</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝚺</mi><mn>22</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝚺</mi><mrow><mi>L</mi><mi>L</mi></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚲</mi><mn>11</mn><mi>T</mi></msubsup></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚲</mi><mn>22</mn><mi>T</mi></msubsup></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚲</mi><mrow><mi>L</mi><mi>L</mi></mrow><mi>T</mi></msubsup></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚲</mi><mn>11</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝚲</mi><mn>22</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mo>⋱</mo></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝚲</mi><mrow><mi>L</mi><mi>L</mi></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mi>𝚲</mi><mi>T</mi></msup><mi>𝚲</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\bm{\Sigma} &amp;= \left[ \begin{matrix} \bm{\Sigma}_{11} &amp;0&amp;\cdots&amp;0 \\ 0 &amp;\bm{\Sigma}_{22}&amp;0&amp;\vdots \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ 0 &amp; \cdots &amp;0 &amp; \bm{\Sigma}_{LL}\\ \end{matrix}\right] \\
&amp;=\left[ \begin{matrix} \bm{\Lambda}_{11}^T &amp;0&amp;\cdots&amp;0 \\ 0 &amp;\bm{\Lambda}_{22}^T&amp;0&amp;\vdots \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ 0 &amp; \cdots &amp;0 &amp; \bm{\Lambda}_{LL}^T\\ \end{matrix}\right] 
\left[ \begin{matrix} \bm{\Lambda}_{11} &amp;0&amp;\cdots&amp;0 \\ 0 &amp;\bm{\Lambda}_{22}&amp;0&amp;\vdots \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ 0 &amp; \cdots &amp;0 &amp; \bm{\Lambda}_{LL}\\ \end{matrix}\right] \\
&amp;=  \bm{\Lambda}^T \bm{\Lambda}
\end{align}</annotation></semantics></math> Note that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚲</mi><annotation encoding="application/x-tex">\bm{\Lambda}</annotation></semantics></math>
(and thus
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚺</mi><annotation encoding="application/x-tex">\bm{\Sigma}</annotation></semantics></math>)
will be parameterized by a set of parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>,
so eq. could be written
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mn>1</mn><msup><mi>σ</mi><mn>2</mn></msup></mfrac><mi>𝚺</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mi>σ</mi><mn>2</mn></msup></mfrac><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>T</mi></msup><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\frac{1}{\sigma^2}\bm{\Sigma}(\bm{\theta})&amp;= \frac{1}{\sigma^2}\left(\bm{\Lambda}(\bm{\theta})\right)^T \bm{\Lambda}(\bm{\theta})
\end{align}</annotation></semantics></math> and will be written this way
to keep track of the parameters involved. These parameters vary by
model. For a two-level model with a random intercept and nothing else,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
would be a scalar with the relative precision of the random effect. The
matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{\Lambda}({\bm{\theta}})</annotation></semantics></math>
would then be diagonal and of the form
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>θ</mi><mi>𝐈</mi></mrow><annotation encoding="application/x-tex">\bm{\Lambda}({\bm{\theta}})=\theta \bm{I}</annotation></semantics></math>,
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐈</mi><annotation encoding="application/x-tex">\bm{I}</annotation></semantics></math>
being an identity matrix with the same number of rows and columns as
there are groups (random effects). For a two-level model with a random
slope and intercept, the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
would have length three and would parameterize the three elements of a
covariance matrix. In this special case, the parameterization could be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>θ</mi><mn>1</mn></msub><mi>𝐈</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>θ</mi><mn>2</mn></msub><mi>𝐈</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>θ</mi><mn>3</mn></msub><mi>𝐈</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{\Lambda}({\bm{\theta}})= \left[\begin{matrix} \theta_1 \bm{I} &amp; \theta_2 \bm{I} \\ 0 &amp; \theta_3 \bm{I} \end{matrix}\right]</annotation></semantics></math>;
a block matrix that allows the slope and intercept term to covary with
each other, within a group.</p>
<p>Then, the residual (penalized) sum of squares is (Bates et al., 2015,
eqs. 14 and 15)
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo stretchy="false" form="prefix">|</mo><mo stretchy="false" form="prefix">|</mo><mi>𝐲</mi><mo>−</mo><mrow><mi>𝐗</mi><mi>𝛃</mi></mrow><mo>−</mo><mrow><mi>𝐙</mi><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix" mathvariant="bold">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix" mathvariant="bold">)</mo></mrow><mi>𝛖</mi></mrow><mo stretchy="false" form="postfix">|</mo><msup><mo stretchy="false" form="postfix">|</mo><mn>2</mn></msup><mo>+</mo><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>𝛖</mi><msup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \lvert\lvert \bm{y}-\bm{X\beta} - \bm{Z\Lambda(\theta)\upsilon}\rvert\rvert^2 + ||\bm{\upsilon}||^2
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>𝐯</mi><msup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">||\bm{v}||^2</annotation></semantics></math>
is the sum of squares for the vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐯</mi><annotation encoding="application/x-tex">\bm{v}</annotation></semantics></math>;
as an equation,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>𝐯</mi><msup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>=</mo><mo>∑</mo><msubsup><mi>v</mi><mi>i</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">||\bm{v}||^2=\sum v_i^2</annotation></semantics></math>.</p>
<p>Notice that the penalty function
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>𝛖</mi><msup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">||\bm{\upsilon}||^2</annotation></semantics></math>)
and the residual both are assumed to be independent identically
distributed normal distributions with variance
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>;
this allows for both the regression and the random effects to be
estimated in one regression where the pseudo-data outcome for the random
effects is a vector of zeros (Bates et al., 2015, eq. 16). This rewrites
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
as a sum of squares, adding a vector of zeros below
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>—the
<em>pseudo-data</em>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mrow><mi>𝐙</mi><mi>𝚲</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="center" style="text-align: center"><mi>𝐗</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐈</mi></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \left| \left| \left[ \begin{matrix} \bm{y} \\ \bm{0} \end{matrix} \right] -\left[ \begin{matrix} \bm{Z\Lambda}(\bm{\theta}) &amp; \bm{X} \\ \bm{I} &amp; \bm{0} \end{matrix} \right] \left[ \begin{matrix} \bm{\upsilon} \\ \bm{\beta} \end{matrix} \right] \right|\right|^2 \label{eq:WeMixR0}
\end{align}</annotation></semantics></math> Unlike Bates et al. (2015,
eq. 16), we proceed by taking a QR decomposition (Trefethen and Bau,
1997) of
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝐀</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>≡</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mrow><mi>𝐙</mi><mi>𝚲</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="center" style="text-align: center"><mi>𝐗</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐈</mi></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\bm{A} &amp;\equiv \left[ \begin{matrix} \bm{Z\Lambda}(\bm{\theta}) &amp; \bm{X} \\ \bm{I} &amp; \bm{0} \end{matrix} \right] \label{eq:uwA}
\end{align}</annotation></semantics></math> Plugging eq. into eq. and
finding the least squares solution (denoted with a hat:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝐮</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\bm{\hat{u}}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\bm{\hat{\beta}}</annotation></semantics></math>)
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\bm{A} \left[ \begin{matrix} \hat{\bm{\upsilon}} \\ \hat{\bm{\beta}} \end{matrix} \right]&amp;=\left[ \begin{matrix} \bm{y} \\ \bm{0} \end{matrix} \right]
\end{align}</annotation></semantics></math> using the QR decomposition
on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\bm{A}</annotation></semantics></math>,
which rewrites
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐀</mi><mo>=</mo><mrow><mi>𝐐</mi><mi>𝐑</mi></mrow></mrow><annotation encoding="application/x-tex">\bm{A}=\bm{QR}</annotation></semantics></math>
for an orthogonal matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐐</mi><annotation encoding="application/x-tex">\bm{Q}</annotation></semantics></math>
(So,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝐐</mi><mi>T</mi></msup><mi>𝐐</mi><mo>=</mo><mi>𝐈</mi></mrow><annotation encoding="application/x-tex">\bm{Q}^T\bm{Q}=\bm{I}</annotation></semantics></math>)
and an upper triangular matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐑</mi><annotation encoding="application/x-tex">\bm{R}</annotation></semantics></math>,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mi>𝐐</mi><mi>𝐑</mi></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\bm{QR} \left[ \begin{matrix} \hat{\bm{\upsilon}} \\ \hat{\bm{\beta}} \end{matrix} \right]&amp;=\left[ \begin{matrix} \bm{y} \\ \bm{0} \end{matrix} \right]
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐑</mi><annotation encoding="application/x-tex">\bm{R}</annotation></semantics></math>
can be written in block form as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝐑</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mn>11</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mn>12</mn></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mn>22</mn></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\bm{R} &amp;= \left[ \begin{matrix} \bm{R}_{11} &amp; \bm{R}_{12} \\  \bm{0} &amp; \bm{R}_{22} \end{matrix} \right] \label{eq:Rblock}
\end{align}</annotation></semantics></math> in which
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mn>11</mn></msub><annotation encoding="application/x-tex">\bm{R}_{11}</annotation></semantics></math>
is also upper triangular, square, and conformable with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mn>22</mn></msub><annotation encoding="application/x-tex">\bm{R}_{22}</annotation></semantics></math>
is similarly upper triangular, square, and conformable with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>,
while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mn>12</mn></msub><annotation encoding="application/x-tex">\bm{R}_{12}</annotation></semantics></math>
is rectangular and (potentially) dense.</p>
<p>Rewriting
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>r</mi><mn>2</mn></msup><annotation encoding="application/x-tex">r^2</annotation></semantics></math>
as a deviation from the least squares solution, eq. becomes
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo>+</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>+</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \left| \left| \left[ \begin{matrix} \bm{y} \\ \bm{0} \end{matrix} \right] - \bm{A} \left[ \begin{matrix} \bm{\upsilon} \\ \bm{\beta} \end{matrix} \right] \right|\right|^2 \\
&amp;= \left| \left|  \left[ \begin{matrix} \bm{y} \\ \bm{0} \end{matrix} \right] - \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} + \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} + \hat{\bm{\beta}} \end{matrix} \right] \right|\right|^2 \\
&amp;= \left| \left|  \left[ \begin{matrix} \bm{y} \\ \bm{0} \end{matrix} \right] - \bm{A} \left[ \begin{matrix}\hat{\bm{\upsilon}} \\ \hat{\bm{\beta}} \end{matrix} \right] - \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right|\right|^2
\end{align}</annotation></semantics></math> Using the identity that for
any vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐯</mi><annotation encoding="application/x-tex">\bm{v}</annotation></semantics></math>
the sum of squares is also just the inner product, so
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>𝐯</mi><msup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>=</mo><msup><mi>𝐯</mi><mi>T</mi></msup><mi>𝐯</mi></mrow><annotation encoding="application/x-tex">||\bm{v}||^2 = \bm{v}^T\bm{v}</annotation></semantics></math>,<br><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mi>T</mi></msup><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon})&amp;= \left[  \left[ \begin{matrix} \bm{y} \\ \bm{0} \end{matrix} \right] - \bm{A} \left[ \begin{matrix}\hat{\bm{\upsilon}} \\ \hat{\bm{\beta}} \end{matrix} \right] - \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right]^T    \left[ \left[ \begin{matrix} \bm{y} \\ \bm{0} \end{matrix} \right] - \bm{A} \left[ \begin{matrix}\hat{\bm{\upsilon}} \\ \hat{\bm{\beta}} \end{matrix} \right] - \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right] \label{eq:finalT}
\end{align}</annotation></semantics></math> Defining
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\bm{e}}</annotation></semantics></math>
to be the penalized least squares residual,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mo>≡</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\hat{\bm{e}} \equiv \left[ \begin{matrix} \bm{y} \\ \bm{0} \end{matrix} \right] - \bm{A} \left[ \begin{matrix}\hat{\bm{\upsilon}} \\ \hat{\bm{\beta}} \end{matrix} \right]
\end{align}</annotation></semantics></math> then eq. can be rewritten
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">[</mo><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mi>T</mi></msup><mrow><mo stretchy="true" form="prefix">[</mo><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mo>−</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mo>−</mo><mn>2</mn><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mrow><mo stretchy="true" form="prefix">[</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">[</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mi>T</mi></msup><mrow><mo stretchy="true" form="prefix">[</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \left[  \hat{\bm{e}} - \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right]^T    \left[ \hat{\bm{e}} - \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right] \\
&amp;= \hat{\bm{e}}^T \hat{\bm{e}} - 2 \hat{\bm{e}}^T    \left[ \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right] + \left[  \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right]^T    \left[ \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right] \label{eq:quad}
\end{align}</annotation></semantics></math> Since
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\bm{e}}</annotation></semantics></math>,
the uniquely minimized residuals to the least squares problem is in the
null of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\bm{A}</annotation></semantics></math>,
while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐀</mi><mi>𝐱</mi></mrow><annotation encoding="application/x-tex">\bm{Ax}</annotation></semantics></math>
is in the span of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\bm{A}</annotation></semantics></math>
for any vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐱</mi><annotation encoding="application/x-tex">\bm{x}</annotation></semantics></math>,
then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mrow><mi>𝐀</mi><mi>𝐱</mi></mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\hat{\bm{e}}^T \bm{Ax}=0</annotation></semantics></math>
for any
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐱</mi><annotation encoding="application/x-tex">\bm{x}</annotation></semantics></math>.
Thus,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mrow><mo stretchy="true" form="prefix">[</mo><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><mn>𝟎</mn></mrow><annotation encoding="application/x-tex">\hat{\bm{e}}^T \left[ \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right]=\bm{0}</annotation></semantics></math>
and eq. becomes
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mi>T</mi></msup><msup><mi>𝐀</mi><mi>T</mi></msup><mi>𝐀</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mi>T</mi></msup><msup><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mi>𝐐</mi><mi>𝐑</mi></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mi>T</mi></msup><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mi>𝐐</mi><mi>𝐑</mi></mrow><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mi>T</mi></msup><msup><mi>𝐑</mi><mi>T</mi></msup><msup><mi>𝐐</mi><mi>T</mi></msup><mi>𝐐</mi><mi>𝐑</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \hat{\bm{e}}^T \hat{\bm{e}} + \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right]^T \bm{A}^T \bm{A} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \\
 &amp;= \hat{\bm{e}}^T \hat{\bm{e}}   + \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right]^T \left[ \bm{QR} \right]^T \left[\bm{QR}\right]    \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \\
 &amp;= \hat{\bm{e}}^T \hat{\bm{e}}  + \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right]^T \bm{R}^T \bm{Q}^T \bm{Q} \bm{R} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] 
 \end{align}</annotation></semantics></math> Then, because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐐</mi><annotation encoding="application/x-tex">\bm{Q}</annotation></semantics></math>
is orthonormal,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝐐</mi><mi>T</mi></msup><mo>=</mo><msup><mi>𝐐</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\bm{Q}^T=\bm{Q}^{-1}</annotation></semantics></math>
and
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mi>T</mi></msup><msup><mi>𝐑</mi><mi>T</mi></msup><mi>𝐑</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mi>𝐑</mi><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon})  &amp;= \hat{\bm{e}}^T \hat{\bm{e}}  + \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right]^T \bm{R}^T \bm{R} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \\
 &amp;= \hat{\bm{e}}^T \hat{\bm{e}} + \left|\left| \bm{R} \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right| \right|^2  \label{eq:r2F}
\end{align}</annotation></semantics></math> Notice that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover></mrow><annotation encoding="application/x-tex">\hat{\bm{e}}^T \hat{\bm{e}}</annotation></semantics></math>
is the value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>r</mi><mn>2</mn></msup><annotation encoding="application/x-tex">r^2</annotation></semantics></math>
evaluated at the least squares solution (denoted by adding hats to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>),
so that
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover><mi>T</mi></msup><mover><mi>𝐞</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}}) &amp;= \hat{\bm{e}}^T \hat{\bm{e}} \label{eq:r2tau}
\end{align}</annotation></semantics></math> Plugging eqs. and into eq.
(Bates et al., 2015, eq. 19),
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mn>11</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mn>12</mn></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mn>22</mn></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>11</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>𝐑</mi><mn>12</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>22</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon})  &amp;= r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}}) + \left|\left| \left[ \begin{matrix} \bm{R}_{11} &amp; \bm{R}_{12} \\ \bm{0} &amp; \bm{R}_{22}  \end{matrix}\right] \left[ \begin{matrix} \bm{\upsilon} - \hat{\bm{\upsilon}} \\ \bm{\beta} - \hat{\bm{\beta}} \end{matrix} \right] \right| \right|^2 \\
&amp;= r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}}) + \left|\left|  \bm{R}_{11} (\bm{\upsilon} - \hat{\bm{\upsilon}}) + \bm{R}_{12}  (\bm{\beta} - \hat{\bm{\beta}})  \right| \right|^2  + \left|\left|  \bm{R}_{22}  (\bm{\beta} - \hat{\bm{\beta}})  \right| \right|^2 \label{eq:r2sub}
\end{align}</annotation></semantics></math></p>
<p>From the joint distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>
(Bates et al., 2015, eqs. 20, 21, and 22),
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>−</mo><mrow><mi>𝐗</mi><mi>𝛃</mi></mrow><mo>−</mo><mrow><mi>𝐙</mi><mi>𝛖</mi></mrow><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><msub><mi>𝐈</mi><msub><mi>n</mi><mi>x</mi></msub></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><msub><mi>𝐈</mi><msub><mi>n</mi><mi>z</mi></msub></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
(\bm{y},\bm{\upsilon}) &amp;\sim N(\bm{y} - \bm{X\beta} - \bm{Z\upsilon},\sigma^2 \bm{I}_{n_x}) * N(\bm{\upsilon},  \sigma^2 \bm{I}_{n_z})
\end{align}</annotation></semantics></math> and the probability density
function of the joint distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>
is
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>f</mi><mrow><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><msub><mi>n</mi><mi>x</mi></msub><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mfrac><mrow><mo>−</mo><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>υ</mi><msup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mo>⋅</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><msub><mi>n</mi><mi>z</mi></msub><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mfrac><mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>𝛖</mi><msup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><msub><mi>n</mi><mi>x</mi></msub><mo>+</mo><msub><mi>n</mi><mi>z</mi></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mfrac><mrow><mo>−</mo><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
f_{\bm{y}, \bm{\upsilon}} \left(\bm{y}, \bm{\upsilon}, \bm{\beta}, \bm{\theta}, \sigma^2 \right)&amp;= \frac{1}{\left(2\pi\sigma^2\right)^{\frac{n_x}{2}}} \exp{\left[\frac{-r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) + ||\upsilon||^2}{2\sigma^2} \right]}  \cdot \frac{1}{\left(2\pi\sigma^2\right)^{\frac{n_z}{2}}} \exp{\left[ \frac{-||\bm{\upsilon}||^2}{2\sigma^2}\right] }  \\
&amp;= \frac{1}{\left(2\pi\sigma^2\right)^{\frac{n_x+n_z}{2}}} \exp{\left[\frac{-r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) }{2\sigma^2}\right] } 
\end{align}</annotation></semantics></math> This can then be integrated
over
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>
to get the likelihood of the model (Bates et al., 2015, eqs. 25 and 26):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>ℒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo>;</mo><mi>𝐲</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>∫</mo><msub><mi>f</mi><mrow><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>𝛖</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>∫</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><msub><mi>n</mi><mi>x</mi></msub><mo>+</mo><msub><mi>n</mi><mi>z</mi></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mfrac><mrow><mo>−</mo><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mi>d</mi><mi>𝛖</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><msub><mi>n</mi><mi>x</mi></msub><mo>+</mo><msub><mi>n</mi><mi>z</mi></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mfrac><mrow><mo>−</mo><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>22</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo>∫</mo><mo>exp</mo><mfrac><mrow><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>11</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>𝐑</mi><mn>12</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mi>d</mi><mi>𝛖</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\mathcal{L}\left( \bm{\beta}, \bm{\theta}, \sigma^2; \bm{y} \right)&amp;=\int f_{\bm{y}, \bm{\upsilon}} \left(\bm{y}, \bm{\upsilon}, \bm{\beta}, \bm{\theta}\right) d\bm{\upsilon}\\
&amp;=\int \frac{1}{\left(2\pi\sigma^2\right)^{\frac{n_x+n_z}{2}}} \exp{\frac{-r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) }{2\sigma^2} }  d\bm{\upsilon}\\
&amp;=\frac{1}{\left(2\pi\sigma^2\right)^{\frac{n_x+n_z}{2}}} \exp{\frac{-r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}}) - \left|\left|  \bm{R}_{22}  (\bm{\beta} - \hat{\bm{\beta}})  \right| \right|^2 }{2\sigma^2} } \int \exp{\frac{- \left|\left|  \bm{R}_{11} (\bm{\upsilon} - \hat{\bm{\upsilon}}) + \bm{R}_{12}  (\bm{\beta} - \hat{\bm{\beta}})  \right| \right|^2 }{2\sigma^2} }  d\bm{\upsilon} \label{eq:lnlInt}
\end{align}</annotation></semantics></math> This can be solved with a
change of variables (Bates et al., 2015, eq. 27):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝛄</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>𝐑</mi><mn>11</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>𝐑</mi><mn>12</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mrow><mi>d</mi><mi>𝛄</mi></mrow><mrow><mi>d</mi><mi>𝛖</mi></mrow></mfrac></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>𝐑</mi><mn>11</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\bm{\gamma} &amp;=  \bm{R}_{11} (\bm{\upsilon} - \hat{\bm{\upsilon}}) + \bm{R}_{12}  (\bm{\beta} - \hat{\bm{\beta}}) \label{eq:gamma} \\
\frac{d  \bm{\gamma}}{d \bm{\upsilon}}&amp;= \bm{R}_{11} \label{eq:Jgamma}
\end{align}</annotation></semantics></math> Using the change of
variables formula, we add the inverse determinant of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mn>11</mn></msub><annotation encoding="application/x-tex">\bm{R}_{11}</annotation></semantics></math>
when plugging eq. into , and using eq. (Bates et al., 2015, eq. 28):
<span class="math display">$$\begin{align}
\mathcal{L}\left( \bm{\beta}, \bm{\theta}, \sigma^2; \bm{y}
\right)&amp;=\frac{1}{\left(2\pi\sigma^2\right)^{\frac{n_x+n_z}{2}}}
\exp{\frac{-r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}}) -
\left|\left|  \bm{R}_{22}  (\bm{\beta} - \hat{\bm{\beta}})  \right|
\right|^2 }{2\sigma^2} } \int \exp{\frac{- \left|\left|  \gamma  \right|
\right|^2 }{2\sigma^2} } | {\rm det} (\bm{R}_{11}) |^{-1} d\bm{\gamma}
\\
&amp;=\frac{1}{|{\rm det}(\bm{R}_{11})| \left(2\pi\sigma^2\right)^{
\frac{n_x}{2}}} \exp{\frac{-r^2(\bm{\theta}, \bm{\hat{\beta}},
\bm{\hat{\upsilon}}) - \left|\left|  \bm{R}_{22}  (\bm{\beta} -
\hat{\bm{\beta}})  \right| \right|^2 }{2\sigma^2} }  \left\{
\frac{1}{\left(2\pi\sigma^2\right)^{ \frac{n_z}{2}} } \int \exp{\frac{-
\left|\left|  \gamma  \right| \right|^2 }{2\sigma^2} }  d\bm{\gamma}
\right\}
\end{align}$$</span> and because the term in curly braces is now of a
probability density function, it integrates to 1: <span class="math display">$$\begin{align}
\mathcal{L} \left( \bm{\beta}, \bm{\theta}, \sigma^2; \bm{y}
\right)&amp;=\frac{1}{|{\rm det}(\bm{R}_{11})|
\left(2\pi\sigma^2\right)^{\frac{n_x}{2}}} \exp{\frac{-r^2(\bm{\theta},
\bm{\hat{\beta}}, \bm{\hat{\upsilon}}) -
\left|\left|  \bm{R}_{22}  (\bm{\beta} - \hat{\bm{\beta}})  \right|
\right|^2 }{2\sigma^2} }  \label{eq:WeMixL0}
\end{align}$$</span> Having solved the integral symbolically, this
expression for the likelihood no longer has an explicit integral and has
been calculated exactly, without use of numerical quadrature. This
derivation is incredibly close to Bates et al. (2015), with the only
modification being that we use the QR decomposition of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\bm{A}</annotation></semantics></math>
where they used the Cholesky decomposition of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝐀</mi><mi>T</mi></msup><mi>𝐀</mi></mrow><annotation encoding="application/x-tex">\bm{A}^T \bm{A}</annotation></semantics></math>.</p>
<p>This makes a deviance function, defined relative to the
log-likelihood
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>ℓ</mo><annotation encoding="application/x-tex">\ell</annotation></semantics></math>),
so that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>−</mo><mn>2</mn><mo>ℓ</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">D(\cdot) = -2\ell(\cdot)</annotation></semantics></math>,
<span class="math display">$$\begin{align}
D \left( \bm{\beta}, \bm{\theta}, \sigma^2; \bm{y} \right)&amp;= 2\,{\rm
ln} {|{\rm det}(\bm{R}_{11})|} + n_x {\rm ln} \left(2\pi\sigma^2\right)
+ \frac{r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}}) +
\left|\left|  \bm{R}_{22}  (\bm{\beta} - \hat{\bm{\beta}})  \right|
\right|^2 }{\sigma^2}  \label{eq:WeMixD0}
\end{align}$$</span></p>
<p>Using the profile likelihood, the deviance is minimized when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝛃</mi><mo>=</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mrow><annotation encoding="application/x-tex">\bm{\beta}=\hat{\bm{\beta}}</annotation></semantics></math>
because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
only appears inside of a sum of squares that can be minimized (set to
zero) using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝛃</mi><mo>=</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover></mrow><annotation encoding="application/x-tex">\bm{\beta}=\hat{\bm{\beta}}</annotation></semantics></math>
(Bates et al., 2015, eqs. 30 and 31). The profile deviance then becomes
<span class="math display">$$\begin{align}
D \left( \bm{\theta}, \sigma^2; \bm{y} \right)&amp;= 2\,{\rm ln} {|{\rm
det}(\bm{R}_{11})|} + n_x {\rm ln} \left(2\pi\sigma^2\right) +
\frac{r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}})
}{\sigma^2}  
\end{align}$$</span> Similarly, the value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>
can be found by taking the derivative of the profile deviance with
respect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>
and setting it equal to zero. This yields
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mover><msup><mi>σ</mi><mn>2</mn></msup><mo accent="true">̂</mo></mover></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mrow><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><msub><mi>n</mi><mi>x</mi></msub></mfrac></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\widehat{\sigma^2}&amp;= \frac{r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}})}{n_x}  
\end{align}</annotation></semantics></math> giving a profile deviance
that is a function only of the parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>:
<span class="math display">$$\begin{align}
D \left( \bm{\theta}; \bm{y} \right)&amp;= 2\,{\rm ln} {|{\rm
det}(\bm{R}_{11})|} + n_x \left({\rm ln} \left(2\pi
\widehat{\sigma^2}\right) + 1 \right)
\end{align}$$</span></p>
<p>The purpose of <code>WeMix</code> is to estimate the likelihood of
the weighted model (eqs. and ). In this section we derive the weighted
estimator that is analogous to the estimator used by <code>lme4</code>
and is similar to Henderson (1982) but we include a deviance (and
likelihood), which Henderson omits.</p>
<p>The first difference is in the penalized sum of squares, which now
weights the residuals by the unit-level weights
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛀</mi><annotation encoding="application/x-tex">\bm{\Omega}</annotation></semantics></math>)
and the random-effect penalties by the group-level weights
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚿</mi><annotation encoding="application/x-tex">\bm{\Psi}</annotation></semantics></math>):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mi>𝛀</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>−</mo><mrow><mi>𝐗</mi><mi>𝛃</mi></mrow><mo>−</mo><munderover><mo>∑</mo><mrow><mi>l</mi><mo>=</mo><mn>1</mn></mrow><mi>L</mi></munderover><msub><mi>𝐙</mi><mi>l</mi></msub><msub><mi>Λ</mi><mrow><mi>l</mi><mi>l</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>υ</mi><mi>l</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>+</mo><munderover><mo>∑</mo><mrow><mi>l</mi><mo>=</mo><mn>2</mn></mrow><mi>L</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>𝚿</mi><mrow><mi>l</mi><mi>l</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><msub><mi>𝛖</mi><mi>l</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \left| \left| \bm{\Omega}^{\frac{1}{2}}\left( \bm{y}-\bm{X\beta} - \sum_{l=1}^L \bm{Z}_l\Lambda_{ll}(\theta)\upsilon_l \right)\right|\right|^2 + \sum_{l=2}^{L} \left|\left| \left(\bm{\Psi}_{ll}\right)^{\frac{1}{2}} \bm{\upsilon}_l\right|\right|^2 \label{eq:r2sep}
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛀</mi><annotation encoding="application/x-tex">\bm{\Omega}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝚿</mi><mrow><mi>l</mi><mi>l</mi></mrow></msub><annotation encoding="application/x-tex">\bm{\Psi}_{ll}</annotation></semantics></math>
are diagonal matrices with unconditional inverse probability of
selection for each unit
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛀</mi><annotation encoding="application/x-tex">\bm{\Omega}</annotation></semantics></math>)
or group
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝚿</mi><mrow><mi>l</mi><mi>l</mi></mrow></msub><annotation encoding="application/x-tex">\bm{\Psi}_{ll}</annotation></semantics></math>)
along its diagonal. The unconditional probability that a unit or group
was selected can be readily calculated as the product of a probability
of its own probability of selection and the unconditional probability of
the group to which it belongs.</p>
<p>Then, the weighted pseudo-data notation combines the two terms in eq.
, adding a vector of <em>pseudo-data</em> to the end of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>
vector:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msup><mi>𝛀</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mi>𝐲</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msup><mi>𝛀</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mrow><mi>𝐙</mi><mi>𝚲</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="center" style="text-align: center"><msup><mi>𝛀</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mi>𝐗</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msup><mi>𝚿</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛖</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mi>𝛀</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>−</mo><mrow><mi>𝐙</mi><mi>𝚲</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>𝛖</mi><mo>−</mo><mi>𝐗</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mi>𝚿</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mi>𝛖</mi><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \left| \left| \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}} \bm{y} \\ \bm{0} \end{matrix} \right] - \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}} \bm{Z\Lambda}(\bm{\theta}) &amp; \bm{\Omega}^{\frac{1}{2}}\bm{X} \\ \bm{\Psi}^{\frac{1}{2}} &amp; \bm{0} \end{matrix} \right] \left[ \begin{matrix} \bm{\upsilon} \\ \bm{\beta} \end{matrix} \right] \right|\right|^2 \label{eq:WeMixWr2} \\
&amp;= \left|\left| \bm{\Omega}^{\frac{1}{2}} \left( \bm{y} - \bm{Z\Lambda}(\bm{\theta}) \bm{\upsilon} - \bm{X} \right) \right| \right|^2 + \left| \left| \bm{\Psi}^{\frac{1}{2}} \bm{\upsilon} \right| \right|^2
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐙</mi><annotation encoding="application/x-tex">\bm{Z}</annotation></semantics></math>
is now a block matrix that incorporates all of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐙</mi><annotation encoding="application/x-tex">\bm{Z}</annotation></semantics></math>
matrices for the various levels:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝐙</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐙</mi><mn>1</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐙</mi><mn>2</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mi>⋯</mi></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐙</mi><mi>L</mi></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\bm{Z} = \left[ \begin{matrix} \bm{Z}_1 &amp; \bm{Z}_2 &amp; \cdots &amp; \bm{Z}_L \end{matrix} \right]
\end{align}</annotation></semantics></math><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{\Lambda}(\bm{\theta})</annotation></semantics></math>
is a block diagonal matrix with elements
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>𝚲</mi><mrow><mi>l</mi><mi>l</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{\Lambda}_{ll}(\bm{\theta})</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚿</mi><annotation encoding="application/x-tex">\bm{\Psi}</annotation></semantics></math>
is a block diagonal matrix with elements
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝚿</mi><mrow><mi>l</mi><mi>l</mi></mrow></msub><annotation encoding="application/x-tex">\bm{\Psi}_{ll}</annotation></semantics></math>,
and
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝛖</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝛖</mi><mn>1</mn></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝛖</mi><mn>2</mn></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝛖</mi><mi>L</mi></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} 
\bm{\upsilon} = \left[ \begin{matrix} \bm{\upsilon}_1 \\ \bm{\upsilon}_2 \\ \vdots  \\ \bm{\upsilon}_L  \end{matrix} \right]
\end{align}</annotation></semantics></math></p>
<p>The likelihood of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>,
conditional on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>
is then
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>f</mi><mrow><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><mi>𝛖</mi><mo>=</mo><mi>𝛖</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munderover><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>x</mi></msub></munderover><msup><mrow><mo stretchy="true" form="prefix">[</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐲</mi><mi>i</mi></msub><mo>−</mo><msub><mi>𝐗</mi><mi>i</mi></msub><mi>𝛃</mi><mo>−</mo><msub><mi>𝐙</mi><mi>i</mi></msub><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>𝛖</mi><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munderover><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>x</mi></msub></munderover><mrow><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msubsup><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>𝐲</mi><mi>i</mi></msub><mo>−</mo><msub><mi>𝐗</mi><mi>i</mi></msub><mi>𝛃</mi><mo>−</mo><msub><mi>𝐙</mi><mi>i</mi></msub><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mrow><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mi>𝛀</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>−</mo><mi>𝐗</mi><mi>𝛃</mi><mo>−</mo><mi>𝐙</mi><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
f_{\bm{y}|\bm{\upsilon}=\bm{\upsilon}}(\bm{y}, \bm{\upsilon}) &amp;= \prod_{i=1}^{n_x} \left[ {\frac{1}{\left(2\pi\sigma^2\right)^{\frac{1}{2}}} \exp\left[-\frac{\left|\left|\bm{y}_i-\bm{X}_i\bm{\beta}-\bm{Z}_i\bm{\Lambda}(\bm{\theta})\bm{\upsilon} \right|\right|^2}{2\sigma^2}\right) } \right]^{\bm{\Omega}_{ii}} \\
 &amp;= \prod_{i=1}^{n_x}  {\frac{1}{\left(2\pi\sigma^2\right)^{\frac{\bm{\Omega}_{ii}}{2}}} \exp \left(- \frac{ \left|\left| \bm{\Omega}_{ii}^{\frac{1}{2}} \left(\bm{y}_i-\bm{X}_i\bm{\beta}-\bm{Z}_i\bm{\Lambda}(\bm{\theta})\bm{\upsilon} \right) \right|\right|^2}{2\sigma^2}\right) } \\
 &amp;= {\frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_i \bm{\Omega}_{ii}}{2}}} \exp \left( - \frac{ \left|\left|\bm{\Omega}^{\frac{1}{2}} \left(\bm{y}-\bm{X}\bm{\beta}-\bm{Z}\bm{\Lambda}(\bm{\theta})\bm{\upsilon} \right) \right|\right|^2}{2\sigma^2}\right) } \label{eq:WeMixWfyu}
\end{align}</annotation></semantics></math> And the unconditional
density of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>
is
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>f</mi><mi>𝛖</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munderover><mo>∏</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>z</mi></msub></munderover><msup><mrow><mo stretchy="true" form="prefix">[</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝛖</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><munderover><mo>∏</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>z</mi></msub></munderover><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msubsup><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝛖</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mi>𝚿</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mi>𝛖</mi><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
f_{\bm{\upsilon}}(\bm{\upsilon}) &amp;=\prod_{j=1}^{n_z} \left[ \frac{1}{\left(2\pi\sigma^2\right)^{\frac{1}{2}}} \exp \left[- \frac{ \left|\left|  \bm{\upsilon}_j \right|\right|^2}{2\sigma^2}\right]  \right]^{\bm{\Psi}_{jj}} \\
&amp;=\prod_{j=1}^{n_z} \frac{1}{\left(2\pi\sigma^2\right)^{\frac{\bm{\Psi}_{jj}}{2}}} \exp \left[- \frac{ \left|\left| \bm{\Psi}_{jj}^{\frac{1}{2}}  \bm{\upsilon}_j \right|\right|^2}{2\sigma^2}\right] \\
&amp;= \frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_j \bm{\Psi}_{jj}}{2}}} \exp \left[- \frac{ \left|\left|  \bm{\Psi}^{\frac{1}{2}}  \bm{\upsilon} \right|\right|^2}{2\sigma^2}\right] \label{eq:WeMixWfu}
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\sum \bm{\Psi}_{jj}</annotation></semantics></math>
is the sum of the terms in the diagonal matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚿</mi><annotation encoding="application/x-tex">\bm{\Psi}</annotation></semantics></math>.</p>
<p>The joint distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>
is then the product of eqs. and :
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>f</mi><mrow><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>f</mi><mrow><mi>𝐲</mi><mo stretchy="false" form="prefix">|</mo><mi>𝛖</mi><mo>=</mo><mi>𝛖</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><msub><mi>f</mi><mi>𝛖</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mrow><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mi>𝛀</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>−</mo><mrow><mi>𝐗</mi><mi>𝛃</mi></mrow><mo>−</mo><mi>𝐙</mi><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mrow><mo>⋅</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mi>𝚿</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mi>𝛖</mi><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo>+</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><mrow><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mi>𝛀</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>−</mo><mrow><mi>𝐗</mi><mi>𝛃</mi></mrow><mo>−</mo><mi>𝐙</mi><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msup><mi>𝚿</mi><mfrac><mn>1</mn><mn>2</mn></mfrac></msup><mi>𝛖</mi><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo>+</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><mrow><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
f_{\bm{y}, \bm{\upsilon}} \left(\bm{y}, \bm{\upsilon}, \bm{\beta}, \bm{\theta}, \sigma^2 \right)&amp;= f_{\bm{y}|\bm{\upsilon}=\bm{\upsilon}}(\bm{y}, \bm{\upsilon})\cdot f_{\bm{\upsilon}}(\bm{\upsilon})\\
&amp;={\frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_i \bm{\Omega}_{ii}}{2}}} \exp \left[- \frac{ \left|\left|\bm{\Omega}^{\frac{1}{2}} \left(\bm{y}-\bm{X\beta}-\bm{Z}\bm{\Lambda}(\bm{\theta})\bm{\upsilon}  \right) \right|\right|^2}{2\sigma^2}\right] } \cdot \frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_j \bm{\Psi}_{jj}}{2}}} \exp \left[- \frac{ \left|\left|  \bm{\Psi}^{\frac{1}{2}}  \bm{\upsilon} \right|\right|^2}{2\sigma^2}\right] \\
&amp;=\frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_i \bm{\Omega}_{ii} + \sum_j \bm{\Psi}_{jj}}{2}}} \exp \left[- \frac{ \left|\left|\bm{\Omega}^{\frac{1}{2}} \left(\bm{y}-\bm{X\beta}-\bm{Z}\bm{\Lambda}(\bm{\theta})\bm{\upsilon} \right) \right|\right|^2 + \left|\left|  \bm{\Psi}^{\frac{1}{2}}  \bm{\upsilon} \right|\right|^2}{2\sigma^2} \right] \\
&amp;=\frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_i \bm{\Omega}_{ii} + \sum_j \bm{\Psi}_{jj}}{2}}} \exp \left[- \frac{ r^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon})}{2\sigma^2} \right] 
\end{align}</annotation></semantics></math> Using the same logic for the
results in eq. ,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>r</mi><mn>2</mn></msup><annotation encoding="application/x-tex">r^2</annotation></semantics></math>
can be written as a sum of the value at the optimum
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\bm{\beta}}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\bm{\upsilon}}</annotation></semantics></math>)
and deviations from that:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>f</mi><mrow><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo>+</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><mrow><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>22</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>11</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>𝐑</mi><mn>12</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
f_{\bm{y}, \bm{\upsilon}} \left(\bm{y}, \bm{\upsilon}, \bm{\beta}, \bm{\theta}, \sigma^2 \right)&amp;=\frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_i \bm{\Omega}_{ii} + \sum_j \bm{\Psi}_{jj}}{2}}} \exp \left[- \frac{ r^2(\bm{\theta}, \hat{\bm{\beta}}, \hat{\bm{\upsilon}}) - \left| \left| \bm{R}_{22}(\bm{\beta} - \hat{\bm{\beta}})\right| \right|^2 - \left| \left| \bm{R}_{11}(\bm{\upsilon} - \hat{\bm{\upsilon}}) + \bm{R}_{12}(\bm{\beta} - \hat{\bm{\beta}}) \right| \right|^2}{2\sigma^2} \right]
\end{align}</annotation></semantics></math> Now, finding the integral of
this over
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>ℒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo>;</mo><mi>𝐲</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>∫</mo><msub><mi>f</mi><mrow><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>,</mo><mi>𝛖</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>𝛖</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>∫</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo>+</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><mrow><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>22</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>11</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>𝐑</mi><mn>12</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mi>d</mi><mi>𝛖</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo>+</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><mrow><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>22</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mo>∫</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>11</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>𝐑</mi><mn>12</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mi>d</mi><mi>𝛖</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\mathcal{L}(\bm{\beta}, \bm{\theta}, \sigma^2; \bm{y})&amp;=\int f_{\bm{y}, \bm{\upsilon}} \left(\bm{y}, \bm{\upsilon}, \bm{\beta}, \bm{\theta}, \sigma^2 \right)  d\bm{\upsilon} \\
&amp;=\int \frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_i \bm{\Omega}_{ii} + \sum_j \bm{\Psi}_{jj}}{2}}} \exp \left[- \frac{ r^2(\bm{\theta}, \hat{\bm{\beta}}, \hat{\bm{\upsilon}}) - \left| \left| \bm{R}_{22}(\bm{\beta} - \hat{\bm{\beta}})\right| \right|^2 - \left| \left| \bm{R}_{11}(\bm{\upsilon} - \hat{\bm{\upsilon}}) + \bm{R}_{12}(\bm{\beta} - \hat{\bm{\beta}}) \right| \right|^2}{2\sigma^2} \right] d\bm{\upsilon} \\
&amp;=\frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_i \bm{\Omega}_{ii} + \sum_j \bm{\Psi}_{jj}}{2}}} \exp \left[- \frac{ r^2(\bm{\theta}, \hat{\bm{\beta}}, \hat{\bm{\upsilon}}) - \left| \left| \bm{R}_{22}(\bm{\beta} - \hat{\bm{\beta}})\right| \right|^2 }{2\sigma^2}\right] \int \exp \left[- \frac{\left| \left|  \bm{R}_{11}(\bm{\upsilon} - \hat{\bm{\upsilon}}) + \bm{R}_{12}(\bm{\beta} - \hat{\bm{\beta}}) \right| \right|^2}{2\sigma^2} \right] d\bm{\upsilon} \label{eq:tmpLA}
\end{align}</annotation></semantics></math> Notice that while the
unweighted integral has
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>z</mi></msub><annotation encoding="application/x-tex">n_z</annotation></semantics></math>
dimensions, this weighted integral has
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>j</mi></msub><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\sum_j \bm{\Psi}_{jj}</annotation></semantics></math>
dimensions—the number of (population) individuals values to integrate
out.
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>ℒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo>;</mo><mi>𝐲</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><mrow><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>22</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mrow><mo stretchy="true" form="prefix">{</mo><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>∫</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>11</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛖</mi><mo>−</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>𝐑</mi><mn>12</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow><mi>d</mi><mi>𝛖</mi><mo stretchy="true" form="postfix">}</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\mathcal{L}(\bm{\beta}, \bm{\theta}, \sigma^2; \bm{y})
&amp;=\frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_i \bm{\Omega}_{ii}}{2}}} \exp \left[- \frac{ r^2(\bm{\theta}, \hat{\bm{\beta}}, \hat{\bm{\upsilon}}) - \left| \left| \bm{R}_{22}(\bm{\beta} - \hat{\bm{\beta}})\right| \right|^2 }{2\sigma^2}\right] \\ &amp; \left\{ \frac{1}{(2\pi\sigma^2)^{\frac{\sum_j \bm{\Psi}_{jj}}{2}}} \int \exp \left[- \frac{\left| \left|  \bm{R}_{11}(\bm{\upsilon} - \hat{\bm{\upsilon}}) + \bm{R}_{12}(\bm{\beta} - \hat{\bm{\beta}}) \right| \right|^2}{2\sigma^2} \right] d\bm{\upsilon} \right\} \label{eq:tmpLB}
\end{align}</annotation></semantics></math> However, while we know there
are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>j</mi></msub><msub><mi>𝚿</mi><mrow><mi>j</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\sum_j \bm{\Psi}_{jj}</annotation></semantics></math>
dimensions to integrate out (the number of population cases), a change
of variables must maintain the dimensionality of the integration, so it
is not clear how to proceed. Instead, we name the term inside the
integral
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
and use a different methodology to derive its value. Then,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>ℒ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo>;</mo><mi>𝐲</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>α</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>;</mo><mi>𝛀</mi><mo>,</mo><mi>𝚿</mi><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mn>1</mn><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><mn>2</mn></mfrac></msup></mfrac><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><mo>−</mo><mfrac><mrow><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mn>22</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>−</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\mathcal{L}(\bm{\beta}, \bm{\theta}, \sigma^2; \bm{y})
&amp;= \alpha(\bm{\theta};\bm{\Omega},\bm{\Psi}) \frac{1}{\left(2\pi\sigma^2\right)^{\frac{\sum_i \bm{\Omega}_{ii}}{2}}} \exp \left[- \frac{ r^2(\bm{\theta}, \hat{\bm{\beta}}, \hat{\bm{\upsilon}}) - \left| \left| \bm{R}_{22}(\bm{\beta} - \hat{\bm{\beta}})\right| \right|^2 }{2\sigma^2}\right] \label{eq:tmpL2} 
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
is a constant for a fixed
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
and set of weights
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛀</mi><annotation encoding="application/x-tex">\bm{\Omega}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚿</mi><annotation encoding="application/x-tex">\bm{\Psi}</annotation></semantics></math>.</p>
<p>While these formulas allow for estimation of a likelihood function
that allows for estimation of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\bm{\beta}}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><msup><mi>σ</mi><mn>2</mn></msup><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\sigma^2}</annotation></semantics></math>
via profiling, they do not depend on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
appears as a parameter of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>;
optimizing the log-likelihood with respect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
requires all of the terms in the log-likelihood to be calculated,
including
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>.</p>
<p>Bates and Pinheiro (1998) offer an unweighted method of calculating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
that we extend here to admit weighting. The essential insight of Bates
and Pinheiro is that the variables must be remapped, per group, using an
orthogonal transform that separates out the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mi>l</mi></msub><annotation encoding="application/x-tex">q_l</annotation></semantics></math>
random effects associated with group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
at level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>.
In what follows we describe a three-level case, but the methods readily
generalize to the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>-level
case.</p>
<p>The integral is slightly re-expressed using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐮</mi><annotation encoding="application/x-tex">\bm{u}</annotation></semantics></math>
instead of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>υ</mi><annotation encoding="application/x-tex">\upsilon</annotation></semantics></math>,
but instead of using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚲</mi><annotation encoding="application/x-tex">\bm{\Lambda}</annotation></semantics></math>
it uses the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚫</mi><annotation encoding="application/x-tex">\bm{\Delta}</annotation></semantics></math>
matrix, which is an individual block of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚲</mi><annotation encoding="application/x-tex">\bm{\Lambda}</annotation></semantics></math>,
so
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚫</mi><annotation encoding="application/x-tex">\bm{\Delta}</annotation></semantics></math>
is defined, implicitly, by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>𝚫</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⊗</mo><mi>𝐈</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\bm{\Lambda}(\bm{\theta}) = \bm{\Delta}(\bm{\theta})  \otimes \bm{I}
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>⊗</mo><annotation encoding="application/x-tex">\otimes</annotation></semantics></math>
is the Kronecker product.</p>
<p>Using this notation, the likelihood is then given by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>ℒ</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>∫</mo><munder><mo>∏</mo><mi>g</mi></munder><mrow><mo stretchy="true" form="prefix">[</mo><mo>∫</mo><msub><mi>f</mi><mrow><mi>y</mi><mo stretchy="false" form="prefix">|</mo><mi>U</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐲</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mo>,</mo><mi>⋯</mi><mo>,</mo><msub><mi>𝛖</mi><mrow><mi>L</mi><mi>g</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>f</mi><mi>U</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mo stretchy="true" form="postfix">]</mo></mrow><msub><mi>f</mi><mi>U</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>∝</mo><mo>∫</mo><munder><mo>∏</mo><mi>g</mi></munder><mrow><mo stretchy="true" form="prefix">[</mo><mo>∫</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msubsup><mi>Ω</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>𝐲</mi><mi>g</mi></msub><mo>−</mo><msub><mi>𝐗</mi><mi>g</mi></msub><mi>𝛃</mi><mo>−</mo><msub><mi>𝐙</mi><mi>g</mi></msub><mi>𝐮</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msubsup><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow><mi>T</mi></msubsup><msup><mi>𝚫</mi><mi>T</mi></msup><mi>𝚫</mi><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo stretchy="true" form="postfix">]</mo></mrow><mi>d</mi><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mo stretchy="true" form="postfix">]</mo></mrow><msub><mi>f</mi><mi>U</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\mathcal{L}&amp;=\int \prod_g \left[ \int f_{y|U} (\bm{y}, \bm{\theta}, \bm{u}_{2g}, \cdots, \bm{\upsilon}_{Lg} ) f_U (\bm{\theta}, \bm{u}_{2g}) d\bm{u}_{2g}  \right] f_{U} (\bm{\theta}, \bm{u}_{3g})  d\bm{u}_{3g} \label{eq:intalpha} \\
&amp;\propto \int \prod_g \left[ \int \exp \left[ \left | \left |\Omega_{gg}^{\frac{1}{2}} (\bm{y}_g - \bm{X}_g \bm{\beta} - \bm{Z}_g \bm{u})  \right | \right|^2 + \left| \left|\bm{u}^T_{2g} \bm{\Delta}^T \bm{\Delta} \bm{u}_{2g} \right|\right|^2 \right] d\bm{u}_{2g} \right] f_{U} (\bm{\theta}, \bm{u}_{3g})  d\bm{u}_{3g} \label{eq:intalpha2} 
\end{align}</annotation></semantics></math> and iteratively rewritten to
symbolically integrate out the lowest level random effects, starting
with level 2 and increasing until there are no remaining integrals. When
this is done, we will note the change of variable associated with a
weighted model and use that for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
in eq. . Because of that, the portions unrelated to the change of
variable were dropped from relation . Thus, notice that this goal is
just for units in a particular group
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>)
at level 2. These results of several integrals have to be combined to
solve the integral across all groups and calculate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>.
The value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
will be calculated by level and then summed; for a three-level model:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>α</mi><mo>=</mo><msub><mi>α</mi><mn>2</mn></msub><mo>+</mo><msub><mi>α</mi><mn>3</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\alpha = \alpha_2 + \alpha_3
\end{align}</annotation></semantics></math></p>
<p>While the residual sum of squares
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>r</mi><mn>2</mn></msup><annotation encoding="application/x-tex">r^2</annotation></semantics></math>)
has been, up until now, treated for the entire data set, the notion is
to think of the residual sum of squares for just group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
(at level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>).
Bates and Pinheiro (1998) also use the notion of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>r</mi><mi>g</mi><mn>2</mn></msubsup><annotation encoding="application/x-tex">r^2_g</annotation></semantics></math>,
or the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>r</mi><mn>2</mn></msup><annotation encoding="application/x-tex">r^2</annotation></semantics></math>
contribution for group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>,
which is defined as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>r</mi><mi>g</mi><mn>2</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐲</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐙</mi><mi>g</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>X</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚫</mi><mi>l</mi><mi>′</mi></msubsup></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐮</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r_g^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \left| \left| \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg}\bm{y}_g \\ \bm{0} \end{matrix} \right] - \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg} \bm{Z}_{g}  &amp; \bm{\Omega}^{\frac{1}{2}}_{gg} X_g \\ \bm{\Delta}_{l}^\prime &amp; \bm{0} \end{matrix} \right] \left[ \begin{matrix} \bm{u}_{g} \\ \bm{\beta} \end{matrix} \right]  \right| \right|^2 
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐲</mi><mi>g</mi></msub><annotation encoding="application/x-tex">\bm{y}_g</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝛖</mi><mi>g</mi></msub><annotation encoding="application/x-tex">\bm{\upsilon}_g</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐗</mi><mi>g</mi></msub><annotation encoding="application/x-tex">\bm{X}_g</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐙</mi><mi>g</mi></msub><annotation encoding="application/x-tex">\bm{Z}_g</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">\bm{\Omega}_{gg}</annotation></semantics></math>
are the rows of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>
vector, the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>
vector,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐗</mi><annotation encoding="application/x-tex">\bm{X}</annotation></semantics></math>
matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐙</mi><annotation encoding="application/x-tex">\bm{Z}</annotation></semantics></math>
matrix, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛀</mi><annotation encoding="application/x-tex">\bm{\Omega}</annotation></semantics></math>
matrix that are associated with group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>,
respectively; while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{\Lambda}(\bm{\theta})</annotation></semantics></math>
is the full
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝚲</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{\Lambda}(\theta)</annotation></semantics></math>
matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>𝚫</mi><mi>l</mi><mi>′</mi></msubsup><annotation encoding="application/x-tex">\bm{\Delta}_l^\prime</annotation></semantics></math>
is a block matrix:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>𝚫</mi><mi>l</mi><mi>′</mi></msubsup></mtd><mtd columnalign="left" style="text-align: left"><mo>≡</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚫</mi><mi>l</mi></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\bm{\Delta}_{l}^\prime &amp; \equiv \left[ \begin{matrix}\bm{\Delta}_{l} &amp; \bm{0} \end{matrix} \right] 
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝚫</mi><mi>l</mi></msub><annotation encoding="application/x-tex">\bm{\Delta}_l</annotation></semantics></math>
is the portion of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚫</mi><annotation encoding="application/x-tex">\bm{\Delta}</annotation></semantics></math>
associated with level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>,
and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>𝟎</mn><annotation encoding="application/x-tex">\bm{0}</annotation></semantics></math>
matrix is entirely zeros and conforms to the portion of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐮</mi><mi>g</mi></msub><annotation encoding="application/x-tex">\bm{u}_{g}</annotation></semantics></math>
that is associated with level 3 of the model.</p>
<p>Expanding
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐙</mi><mi>g</mi></msub><annotation encoding="application/x-tex">\bm{Z}_{g}</annotation></semantics></math>
gives
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>r</mi><mi>g</mi><mn>2</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐲</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐙</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐙</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>X</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚫</mi><mn>2</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝛖</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝛖</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r_g^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \left| \left| \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg}\bm{y}_g \\ \bm{0} \end{matrix} \right] - \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg} \bm{Z}_{2g} &amp; \bm{\Omega}^{\frac{1}{2}}_{gg} \bm{Z}_{3g} &amp; \bm{\Omega}^{\frac{1}{2}}_{gg} X_g \\ \bm{\Delta}_2 &amp; \bm{0}&amp; \bm{0} \end{matrix} \right] \left[ \begin{matrix} \bm{\upsilon}_{2g} \\ \bm{\upsilon}_{3g} \\ \bm{\beta} \end{matrix} \right]  \right| \right|^2 \label{eq:hugerg}
\end{align}</annotation></semantics></math></p>
<p>Starting at level 2, a change of variables is chosen via the (full)
QR decomposition,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐙</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚫</mi><mn>2</mn></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>12</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg} \bm{Z}_{2 g}  \\ \bm{\Delta}_2 \end{matrix} \right] &amp;= \bm{Q}_{2g} \left[ \begin{matrix} \bm{R}_{12g}  \\ \bm{0} \end{matrix} \right] \label{eq:QR0}
\end{align}</annotation></semantics></math> where the subscript on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>12</mn><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{12g}</annotation></semantics></math>
indicates that it is the top submatrix
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>),
at level 2, and for group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>.
Notice that the blocks are different shapes on the left- and right-hand
sides of eq. ; on the left-hand side, the top block
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐙</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\bm{\Omega}^{\frac{1}{2}}_{gg} \bm{Z}_{2 g}</annotation></semantics></math>)
has as many rows as there are observations in group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
and the bottom block
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝚫</mi><mn>2</mn></msub><annotation encoding="application/x-tex">\bm{\Delta}_2</annotation></semantics></math>)
has as many rows as there are random effects at level 2, while the
right-hand side is flipped. The top block
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>12</mn><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{12g}</annotation></semantics></math>)
has as many rows as there are random effects at level 2, while the
bottom block
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>𝟎</mn><annotation encoding="application/x-tex">\bm{0}</annotation></semantics></math>)
has as many rows as there are observations in group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>.
The reason for this is that the change makes the top block on the
right-hand side a square, upper triangular matrix, which will allow the
change of variables to proceed.</p>
<p>Because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">\bm{Q}_{2g}</annotation></semantics></math>
is orthogonal by construction,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow><mi>T</mi></msubsup><msub><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mo>=</mo><mi>I</mi></mrow><annotation encoding="application/x-tex">\bm{Q}_{2g}^T \bm{Q}_{2g}= I</annotation></semantics></math>,
one can freely premultiply the inside of the sum of squares in eq. by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow><mi>T</mi></msubsup><annotation encoding="application/x-tex">\bm{Q}_{2g}^T</annotation></semantics></math>
without changing the sum of squares:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>r</mi><mi>g</mi><mn>2</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msubsup><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow><mi>T</mi></msubsup><mrow><mo stretchy="true" form="prefix">{</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐲</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐙</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐙</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐗</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚫</mi><mn>2</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝛖</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝛖</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">}</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r_g^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon}) &amp;= \left| \left| \bm{Q}_{2g}^T \left\{ \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg}\bm{y}_g \\ \bm{0} \end{matrix} \right] - \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg} \bm{Z}_{2g}  &amp; \bm{\Omega}^{\frac{1}{2}}_{gg} \bm{Z}_{3g}  &amp; \bm{\Omega}^{\frac{1}{2}}_{gg} \bm{X}_g \\ \bm{\Delta}_2 &amp; \bm{0} &amp; \bm{0} \end{matrix} \right] \left[ \begin{matrix} \bm{\upsilon}_{2g} \\ \bm{\upsilon}_{3g} \\ \bm{\beta} \end{matrix} \right] \right\}  \right| \right|^2 \label{eq:Qz}
\end{align}</annotation></semantics></math> Then, defining
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow><mi>T</mi></msubsup><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐲</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>≡</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>y</mi><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>y</mi><mi>g</mi></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="right" style="text-align: right"><msubsup><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow><mi>T</mi></msubsup><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐙</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>≡</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>23</mn><mi>g</mi></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="right" style="text-align: right"><msubsup><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow><mi>T</mi></msubsup><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝛀</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐗</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>≡</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>X</mi><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>X</mi><mi>g</mi></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\bm{Q}_{2g}^T \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg}\bm{y}_g \\ \bm{0} \end{matrix} \right] &amp; \equiv  \left[ \begin{matrix} \bm{R}_{1yg} \\ \bm{R}_{2yg} \end{matrix} \right] &amp; \bm{Q}_{2g}^T \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg} \bm{Z}_{3g}  \\ \bm{0} \end{matrix} \right] &amp; \equiv  \left[ \begin{matrix} \bm{R}_{13g} \\ \bm{R}_{23g} \end{matrix} \right] &amp; \bm{Q}_{2g}^T \left[ \begin{matrix} \bm{\Omega}^{\frac{1}{2}}_{gg} \bm{X}_{g}  \\ \bm{0} \end{matrix} \right] &amp; \equiv  \left[ \begin{matrix} \bm{R}_{1Xg} \\ \bm{R}_{2Xg} \end{matrix} \right] \label{eq:Qtdef}
\end{align}</annotation></semantics></math> similar to eq. , and with
the same dimensions, the blocks are of different shapes on the left and
right of the equation.</p>
<p>Multiplying the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>𝐐</mi><mrow><mn>2</mn><mi>g</mi></mrow><mi>T</mi></msubsup><annotation encoding="application/x-tex">\bm{Q}_{2g}^T</annotation></semantics></math>
through and plugging the eq. equations into eq. ,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>r</mi><mi>g</mi><mn>2</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝐮</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>y</mi><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>y</mi><mi>g</mi></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>12</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>X</mi><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>23</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>X</mi><mi>g</mi></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r_g^2(\bm{\theta}, \bm{\beta}, \bm{u})  &amp;= \left| \left| \left[ \begin{matrix} \bm{R}_{1yg} \\ \bm{R}_{2yg} \end{matrix} \right] -  \left[ \begin{matrix} \bm{R}_{12g} &amp; \bm{R}_{13g} &amp;  \bm{R}_{1Xg} \\ \bm{0} &amp; \bm{R}_{23g} &amp; \bm{R}_{2Xg} \end{matrix} \right] \left[ \begin{matrix} \bm{u}_{2g} \\ \bm{u}_{3g} \\ \bm{\beta} \end{matrix} \right]  \right| \right|^2
\end{align}</annotation></semantics></math> it is now possible to
simplify the integral, do a change of variables and integrate out level
2 random effects for group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>,
and solve the first integral in eq. symbolically. In particular, this
rewriting of the terms means there are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>q</mi><mn>2</mn></msub><annotation encoding="application/x-tex">q_2</annotation></semantics></math>
terms with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">\bm{u}_{2g}</annotation></semantics></math>
in them and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>g</mi></msub><mo>−</mo><msub><mi>q</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">n_g - q_2</annotation></semantics></math>
terms that are redefined to be orthogonal to those two terms. It is this
orthogonality that allows the other terms to be removed from the
integral. So, since we have just shown
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><msubsup><mi>Ω</mi><mrow><mi>g</mi><mi>g</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>𝐲</mi><mi>g</mi></msub><mo>−</mo><msub><mi>𝐗</mi><mi>g</mi></msub><mi>𝛃</mi><mo>−</mo><msub><mi>𝐙</mi><mi>g</mi></msub><msub><mi>𝚲</mi><mrow><mi>l</mi><mi>l</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>𝐮</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>+</mo><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>𝐮</mi><msup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup><mo>=</mo></mtd><mtd columnalign="left" style="text-align: left"><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>y</mi><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>y</mi><mi>g</mi></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>12</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>X</mi><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>23</mn><mi>g</mi></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>X</mi><mi>g</mi></mrow></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mtable><mtr><mtd columnalign="right" style="text-align: right"><mo>=</mo></mtd><mtd columnalign="left" style="text-align: left"><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>y</mi><mi>g</mi></mrow></msub><mo>−</mo><msub><mi>𝐑</mi><mrow><mn>12</mn><mi>g</mi></mrow></msub><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mo>−</mo><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi></mrow></msub><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub><mo>−</mo><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>X</mi><mi>g</mi></mrow></msub><msub><mi>𝛃</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mo>+</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>y</mi><mi>g</mi></mrow></msub><mo>−</mo><msub><mi>𝐑</mi><mrow><mn>23</mn><mi>g</mi></mrow></msub><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub><mo>−</mo><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>X</mi><mi>g</mi></mrow></msub><msub><mi>𝛃</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
||\Omega_{gg}^{\frac{1}{2}} (\bm{y}_g - \bm{X}_g \bm{\beta} - \bm{Z}_g \bm{\Lambda}_{ll} (\bm{\theta}) \bm{u})  ||^2 + ||\bm{u}||^2 =&amp; \left| \left| \left[ \begin{matrix} \bm{R}_{1yg} \\ \bm{R}_{2yg} \end{matrix} \right] -  \left[ \begin{matrix} \bm{R}_{12g} &amp; \bm{R}_{13g} &amp; \bm{R}_{1Xg} \\ \bm{0} &amp; \bm{R}_{23g} &amp; \bm{R}_{2Xg} \end{matrix} \right] \left[ \begin{matrix} \bm{u}_{2g} \\ \bm{u}_{3g} \\ \bm{\beta} \end{matrix} \right]  \right| \right|^2 \\
\begin{split}
=&amp; \left| \left| \bm{R}_{1yg} -   \bm{R}_{12g} \bm{u}_{2g} - \bm{R}_{13g} \bm{u}_{3g}  - \bm{R}_{1Xg} \bm{\beta}_{g} \right| \right|^2  \\ 
 &amp;+ \left| \left| \bm{R}_{2yg}  - \bm{R}_{23g}\bm{u}_{3g} - \bm{R}_{2Xg} \bm{\beta}_{g}  \right| \right|^2
\end{split}
\end{align}</annotation></semantics></math> which can now be substituted
into eq. , allowing a change of variables:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>𝛄</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mo>=</mo></mtd><mtd columnalign="left" style="text-align: left"><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>y</mi><mi>g</mi></mrow></msub><mo>−</mo><msub><mi>𝐑</mi><mrow><mn>12</mn><mi>g</mi></mrow></msub><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><mo>−</mo><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi></mrow></msub><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub><mo>−</mo><msub><mi>𝐑</mi><mrow><mn>1</mn><mi>X</mi><mi>g</mi></mrow></msub><msub><mi>𝛃</mi><mi>g</mi></msub></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mfrac><mrow><mi>d</mi><msub><mi>𝛄</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mrow><mrow><mi>d</mi><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub></mrow></mfrac><mo>=</mo></mtd><mtd columnalign="left" style="text-align: left"><msub><mi>𝐑</mi><mrow><mn>12</mn><mi>g</mi></mrow></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\bm{\gamma}_{2g} =&amp;  \bm{R}_{1yg} -   \bm{R}_{12g} \bm{u}_{2g} - \bm{R}_{13g} \bm{u}_{3g} - \bm{R}_{1Xg} \bm{\beta}_{g} \\
\frac{d\bm{\gamma}_{2g}}{d\bm{u}_{2g}} =&amp; \bm{R}_{12g} 
\end{align}</annotation></semantics></math> The value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mn>2</mn></msub><annotation encoding="application/x-tex">\alpha_2</annotation></semantics></math>
in the unweighted case is now clear: <span class="math display">$$\begin{align}
\alpha_{2u} =&amp; \sum_{g=1}^{n_2} |{\rm det}(\bm{R}_{12g})|^{-1}
\end{align}$$</span> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mrow><mn>2</mn><mi>u</mi></mrow></msub><annotation encoding="application/x-tex">\alpha_{2u}</annotation></semantics></math>
is the unweighted alpha. This formula can be weighted simply by applying
the replicate weights to the individual terms: <span class="math display">$$\begin{align}
\alpha_{2} =&amp; \sum_{g=1}^{n_2} \bm{\Psi}_{gg} |{\rm
det}(\bm{R}_{12g})|^{-1}
\end{align}$$</span> However, for the three-level model, the likelihood
still has level 3 integrals. The level 3 integral can also be removed.
We cannot restart this process with the original
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐙</mi><annotation encoding="application/x-tex">\bm{Z}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐗</mi><annotation encoding="application/x-tex">\bm{X}</annotation></semantics></math>
matrices and other components because they change with the components
inside the level 2 integral. However, the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>2</mn><mo>*</mo><mo>*</mo></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{2**}</annotation></semantics></math>
matrices are the portions of the higher level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">\bm{u}_{3g}</annotation></semantics></math>
that were not integrated out, and they can be used independent of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐮</mi><mrow><mn>2</mn><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">\bm{u}_{2g}</annotation></semantics></math>.</p>
<p>We continue on with these remapped variables, starting the unweighted
case (only at level 2), and now using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">g'</annotation></semantics></math>
to indicate that this is a different group (at level 3), with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub><annotation encoding="application/x-tex">n_{g'}</annotation></semantics></math>
subgroups in it. Each group (labeled
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>)
contributes an outcomes matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>y</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{2yi}</annotation></semantics></math>,
a matrix per level 2 group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>23</mn><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{23i}</annotation></semantics></math>
and a matrix per fixed effects regressor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐗</mi><mrow><mn>2</mn><mi>X</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">\bm{X}_{2Xi}</annotation></semantics></math>,
for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>⋯</mi><mo>,</mo><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub></mrow><annotation encoding="application/x-tex">i=1, \cdots, n_{g'}</annotation></semantics></math>.
Combining these, the residual sum of squares at level 3 for the group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">g'</annotation></semantics></math>
is
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>r</mi><mrow><mi>g</mi><mi>′</mi></mrow><mn>2</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>y</mi><mn>1</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>y</mi><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mn>231</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>X</mi><mn>1</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>23</mn><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>X</mi><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚫</mi><mn>3</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r_{g'}^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon})  &amp;= \left| \left| \left[ \begin{matrix} \bm{R}_{2y1} \\ \vdots \\ \bm{R}_{2yn_{g'}} \\ \bm{0} \end{matrix} \right] -  \left[ \begin{matrix}   \bm{R}_{231} &amp; \bm{R}_{2X1} \\ \vdots &amp; \vdots \\  \bm{R}_{23n_{g'}} &amp; \bm{R}_{2Xn_{g'}}  \\ \bm{\Delta}_{3} &amp; \bm{0} \end{matrix} \right] \left[ \begin{matrix} \bm{u}_{3g} \\ \bm{\beta} \end{matrix} \right]  \right| \right|^2 \label{eq:RunW}
\end{align}</annotation></semantics></math> Following the example at
level 2 above, the QR decomposition is then used:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mn>231</mn></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>23</mn><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚫</mi><mn>3</mn></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><msub><mi>𝐐</mi><mrow><mn>3</mn><mi>g</mi><mi>′</mi><mo>,</mo><mi>u</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi><mi>′</mi><mo>,</mo><mi>u</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\left[ \begin{matrix} \bm{R}_{231} \\ \vdots \\ \bm{R}_{23n_{g'}} \\ \bm{\Delta}_{3} \end{matrix} \right] = \bm{Q}_{3g',u} \left[ \begin{matrix} \bm{R}_{13g',u}  \\ \bm{0} \end{matrix} \right]
\end{align}</annotation></semantics></math> where a subscript
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>u</mi><annotation encoding="application/x-tex">u</annotation></semantics></math>
is used to indicate that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐐</mi><mrow><mn>3</mn><mi>g</mi><mi>′</mi><mo>,</mo><mi>u</mi></mrow></msub><annotation encoding="application/x-tex">\bm{Q}_{3g',u}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi><mi>′</mi><mo>,</mo><mi>u</mi></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{13g',u}</annotation></semantics></math>
are unweighted. The remaining steps are then identical to the level 2
case;
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi><mi>′</mi><mo>,</mo><mi>u</mi></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{13g',u}</annotation></semantics></math>
is used as the change of variables, so that <span class="math inline">$\alpha_{3u} = \sum_{g'=1}^{n_2} |{\rm
det}(\bm{R}_{13g',u})|^{-1}$</span>, and the other
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>3</mn><mo>*</mo><mo>*</mo></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{3**}</annotation></semantics></math>
matrices can be used to integrate out level-4 cases and so on.</p>
<p>When there are level 2 conditional weights—non-unit probabilities of
selection for the groups at level 2, conditional on the selection of the
level 3 unit—each matrix in eq. could be replicated
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝚿</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">\bm{\Psi}_{ii}</annotation></semantics></math>
times. Equivalently, each matrix can be weighted by the conditional
probability of selection, so that eq. becomes
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>r</mi><mrow><mi>g</mi><mi>′</mi></mrow><mn>2</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mi>𝛃</mi><mo>,</mo><mi>𝛖</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">|</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚿</mi><mn>11</mn><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>y</mi><mn>1</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚿</mi><mrow><mi>g</mi><mi>′</mi><mi>g</mi><mi>′</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>y</mi><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚿</mi><mn>11</mn><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐑</mi><mn>231</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚿</mi><mn>11</mn><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>X</mi><mn>1</mn></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚿</mi><mrow><mi>g</mi><mi>′</mi><mi>g</mi><mi>′</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐑</mi><mrow><mn>23</mn><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub></mrow></msub></mtd><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚿</mi><mrow><mi>g</mi><mi>′</mi><mi>g</mi><mi>′</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐑</mi><mrow><mn>2</mn><mi>X</mi><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚫</mi><mn>3</mn></msub></mtd><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐮</mi><mrow><mn>3</mn><mi>g</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>𝛃</mi></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
r_{g'}^2(\bm{\theta}, \bm{\beta}, \bm{\upsilon})  &amp;= \left| \left| \left[ \begin{matrix} \bm{\Psi}_{11}^{\frac{1}{2}} \bm{R}_{2y1} \\ \vdots \\ \bm{\Psi}_{g'g'}^{\frac{1}{2}} \bm{R}_{2yn_{g'}} \\ \bm{0} \end{matrix} \right] -  \left[ \begin{matrix}   \bm{\Psi}_{11}^{\frac{1}{2}} \bm{R}_{231} &amp;  \bm{\Psi}_{11}^{\frac{1}{2}} \bm{R}_{2X1} \\ \vdots &amp; \vdots \\  \bm{\Psi}_{g'g'}^{\frac{1}{2}} \bm{R}_{23n_{g'}} &amp; \bm{\Psi}_{g'g'}^{\frac{1}{2}} \bm{R}_{2Xn_{g'}}  \\ \bm{\Delta}_{3} &amp; \bm{0} \end{matrix} \right] \left[ \begin{matrix} \bm{u}_{3g} \\ \bm{\beta} \end{matrix} \right]  \right| \right|^2 \label{eq:R}
\end{align}</annotation></semantics></math></p>
<p>This change leads to the same QR decomposition as the replicated
case:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚿</mi><mn>11</mn><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐑</mi><mn>231</mn></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mi>⋮</mi></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msubsup><mi>𝚿</mi><mrow><mi>g</mi><mi>′</mi><mi>g</mi><mi>′</mi></mrow><mfrac><mn>1</mn><mn>2</mn></mfrac></msubsup><msub><mi>𝐑</mi><mrow><mn>23</mn><msub><mi>n</mi><mrow><mi>g</mi><mi>′</mi></mrow></msub></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝚫</mi><mn>3</mn></msub></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow><mo>=</mo><msub><mi>𝐐</mi><mrow><mn>3</mn><mi>g</mi><mi>′</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">[</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi><mi>′</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mn>𝟎</mn></mtd></mtr></mtable><mo stretchy="true" form="postfix">]</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\left[  \begin{matrix} \bm{\Psi}_{11}^{\frac{1}{2}} \bm{R}_{231} \\ \vdots \\ \bm{\Psi}_{g'g'}^{\frac{1}{2}} \bm{R}_{23n_{g'}} \\ \bm{\Delta}_{3} \end{matrix} \right] = \bm{Q}_{3g'} \left[ \begin{matrix} \bm{R}_{13g'}  \\ \bm{0} \end{matrix} \right] \label{eq:QRg3}
\end{align}</annotation></semantics></math></p>
<p>The weighted value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mn>3</mn></msub><annotation encoding="application/x-tex">\alpha_3</annotation></semantics></math>
for the third level is then
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>α</mi><mn>3</mn></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>g</mi><mi>′</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mn>3</mn></msub></munderover><msub><mi>𝚿</mi><mrow><mi>g</mi><mi>′</mi><mi>g</mi><mi>′</mi></mrow></msub><msup><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>𝐑</mi><mrow><mn>13</mn><mi>g</mi><mi>′</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\alpha_{3} = \sum_{g'=1}^{n_3} \bm{\Psi}_{g'g'} \left| \bm{R}_{13g'} \right|^{-1}
\end{align}</annotation></semantics></math></p>
<p>The actual implementation of the calculation is slightly different
from what is above. First, when the QR decomposition is taken (eqs. and
), it is possible to stop the decomposition as is described in Bates and
Pinheiro (1998). It is also possible to continue the QR decomposition
for the other levels of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐙</mi><annotation encoding="application/x-tex">\bm{Z}</annotation></semantics></math>.
Using the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐐</mi><mi>𝐑</mi></mrow><annotation encoding="application/x-tex">\bm{QR}</annotation></semantics></math>
on the entire matrix still results in an orthogonal component in the
submatrices, and so meets the goals of the decomposition while obviating
the need to form the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐐</mi><annotation encoding="application/x-tex">\bm{Q}</annotation></semantics></math>
matrix explicitly.</p>
<p>Also note that, in the above, the value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>r</mi><mn>2</mn></msup><annotation encoding="application/x-tex">r^2</annotation></semantics></math>
was never used, so the components relating to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐗</mi><annotation encoding="application/x-tex">\bm{X}</annotation></semantics></math>
need not be formed.</p>
<p>Continuing to follow <code>lme4</code>, the estimation uses the
profile likelihood. Since
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
appears only in the final term in quadratic form, it is immediately
evident that the maximum likelihood estimator (MLE) for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\bm{\beta}}</annotation></semantics></math>,
making eq. profile to <span class="math display">$$\begin{align}
D \left( \bm{\theta}, \sigma^2; \bm{y} \right)&amp;= 2\,\rm{ln}
\left(\alpha (\bm{\theta};\bm{\Psi},\bm{\Omega}) \right) + \left(\sum_i
\bm{\Omega}_{ii} \right) \rm{ln} \left(2\pi\sigma^2\right) +
\frac{r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}})}{\sigma^2}
\label{eq:WeMixPB}
\end{align}$$</span></p>
<p>Then, the value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>
can also be profiled out by taking the derivative of the deviance with
respect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>
and setting it equal to zero (Bates et al., 2015, eq. 32):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mn>0</mn></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><mover><msup><mi>σ</mi><mn>2</mn></msup><mo accent="true">̂</mo></mover></mfrac><mo>−</mo><mfrac><mrow><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mover><msup><mi>σ</mi><mn>4</mn></msup><mo accent="true">̂</mo></mover></mfrac></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
0 &amp;= \frac{\sum_i \bm{\Omega}_{ii}}{\widehat{\sigma^2}} - \frac{r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}}) }{\widehat{\sigma^4}} 
\end{align}</annotation></semantics></math> rearranging
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mover><msup><mi>σ</mi><mn>2</mn></msup><mo accent="true">̂</mo></mover></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mfrac><mrow><msup><mi>r</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo>,</mo><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mo>,</mo><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>𝛀</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow></mfrac></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\widehat{\sigma^2} &amp;=  \frac{r^2(\bm{\theta}, \bm{\hat{\beta}}, \bm{\hat{\upsilon}}) }{\sum_i \bm{\Omega}_{ii}}  \label{eq:WeMixMaxs2} 
\end{align}</annotation></semantics></math> Eq. can then be plugged into
eq. to give <span class="math display">$$\begin{align}
D \left( \bm{\theta}; \bm{y} \right)&amp;= 2\, \rm{ln} \left(\alpha
(\bm{\theta};\bm{\Psi},\bm{\Omega}) \right)  + \left(\sum_i
\bm{\Omega}_{ii}\right) \left[ \rm{ln}
\left(2\pi\widehat{\sigma^2}\right) + 1 \right] \label{eq:WeMixP}
\end{align}$$</span> This function is then minimized numerically with
respect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>,
using the profile estimates for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛖</mi><annotation encoding="application/x-tex">\bm{\upsilon}</annotation></semantics></math>
(eq. ) and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><msup><mi>σ</mi><mn>2</mn></msup><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\widehat{\sigma^2}</annotation></semantics></math>
(eq. ).</p>
<p>The estimated values are then the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
that maximize eq. , the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>
value from eq. , and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
values from solving the system of equations in eq. .</p>
</div>
<div class="section level2">
<h2 id="variance-estimation">Variance Estimation<a class="anchor" aria-label="anchor" href="#variance-estimation"></a>
</h2>
<p>The inverse Hessian of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
is given by (Bates et al., 2015, eq. 54): <span class="math display">$$\begin{align}
\widehat{\rm{Var}}(\bm{\beta}) &amp;= \widehat{\sigma^2}
\bm{R}_{22}^{-1} \left(\bm{R}^T_{22}\right)^{-1}
\end{align}$$</span> with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mn>22</mn></msub><annotation encoding="application/x-tex">\bm{R}_{22}</annotation></semantics></math>
coming from eq. . This variance estimator assumes that the weights are
information weights and so is inappropriate for survey weights.</p>
<p>A robust (sandwich) variance estimator is given by (Binder, 1983) is
appropriate:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mrow><mo stretchy="true" form="prefix">(</mo><mover><msup><mi>σ</mi><mn>2</mn></msup><mo accent="true">̂</mo></mover><msubsup><mi>𝐑</mi><mn>22</mn><mi>T</mi></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi>𝐉</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mover><msup><mi>σ</mi><mn>2</mn></msup><mo accent="true">̂</mo></mover><msubsup><mi>𝐑</mi><mn>22</mn><mi>T</mi></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\left(\widehat{\sigma^2} \bm{R}^T_{22}\right)^{-1} \bm{J} \left(\widehat{\sigma^2} \bm{R}^T_{22}\right)^{-1} \label{eq:sandwich}
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐉</mi><annotation encoding="application/x-tex">\bm{J}</annotation></semantics></math>
is the sum of outer products of the Jacobian matrix
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>𝐉</mi><mo>=</mo><mfrac><msub><mi>n</mi><mi>L</mi></msub><mrow><msub><mi>n</mi><mi>L</mi></msub><mo>−</mo><mn>1</mn></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>g</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>n</mi><mi>L</mi></msub></munderover><mfrac><mrow><mi>∂</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mo>ℓ</mo><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>∂</mi><mi>𝛃</mi></mrow></mfrac></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\bm{J} = \frac{n_L}{n_L-1} \sum_{g=1}^{n_L} \frac{\partial(\ell_g)}{\partial \bm{\beta}}
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>L</mi></msub><annotation encoding="application/x-tex">n_L</annotation></semantics></math>
is the number of
level-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
(top-level) groups,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
indexes
level-<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
groups, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mo>ℓ</mo><mi>g</mi></msub><annotation encoding="application/x-tex">\ell_g</annotation></semantics></math>
is the log-likelihood for group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
and all groups and units nested inside of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>.
The log-likelihood of the full model is <span class="math display">$$\begin{align}
\ell(\bm{\beta}, \bm{\theta}, \sigma^2; \bm{y}) &amp;= \rm{ln} \left[
\alpha(\bm{\theta};\bm{\Omega},\bm{\Psi}) \right] - \frac{\sum_{i}
\bm{\Omega}_{ii}}{2} \rm{ln} \left(2\pi\sigma^2\right) - \frac{
r^2\left(\bm{\theta}, \hat{\bm{\beta}}, \hat{\bm{\upsilon}}\right)}{2
\sigma^2} - \frac{\left| \left| \bm{R}_{22}\left(\hat{\bm{\beta}} -
\bm{\beta}\right)\right| \right|^2 }{2\sigma^2} \label{eq:Vlnl}
\end{align}$$</span> where we are allowing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
to vary but are fixing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>
at the estimated value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mover><mi>σ</mi><mo accent="true">̂</mo></mover><mn>2</mn></msup><annotation encoding="application/x-tex">\hat{\sigma}^2</annotation></semantics></math>.
This could have been annotated by making
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\hat{\bm{\beta}}(\bm{\theta})</annotation></semantics></math>
because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\bm{\beta}}</annotation></semantics></math>
is the estimated value conditional on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
and appears in the equation separate from the value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>,
but that is not shown here.</p>
<p>While it would be convenient if eq. could be directly broken up into
a portion attributable to each group, and some encouragement appears
when the first three terms can be, the final term has dependencies
across multiple groups. A distinct likelihood is needed that depends
only on the data in that group. This is achieved by noting that data for
a particular group is also valid data for a mixed model of the same type
as the global mixed model, and so eq. can be used on a single group’s
data to get the group log-likelihood; thus a group log-likelihood can be
written using the notion of the fitted value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
in the group
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mi>g</mi></msub><annotation encoding="application/x-tex">\hat{\bm{\beta}}_g</annotation></semantics></math>)
<span class="math display">$$\begin{align}
\ell_g(\bm{\beta}, \bm{\theta}, \sigma^2; \bm{y}_g) &amp;= \rm{ln}
\left[ \alpha_g(\bm{\theta};\bm{\Omega},\bm{\Psi}) \right] -
\frac{\sum_{i\in g} \bm{\Omega}_{ii}}{2} \rm{ln}
\left(2\pi\sigma^2\right) - \frac{ r^2\left(\bm{\theta},
\hat{\bm{\beta}}_g, \hat{\bm{\upsilon}}_g\right)}{2\sigma^2} -
\frac{\left| \left| \bm{R}_{22g}\left(\hat{\bm{\beta}}_g -
\bm{\beta}\right)\right| \right|^2 }{2\sigma^2} \label{eq:Vlnlg}
\end{align}$$</span> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mi>g</mi></msub><annotation encoding="application/x-tex">\alpha_g</annotation></semantics></math>
is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
term for group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
and any groups nested in it, the sum for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Ω</mi><annotation encoding="application/x-tex">\Omega</annotation></semantics></math>
is just over
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
terms associated with group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\bm{\beta}}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>𝛖</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\bm{\upsilon}}</annotation></semantics></math>
are the values fitted only on this group, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>22</mn><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{22g}</annotation></semantics></math>
is the result of a QR on a version of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐀</mi><annotation encoding="application/x-tex">\bm{A}</annotation></semantics></math>
performed on just data
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐗</mi><annotation encoding="application/x-tex">\bm{X}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐙</mi><annotation encoding="application/x-tex">\bm{Z}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐲</mi><annotation encoding="application/x-tex">\bm{y}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚿</mi><annotation encoding="application/x-tex">\bm{\Psi}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛀</mi><annotation encoding="application/x-tex">\bm{\Omega}</annotation></semantics></math>)
associated with group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>,
while the values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
are the values from the value the function is being evaluated at
globally. Then,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mo>ℓ</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo>;</mo><mi>𝐲</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munder><mo>∑</mo><mi>g</mi></munder><msub><mo>ℓ</mo><mi>g</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo>,</mo><mi>𝛉</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo>;</mo><msub><mi>𝐲</mi><mi>g</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\ell(\bm{\beta}, \bm{\theta}, \sigma^2; \bm{y}) = \sum_g \ell_g(\bm{\beta}, \bm{\theta}, \sigma^2; \bm{y}_g)
\end{align}</annotation></semantics></math> A few notes are required at
this point on how, exactly, this is calculated in degenerate cases. When
the matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐀</mi><mi>g</mi></msub><annotation encoding="application/x-tex">\bm{A}_g</annotation></semantics></math>
is singular for a group (e.g., when there is only one unit in the
group), then the inestimable values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝛃</mi><mi>g</mi></msub><annotation encoding="application/x-tex">\bm{\beta}_g</annotation></semantics></math>
are set to zero when forming
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mi>g</mi></msub><mo>−</mo><mi>𝛃</mi></mrow><annotation encoding="application/x-tex">\hat{\bm{\beta}}_g - \bm{\beta}</annotation></semantics></math>.
Similarly,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐑</mi><mrow><mn>22</mn><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">\bm{R}_{22g}</annotation></semantics></math>
may not have enough rows to form a upper-triangular matrix. The portion
that can be formed (including all columns) is then used—this does not
affect the computation of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>𝐑</mi><mrow><mn>22</mn><mi>g</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>𝛃</mi><mo accent="true">̂</mo></mover><mi>g</mi></msub><mo>−</mo><mi>𝛃</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{R}_{22g}\left(\hat{\bm{\beta}}_g - \bm{\beta}\right)</annotation></semantics></math>.</p>
<p>Using these formulas the Jacobian matrix can now be calculated
numerically and the robust variance estimator formed with eq. .</p>
<p>So far this section has regarded only
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
but similar methods apply to the estimation of the variance of the
random effect variance estimates
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>).
These variance terms have their variance estimated assuming that they
are uncorrelated with the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛃</mi><annotation encoding="application/x-tex">\bm{\beta}</annotation></semantics></math>
terms. At each level the variance is calculated, including a term for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>,
as <span class="math display">$$\begin{align}
{\rm Var} \left(\bm{\theta},\sigma \right) = \left( -\bm{H} \right)^{-1}
\bm{J}_{\bm{\theta},\sigma} \left( -\bm{H} \right)^{-1} \label{vartheta}
\end{align}$$</span> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐇</mi><annotation encoding="application/x-tex">\bm{H}</annotation></semantics></math>
is the Hessian of the likelihood (eq. ) with respect to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐉</mi><mrow><mi>𝛉</mi><mo>,</mo><mi>σ</mi></mrow></msub><annotation encoding="application/x-tex">\bm{J}_{\bm{\theta},\sigma}</annotation></semantics></math>
is the portion of the Jacobian that regards
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>.
The estimated value for the variance of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
from the lowest level group (level 2) is used to form the standard error
of the residual variance.</p>
<p>However, the variance estimates are not simply the values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\bm{\theta}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
but transformations of that (eq. ). To estimate the variances of the
variance estimates, the Delta method is used so that <span class="math display">$$\begin{align}
{\rm Var}\left(\bm{\Sigma}, \sigma^2 \right) = \left[ \nabla (
\bm{\Lambda}^T \bm{\Lambda} ) \right]^T {\rm Var}\left(\bm{\theta},
\sigma^2 \right) \left[ \nabla  ( \bm{\Lambda}^T \bm{\Lambda}) \right]
\end{align}$$</span> where the gradient
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>∇</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\nabla (\cdot)</annotation></semantics></math>)
is taken with respect to the elements of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝚺</mi><annotation encoding="application/x-tex">\bm{\Sigma}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>,
and <span class="math inline">$\rm{Var}\left(\bm{\theta}, \sigma^2
\right)$</span> is from eq. .</p>
<div class="section level3">
<h3 id="model-evaluation-wald-test">Model Evaluation: Wald Test<a class="anchor" aria-label="anchor" href="#model-evaluation-wald-test"></a>
</h3>
<p>We can use the a Wald test to test both fixed effects parameters
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>)
and variance of the random parameters
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Λ</mi><annotation encoding="application/x-tex">\Lambda</annotation></semantics></math>).</p>
<p>The Wald test compares estimated parameters with null hypothesis
values. In the default case the null hypothesis is that value of the
parameters is 0.</p>
<p>In this default case, if the test fails to reject the null
hypothesis, removing the variables from the model will not substantially
harm the fit of that model.</p>
<p>One advantage of the Wald test is that it can be used to test
multiple hypotheses about multiple parameters simultaneously.</p>
<p>To test
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>q</mi><annotation encoding="application/x-tex">q</annotation></semantics></math>
hypotheses on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
estimated parameters, let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>P</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{P}</annotation></semantics></math>
be the vector of estimated coefficients,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
be a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>q</mi><annotation encoding="application/x-tex">q</annotation></semantics></math>
x
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
hypothesis matrix (this matrix has 1 row per coefficient being tested
with a value of 1 in the column corresponding to that coefficient),
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>V</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{V}</annotation></semantics></math>
be the estimated covariance matrix for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>P</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{P}</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
be the vector of hypothesized values for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>β</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\beta}</annotation></semantics></math>.</p>
<p>Then the Wald test statistic for multiple parameters is equal to:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>R</mi><mover><mi>β</mi><mo accent="true">̂</mo></mover><mo>−</mo><mi>r</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>′</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>R</mi><mover><mi>V</mi><mo accent="true">̂</mo></mover><mi>R</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>R</mi><mover><mi>β</mi><mo accent="true">̂</mo></mover><mo>−</mo><mi>r</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
W =(R\hat{\beta} - r)'(R\hat{V}R')^{-1}(R\hat{\beta} - r)
</annotation></semantics></math></p>
<p>The resulting test statistic can be tested against a chi-square
distribution. For this test, the degrees of freedom is the number of
parameters that are tested.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>∼</mo><msup><mi>χ</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex"> W \sim \chi^2(p) </annotation></semantics></math></p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Bates, D., Machler, M., Bolker, B. M., &amp; Walker, S. C. (2015),
Fitting linear mixed-effects models using lme4. <em>Journal of
Statistical Software</em>, <em>67</em>(<em>1</em>), 1–48.</p>
<p>Bates, D., &amp; Pinheiro, J. C. (1998). <em>Computational methods
for multilevel modelling.</em> Bell Labs Report.</p>
<p>Binder, D. A. (1983). On the variances of asymptotically normal
estimators from complex surveys. <em>International Statistical
Review</em>, <em>51</em>(<em>3</em>), 279–292.</p>
<p>Gelman, A. (2007). Struggles with survey weighting and regression
modeling. <em>Statistical Science</em>, <em>22</em>(<em>2</em>),
153–164.</p>
<p>Henderson, C. R. (1982). Analysis of covariance in the mixed model:
higher-level, nonhomogeneous, and random regressions.
<em>Biometrics</em>, <em>38</em>(<em>3</em>), 623–640.</p>
<p>Integration by Substitution. (n.d.). In Wikipedia. Retrieved February
13, 2019, from </p>
<p>Rabe-Hesketh, S., &amp; Skrondal, A. (2006). Multilevel modelling of
complex survey data. <em>Journal of the Royal Statistical Society</em>.
Series A (Statistics in Society), <em>169</em>(<em>4</em>), 805–827.</p>
<p>Rabe-Hesketh, S., Skrondal, A., &amp; Pickles, A. (2002). Reliable
estimation of generalized linear mixed models using adaptive quadrature.
<em>Stata Journal</em>, <em>2</em>, 1–21.</p>
<p>Trefethen, L. N., &amp; Bau, D. (1997). <em>Numerical linear
algebra</em>. Philadelphia, PA: SIAM.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Paul Bailey, Blue Webb, Claire Kelley, Trang Nguyen, Huade Huo.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>

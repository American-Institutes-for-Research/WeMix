<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<style>body{background-color:white;}</style>
<script src="lib/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="lib/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="lib/datatables-binding-0.19/datatables.js"></script>
<script src="lib/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="lib/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="lib/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="lib/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="lib/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet" />
<script src="lib/crosstalk-1.1.1/js/crosstalk.min.js"></script>
<link href="lib/highlight.js-6.2/rstudio.css" rel="stylesheet" />
<script src="lib/highlight.js-6.2/highlight.pack.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="lib/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<link href="lib/bootstrap-3.3.5/css/bootstrap-theme.min.css" rel="stylesheet" />
<script src="lib/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="lib/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="lib/bootstrap-3.3.5/shim/respond.min.js"></script>

</head>
<body>
<div class="container-fluid">
  <style type="text/css">table tr:hover td {
  font-weight:bold;text-decoration:none
}
table tr.covered td{
  background-color:rgba(95,151,68,0.3)
}

table tr:hover.covered .num{
  background-color:rgba(95,151,68,0.7)
}
table tr.missed td{
  background-color:rgba(185,73,71,0.3)
}
table tr:hover.missed .num{
  background-color:rgba(185,73,71,0.7)
}

table tr.missed:hover td{
  -webkit-box-shadow:0 -2px 0 0 #b94947 inset;
  -moz-box-shadow:0 -2px 0 0 #b94947 inset;
  box-shadow:0 -2px 0 0 #b94947 inset
}
table tr.covered:hover td{
  -webkit-box-shadow:0 -2px 0 0 #5f9744 inset;
  -moz-box-shadow:0 -2px 0 0 #5f9744 inset;
  box-shadow:0 -2px 0 0 #5f9744 inset
}

table tr.never td{
  background-color:transparent
}

table tbody {
  border-style: solid;
  border: 1px solid rgba(0,0,0,0.1)
}

table .num {
  border-right: 1px solid rgba(0,0,0,0.1)
}

td.coverage em {
  opacity: 0.5;
}

table td.coverage {
  border-right: 1px solid rgba(0,0,0,0.1);
  font-weight: bold;
  text-align: center;
}
table.table-condensed pre {
  background-color: transparent;
  margin: 0;
  padding: 0;
  border: 0;
  font-size: 11px;
}
div#files td {
  padding: 0;
  padding-left: 5px;
}

div#files td.num {
  padding-right: 5px;
}

table.table-condensed {
  font-size: 11px;
}</style>
  <div class="col-md-8 col-md-offset-2">
    <h2>WeMix coverage - 79.04%</h2>
    <div class="tabbable">
      <ul class="nav nav-tabs" data-tabsetid="covr">
        <li class="active">
          <a href="#tab-covr-1" data-toggle="tab" data-value="Files">Files</a>
        </li>
        <li>
          <a href="#tab-covr-2" data-toggle="tab" data-value="Source">Source</a>
        </li>
      </ul>
      <div class="tab-content" data-tabsetid="covr">
        <div class="tab-pane active" title="Files" data-value="Files" id="tab-covr-1">
          <div id="htmlwidget-fb5d21be474c50a4afe3" style="width:100%;height:500px;" class="datatables html-widget"></div>
          <script type="application/json" data-for="htmlwidget-fb5d21be474c50a4afe3">{"x":{"filter":"none","vertical":false,"fillContainer":true,"data":[["<a href=\"#\">R/drv.R<\/a>","<a href=\"#\">R/analyticSolve.R<\/a>","<a href=\"#\">R/adaptiveQuad.R<\/a>","<a href=\"#\">R/helpers.R<\/a>","<a href=\"#\">R/lnl.R<\/a>","<a href=\"#\">R/covarianceConstructors.R<\/a>","<a href=\"#\">R/zzz.R<\/a>"],[200,782,1520,362,293,65,4],[93,444,819,163,102,26,1],[59,342,638,127,86,23,1],[34,102,181,36,16,3,0],["160","2004","86","2","1641","782","2"],["63.44%","77.03%","77.90%","77.91%","84.31%","88.46%","100.00%"]],"container":"<table class=\"row-border fill-container\">\n  <thead>\n    <tr>\n      <th>File<\/th>\n      <th>Lines<\/th>\n      <th>Relevant<\/th>\n      <th>Covered<\/th>\n      <th>Missed<\/th>\n      <th>Hits / Line<\/th>\n      <th>Coverage<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"searching":false,"dom":"t","paging":false,"columnDefs":[{"targets":6,"createdCell":"function(td, cellData, rowData, row, col) {\n  var percent = cellData.replace(\"%\", \"\");\n  if (percent > 90) {\n    var grad = \"linear-gradient(90deg, #edfde7 \" + cellData + \", white \" + cellData + \")\";\n  } else if (percent > 75) {\n    var grad = \"linear-gradient(90deg, #f9ffe5 \" + cellData + \", white \" + cellData + \")\";\n  } else {\n    var grad = \"linear-gradient(90deg, #fcece9 \" + cellData + \", white \" + cellData + \")\";\n  }\n  $(td).css(\"background\", grad);\n}\n"},{"className":"dt-right","targets":[1,2,3,4]}],"order":[],"autoWidth":false,"orderClasses":false},"callback":"function(table) {\ntable.on('click.dt', 'a', function() {\n  files = $('div#files div');\n  files.not('div.hidden').addClass('hidden');\n  id = $(this).text();\n  files.filter('div[id=\\'' + id + '\\']').removeClass('hidden');\n  $('ul.nav a[data-value=Source]').text(id).tab('show');\n});\n}"},"evals":["options.columnDefs.0.createdCell","callback"],"jsHooks":[]}</script>
        </div>
        <div class="tab-pane" title="Source" data-value="Source" id="tab-covr-2">
          <div id="files">
            <div id="R/adaptiveQuad.R" class="hidden">
              <table class="table-condensed">
                <tbody>
                  <tr class="never">
                    <td class="num">1</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' Survey Weighted Mixed-Effects Models </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">2</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param formula  a formula object in the style of \code{lme4} that creates the model.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">3</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param data  a data frame containing the raw data for the model.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">4</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param weights a character vector of names of weight variables found in the data frame.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">5</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param cWeights logical, set to \code{TRUE} to use conditional weights. Otherwise, \code{mix} expects unconditional weights.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">6</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param center_group a list where the name of each element is the name of the aggregation level, and the element is a formula of</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">7</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'  variable names to be group mean centered; for example to group mean center gender and age within the group student:</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">8</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'   \code{list("student"= ~gender+age)}, default value of NULL does not perform any group mean centering. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">9</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param center_grand  a formula of variable names  to be grand mean centered, for example to center the variable education by overall mean of </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">10</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' education: \code{~education}. Default is NULL which does no centering. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">11</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param nQuad an optional integer  number of quadrature points to evaluate models solved by adaptive quadrature.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">12</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'  Only non-linear models are evaluated with adaptive quadrature. See notes for additional guidelines. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">13</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param max_iteration a optional integer, for non-linear models fit by adaptive quadrature which limits number of iterations allowed</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">14</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'   before quitting. Defaults  to 10. This is used because if the liklihood surface is flat, </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">15</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'   models may run for a very  long time without converging.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">16</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param run  logical; \code{TRUE} runs the model while \code{FALSE} provides partial output for debugging or testing. Only applies to non-linear</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">17</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'  models evaluated by adaptive quadrature. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">18</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param keepAdapting logical, set to \code{TRUE} when the adaptive quadrature should adapt after every Newton step. Defaults to \code{FALSE}. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">19</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \code{FALSE} should be used for faster (but less accurate) results. Only applies to non-linear models. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">20</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param verbose logical, default \code{FALSE}; set to \code{TRUE} to print results of intermediate steps of adaptive quadrature. Only applies to non-linear models.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">21</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param acc0 integer, the precision of \code{mpfr}, default 120. Only  applies to non-linear models. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">22</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param start optional numeric vector representing the point at which the model should start optimization; takes the shape of c(coef, vars) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">23</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' from results (see help). </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">24</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param family the family; optionally used to specify generalized linear mixed models. Currently only \code{binomial(link="logit")} is supported.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">25</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param fast logical; deprecated</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">26</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @description</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">27</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' Implements a survey weighted mixed-effects model using the provided formula. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">28</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @details</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">29</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' Linear models are solved using a modification of the analytic solution developed by Bates and Pinheiro (1998).</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">30</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' Non-linear models are solved using adaptive quadrature following the method in STATA's GLAMMM (Rabe-Hesketh &amp; Skrondal, 2006).</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">31</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' For additional details, see the vignettes \emph{Weighted Mixed Models: Adaptive Quadrature} and  \emph{Weighted Mixed Models: Analytical Solution} </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">32</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' which provide extensive examples as well as a description of the mathematical basis of the estimation procedure and comparisons to model </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">33</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' specifications in other common software. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">34</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' Notes: </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">35</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \itemize{</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">36</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item Standard errors of random effect variances are robust; see vignette for details. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">37</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item To see the function that is maximized in the estimation of this model, see the section on "Model Fitting" in the</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">38</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'  \emph{Introduction to Mixed Effect Models With WeMix} vignette.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">39</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item When all weights above the individual level are 1, this is similar to a \code{lmer} and you should use \code{lme4} </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">40</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' because it is much faster.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">41</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item If  starting coefficients are not provided they are estimated using \code{lme4}. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">42</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item For non-linear models, when the variance of a random effect is very low (&lt;.1), WeMix doesn't estimate it, because very </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">43</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' low variances create problems with  numerical evaluation. In these cases, consider estimating without that random effect. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">44</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'  \item The model is estimated by maximum likelihood estimation.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">45</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item To choose the number of quadrature points for non-linear model evaluation, a balance is needed between accuracy and</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">46</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' speed; estimation time increases quadratically with the number of points chosen. In addition, an odd number of points is </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">47</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' traditionally used. We recommend starting at 13 and increasing or decreasing as needed. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">48</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">49</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom lme4 getME lmer glmer lFormula</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">50</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom stats dnorm aggregate terms dpois dgamma dbinom ave model.matrix terms.formula as.formula sigma complete.cases</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">51</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom numDeriv genD hessian grad</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">52</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom minqa bobyqa </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">53</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom Matrix nearPD sparse.model.matrix</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">54</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @return object of class \code{WeMixResults}. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">55</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' This is a list with elements: </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">56</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{lnlf}{function, the likelihood function.} </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">57</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{lnl}{numeric, the log-likelihood of the model. }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">58</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{coef}{numeric vector, the estimated coefficients of the model. }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">59</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{ranefs}{the group-level random effects.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">60</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{SE}{the standard errors of the fixed effects, robust if robustSE was set to true.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">61</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{vars}{numeric vector, the random effect variances.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">62</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{theta}{the theta vector.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">63</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{call}{the original call used.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">64</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{levels}{integer, the number of levels in the model.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">65</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{ICC}{numeric, the intraclass correlation coefficient.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">66</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{CMODE}{the conditional mean of the random effects.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">67</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{invHessian}{inverse of the second derivative of the likelihood function.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">68</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{ICC}{the interclass correlation.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">69</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{is_adaptive}{logical, indicates if adaptive quadrature was used for estimation.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">70</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{sigma}{the sigma value.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">71</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{ngroups}{the number of observations in each group.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">72</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{varDF}{the variance data frame in the format of the variance data frame returned by lme4.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">73</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{varVC}{the variance-covariance matrix of the random effects.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">74</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{cov_mat}{the variance-covariance matrix of the fixed effects.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">75</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{var_theta}{the variance covariance matrix of the theta terms.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">76</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{wgtStats}{statistics regarding weights, by level.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">77</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @example \man\examples\mix.R</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">78</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @author Paul Bailey, Claire Kelley, and Trang Nguyen </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">79</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @export</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">80</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">mix &lt;- function(formula, data, weights, cWeights=FALSE, center_group=NULL,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">81</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                center_grand=NULL, max_iteration=10, nQuad=13L, run=TRUE,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">82</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                verbose=FALSE, acc0=120, keepAdapting=FALSE, start=NULL,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">83</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                fast=FALSE, family=NULL) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">84</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #############################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">85</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #                   Outline:                #   </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">86</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #     1) data preparation and reshaping     #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">87</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #    2) Identify integration parameters     #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">88</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #     3) Maximum Likelihood Estimation      #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">89</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #            4) Post Estimation             #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">90</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #############################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">91</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">92</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #############################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">93</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #              1) Data Preparation          #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">94</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #############################################</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">95</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  call &lt;- match.call()</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">96</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # check class and some requirements of arguments</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">97</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!inherits(formula, "formula")) stop(paste0("The argument ", sQuote("formula"), " must be a formula."))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">98</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!inherits(data, "data.frame")) stop(paste0("The argument ", sQuote("data"), " must be a data.frame."))  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">99</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(length(class(data)) &gt; 1) { </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">100</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    data &lt;- as.data.frame(data)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">101</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">102</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(nQuad &lt;= 0) stop(paste0("The argument ", sQuote("nQuad"), " must be a positive integer."))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">103</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!inherits(run, "logical")) stop(paste0("The argument ", sQuote("run"), " must be a logical."))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">104</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!inherits(verbose, "logical")) stop(paste0("The argument ", sQuote("verbose"), " must be a logical."))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">105</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!inherits(weights, "character")) stop(paste0("The argument ", sQuote("weights"), " must be a character vector of weight column names in ", sQuote("data"), "."))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">106</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(any(!weights %in% colnames(data))) stop(paste0("The argument ", sQuote("weights"), " must specify valid columns in ", sQuote("data"), "."))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">107</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(acc0 &lt;= 0) stop(paste0("The argument ", sQuote("acc0"), " must be a positive integer."))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">108</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!missing(fast)) warning(paste0("The ", sQuote("fast"), " argument is deprecated."))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">109</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(any(grepl("[|].*[.]",attributes(terms(formula))$term.labels))) stop("The formula is not valid for mix. The name of conditioning variables must not contain a dot. Try renaming variables after | in the fomrula so they do not contain a dot.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">110</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #currently wemix can only use complete cases</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">111</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #this removes any  incomplete cases if they exist </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">112</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(any(is.na(data[ , c(all.vars(formula), weights)]))) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">113</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    warning(paste0("There were ", sum(complete.cases(data)==FALSE), " rows with missing data. These have been removed."))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">114</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    data &lt;- data[complete.cases(data), ]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">115</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">116</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(length(weights) == 1) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">117</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # if the length of weights is 1 then below subsets on weights do not work.</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">118</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop(paste0("The argument ", sQuote("weights"), " must be a list of column names with length equal to levels."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">119</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">120</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #this removes any zero weight cases if they exist </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">121</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  data[apply(data[ , weights] &lt;= 0, 1, any), weights] &lt;- NA</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">122</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(any(is.na(data[ , weights]))) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">123</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    warning(paste0("There were ", sum(complete.cases(data)==FALSE), " rows with non-positive weights. These have been removed."))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">124</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    data &lt;- data[complete.cases(data), ]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">125</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">126</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">127</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # setup family</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">128</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # if family is set, use it</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">129</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!is.null(family)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">130</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(inherits(family, "character")) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">131</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      family &lt;- do.call(family, args=list())</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">132</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">133</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(!inherits(family, "family")) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">134</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      stop(paste0("The family argument must be of class ", dQuote("family"), "."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">135</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">136</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    family$lnl &lt;- switch(family$family,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">137</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      binomial = function(y, mu, w, sd) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">138</td>
                    <td class="coverage">3043<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   w * dbinom(x=y, size=rep(1,length(y)), prob=mu, log=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">139</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 },</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">140</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      poisson = function(y, mu, w, sd) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">141</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   w * dpois(x=y, lambda=mu, log=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">142</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 },</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">143</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      gaussian = function(y, mu, w, sd) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">144</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   w * dnorm(x=y, mean=mu, sd=sd, log=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">145</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 },</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">146</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Gamma = function(y, mu, w, sd) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">147</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">              stop("The gamma family is not implemented.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">148</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 },</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">149</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      inverse.gaussian = function(y, mu, w, sd) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">150</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   stop("The inverse Gaussian family is not implemented.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">151</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 },</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">152</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      function(y, mu, w, sd) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">153</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        stop(paste0("Unknown family."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">154</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">155</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    )</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">156</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">157</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">158</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # set up initial values </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">159</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  adapter &lt;- "MAP" # initial function evaluation through MAP, BLUE estimator can be used post hoc</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">160</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  weights0 &lt;- weights # keep track of incomming weights column names</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">161</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # correctly format acc0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">162</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  acc0 &lt;- round(acc0)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">163</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  nQuad &lt;- round(nQuad) #nquad must be an integer</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">164</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">165</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # get the group names (ie level 2+ variables) from the formula</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">166</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # start by getting the lme4 parsed formula</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">167</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lformula &lt;- lFormula(formula=formula, data=data)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">168</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # get the unparsed group names, this could include, e.g. a:b</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">169</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  unparsedGroupNames &lt;- names(lformula$reTrms$cnms)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">170</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # a function to parse group names</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">171</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  groupParser &lt;- function(groupi) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">172</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # have base::all.vars parse the group name</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">173</td>
                    <td class="coverage">31<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    all.vars(formula(paste0("~", groupi)))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">174</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">175</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">176</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # apply the parser to each random effect, and unique them</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">177</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  groupNames &lt;- rev(unique(unlist(lapply(unparsedGroupNames, groupParser))))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">178</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # reorder data by groups (in order to make Z matrix obtained from lme easier to work with)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">179</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  data &lt;- data[do.call(order, lapply(rev(groupNames), function(colN) data[ , colN])), ]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">180</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">181</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!is.null(center_group)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">182</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #first add nested variables to data set if they exist, this is to handle / and : in group vars</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">183</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if (any(grep(":|/", names(center_group)))) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">184</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      nested_groups &lt;- names(center_group)[grep(":|/", names(center_group))]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">185</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for (var in nested_groups){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">186</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        vars &lt;- unlist(strsplit(var , ":|/"))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">187</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        data[,var] &lt;- paste0(data[ , vars[1]], ":", data[ , vars[2]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">188</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">189</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } #end of if there are : and / </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">190</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(!all(names(center_group) %in% names(data))){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">191</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      stop("Not all centering group variables are found in the data set. ")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">192</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">193</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(name in names(center_group)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">194</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # loop is included here for centering at &gt;2 levels </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">195</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # we need to get variable names from model matrix becasue of factor transformations</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">196</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # remove the first element becasue it is the intercept</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">197</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">198</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # identify level--it is the minimum group to account for : and / specified groups</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">199</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        lev &lt;- min(which(groupNames %in% unlist(strsplit(name,":|/"))))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">200</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        X &lt;- sparse.model.matrix(center_group[[name]],data=data)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">201</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        vars &lt;- colnames(X)[-1]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">202</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        X &lt;- cbind(X, data[ , weights0[lev]])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">203</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        colnames(X)[ncol(X)] &lt;- weights0[lev]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">204</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # subtract group average from value and put back into data </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">205</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # including scaling factor that accoutns for the fact weights might not sum to 0 l</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">206</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        data[ , vars] &lt;- sapply(vars, function(var){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">207</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           X[ , var] - </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">208</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             ave(X[ , var] * X[ , weights0[lev]], data[ , name])/</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">209</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             (nrow(X)/sum(X[ , weights0[lev]]))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">210</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">211</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # only used for centering</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">212</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        rm(X)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">213</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } # end for(name in names(center_group))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">214</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } # end else for loop mean centering varibles </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">215</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } # end if(!is.null(center_group))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">216</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">   </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">217</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!is.null(center_grand)){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">218</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    X &lt;- sparse.model.matrix(center_grand, data=data)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">219</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    vars &lt;- colnames(X)[-1]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">220</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">221</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #subtract overall avvrage from value and put back into X </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">222</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    data[ , vars] &lt;- sapply(vars, function(var){X[ , var] - ave(X[ , var])})</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">223</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # only used for centering</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">224</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    rm(X)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">225</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">226</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">227</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # remove row names so that resorted order is used in lme model </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">228</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  row.names(data) &lt;- NULL</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">229</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">230</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # run lmer to get a ballpark fit and model structure information</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">231</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(is.null(family)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">232</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">233</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cat("Using lmer to get an approximate (unweighted) estimate and model structure.\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">234</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">235</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # warnings happen on e.g. near-singular solve and are not a concern</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">236</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    suppressWarnings(lme &lt;- lmer(formula, data, REML=FALSE))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">237</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">238</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">239</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cat("Using glmer to get an approximate (unweighted) estimate and model structure.\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">240</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">241</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    lme &lt;- glmer(formula, data, family=family)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">242</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">243</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # get y, test for validity</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">244</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  mf &lt;- model.frame(lme)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">245</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  responseCol &lt;- attributes(attributes(mf)$terms)$response</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">246</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  y &lt;- as.numeric(mf[ , responseCol])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">247</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!is.null(family) &amp;&amp; family$family == "binomial") {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">248</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(length(unique(y)) == 2) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">249</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      y &lt;- ifelse(y == min(y), 0, 1)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">250</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">251</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(any(!y %in% c(0,1))) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">252</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      stop("For a binomial model the outcomes must be 0 or 1.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">253</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">254</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">255</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # Get the Z (random effects) matrix from LME </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">256</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  model_matrix &lt;- getME(lme,"mmList")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">257</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">258</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  z_groups &lt;- names(model_matrix) #get full names random effects whcih include both variable and group level</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">259</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">260</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #now capture interactions</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">261</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  all_groups &lt;- names(summary(lme)$ngrps)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">262</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  groupNames &lt;- all_groups  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">263</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">264</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # store the full sample weights (or cWeights) in wgts0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">265</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  wgts0 &lt;- data[ , weights]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">266</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(cWeights) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">267</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(i in (ncol(wgts0)-1):1) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">268</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      wgts0[ , i] &lt;- wgts0[ , i] * wgts0[ , i+1]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">269</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">270</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">271</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # check if weights are potentially conditional</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">272</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">273</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # create columns for any interactions coming from the formula</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">274</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # this will be mainly used in 3 level models and is included for forward compatability </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">275</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  missingGroupVars &lt;- all_groups[!all_groups %in% names(data)] #find which group names are not in data set (ie composite groups)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">276</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">277</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # drop levels of factors in present vars</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">278</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  presentVars &lt;- all_groups[all_groups %in% names(data)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">279</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in seq_along(presentVars)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">280</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(inherits(data[, presentVars[i]], "factor")) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">281</td>
                    <td class="coverage">22<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      data[, presentVars[i]] &lt;- droplevels(data[, presentVars[i]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">282</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">283</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">284</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">285</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # the lowest level, assumed to be the grouping var,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">286</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # but updated when not in "if (length(missingGroupVars)&gt;0){" loop</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">287</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  all_groups_lowest_level &lt;- all_groups</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">288</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">289</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # for each missing group var</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">290</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(mgi in seq_along(missingGroupVars)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">291</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #transform interactions into thier componenet parts</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">292</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    vars &lt;- rownames(attr(terms.formula(as.formula(paste(". ~", paste(missingGroupVars[mgi], collapse="+"))) ), "factors"))[-1]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">293</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # drop levels on vars in missing groups</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">294</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(i in seq_along(vars)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">295</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(inherits(data[, vars[i]], "factor")) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">296</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        data[, vars[i]] &lt;- droplevels(data[, vars[i]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">297</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">298</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">299</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    data[ , missingGroupVars[mgi]] &lt;- apply(data[ , vars], 1, function(x) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">300</td>
                    <td class="coverage">540<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                        paste(x, collapse=":")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">301</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                      }) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">302</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # this is a composite term, use the final </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">303</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    vtab &lt;- lapply(vars, function(x) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">304</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              tab &lt;- table(data[ , x])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">305</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              sum(tab&gt;0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">306</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            })</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">307</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    all_groups_lowest_level[all_groups_lowest_level == all_groups[mgi]] &lt;- vars[which.max(unlist(vtab))]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">308</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">309</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">310</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # prepare Z matrices for each level </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">311</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Z &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">312</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # Z is de-duplicated. ZFull is always the size of the outcome vector</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">313</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">314</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ZFull &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">315</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  n_rows &lt;- nrow(data)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">316</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for (i in 1:length(all_groups)){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">317</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    z_to_merge &lt;- grepl(paste0("[|]\\W", all_groups[i], "$"), z_groups)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">318</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Z_i &lt;- matrix( unlist(model_matrix[z_to_merge], use.names=FALSE), nrow=n_rows)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">319</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ZFull &lt;- c(ZFull, list(Z_i))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">320</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(i &gt; 1) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">321</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Z_i &lt;- Z_i[!duplicated(data[ , all_groups[i-1]]), , drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">322</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">323</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Z &lt;- c(Z, list(Z_i))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">324</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">325</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">326</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # find number of random effects classes</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">327</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  nz &lt;- list(0) # there are not REs at level 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">328</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in 1:length(Z)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">329</td>
                    <td class="coverage">45<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(!is.null(Z[[i]])) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">330</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      nz[[i]] &lt;- ncol(Z[[i]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">331</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">332</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">333</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">334</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #calculate n levels from Z and warn if not the same dimension as weights </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">335</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  levels &lt;- length(Z)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">336</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(length(weights) != levels) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">337</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop(paste0("The argument ", sQuote("weights"), " must be a list of column names with length equal to levels."))  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">338</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">339</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">340</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # transform weights into a list of  dataframes where each data frame has</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">341</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # columns representing unit weight at that level and index of group names </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">342</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  weights &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">343</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in 1:length(nz)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">344</td>
                    <td class="coverage">45<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    df &lt;- data.frame(w=unname(wgts0[ , i]), stringsAsFactors=FALSE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">345</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # add the index for this level, when there is one</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">346</td>
                    <td class="coverage">45<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(i &lt; length(nz)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">347</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      df$indexp1 &lt;- data[ , all_groups[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">348</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">349</td>
                    <td class="coverage">45<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(i &gt; 1) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">350</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # for levels &gt;1 data frame indexed by group name and values represent weights </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">351</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      df$index &lt;- data[ , all_groups[i-1]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">352</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # return 0 var if there is only one unit</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">353</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      rvar &lt;- function(x) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">354</td>
                    <td class="coverage">389<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(length(x) &lt;=1) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">355</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          return(0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">356</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">357</td>
                    <td class="coverage">389<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          return(var(x))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">358</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">359</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">360</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      agg &lt;- aggregate(w ~ index, data=df, FUN=rvar)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">361</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(any(agg$w &gt; sqrt(.Machine$double.eps))) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">362</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        stop(paste0("Some level-", i+1, " weights vary within group."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">363</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">364</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      df &lt;- df[!duplicated(df$index), ]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">365</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">366</td>
                    <td class="coverage">45<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    weights[[i]] &lt;- df</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">367</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">368</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #get the y variable name from the formula </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">369</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  y_label &lt;- as.character(formula[[2]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">370</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">371</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # get lmer fixed effects and covariance terms</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">372</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  k &lt;- length(lmeb &lt;- getME(lme, "fixef"))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">373</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  parlme &lt;- c(lmeb)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">374</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lmesummary &lt;- summary(lme)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">375</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # find number of unique groups </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">376</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ngrp &lt;- lmesummary$ngrps</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">377</td>
                    <td class="coverage">19<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(length(unique(ngrp)) != length(ngrp)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">378</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # if non-nested groups are present (ie not all obs at lower levels are part of upper level groups) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">379</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # then there will be non unique entries in ngrp </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">380</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop("This does not appear to be a nested model. Some levels of this model have the same number of subject/groups as the level above them.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">381</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">382</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ngrpW &lt;- lapply(weights, function(wdf) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">383</td>
                    <td class="coverage">42<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(list(mean=mean(wdf$w), sum=sum(wdf$w), min=min(wdf$w), max=max(wdf$w))) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">384</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">385</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">386</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # set up variance and coefficients </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">387</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lmeVarDF &lt;- data.frame(lmesummary$varcor)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">388</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  parlme &lt;- c(parlme, lmeVarDF$vcov)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">389</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">390</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # use initial values for coefficients if they are provied, otherwise default to lme4</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">391</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(is.null(start)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">392</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    est0 &lt;- parlme</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">393</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">394</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(length(start) != length(parlme)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">395</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      stop(paste0("Expecting argument ", sQuote("start"), " to have ", length(est0), " elements, found ", length (start), " elements."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">396</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">397</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    est0 &lt;- start</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">398</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    names(est0) &lt;- names(parlme)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">399</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">400</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">401</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # prepare variance data frame</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">402</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # rename groups in var-cov matrix to be all distinct </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">403</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ind &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">404</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  while(sum(grepl(paste0("\\.", ind, "$"), lmeVarDF$grp)) &gt; 0) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">405</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    lmeVarDF$grp &lt;- sub(paste0("\\.", ind, "$"), "", lmeVarDF$grp)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">406</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ind &lt;- ind + 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">407</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">408</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lmeVarDF$sdcor &lt;- NULL # remove extraneous column</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">409</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lmeVarDF$ngrp &lt;- NA</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">410</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lmeVarDF$grp &lt;- gsub(".", ":", lmeVarDF$grp, fixed=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">411</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">412</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # add column showing how many elements are in each group</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">413</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(vari in 1:nrow(lmeVarDF)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">414</td>
                    <td class="coverage">48<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(lmeVarDF$grp[vari] == "Residual") {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">415</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lmeVarDF$ngrp[vari] &lt;- nrow(data)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">416</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">417</td>
                    <td class="coverage">31<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lmeVarDF$ngrp[vari] &lt;- ngrp[names(ngrp) == lmeVarDF$grp[vari]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">418</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">419</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">420</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">421</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # add column indicating which model level each group belongs to</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">422</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ngrp2 &lt;- rev(sort(unique(lmeVarDF$ngrp)))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">423</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(grpi in 1:length(ngrp2)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">424</td>
                    <td class="coverage">41<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    lmeVarDF$level[ngrp2[grpi] == lmeVarDF$ngrp] &lt;- grpi + ifelse("Residual" %in% lmeVarDF$grp, 0, 1) # add 1 if no residual</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">425</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">426</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varCorrect &lt;- is.na(lmeVarDF$var2) &amp; lmeVarDF$vcov &lt; 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">427</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(any(varCorrect)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">428</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    lmeVarDF$vcov[varCorrect] &lt;- pmax(log(lmeVarDF$vcov[varCorrect]) + 1, -3.59)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">429</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">430</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # add names to the variance terms of the paramter vector</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">431</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  names(est0)[-(1:k)] &lt;- lmeVarDF$grp</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">432</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">433</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #add full variable name to lmeVarDF for later use </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">434</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lmeVarDF$fullGroup &lt;- paste0(lmeVarDF$grp, ifelse(!is.na(lmeVarDF$var1), paste0(".", lmeVarDF$var1), ""))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">435</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">436</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # use helper funtion to create a covariance matrix from the data frame with variance and covariance information</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">437</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  covarianceConstructor &lt;- covMat2Cov(lmeVarDF)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">438</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">439</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # C is the realization of the covariance constructor</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">440</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  C &lt;- covarianceConstructor(est0[-(1:k)])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">441</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # these are the realized y/X vector/matrix</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">442</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  X &lt;- getME(lme, "X")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">443</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">444</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ##############################################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">445</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #   2a) Pass linear models to symbolic integration method    #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">446</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ##############################################################</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">447</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(is.null(family)){</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">448</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #get the raw Z matrix</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">449</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Z &lt;- getME(lme, "Z")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">450</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #extract Zt from lme and transpose to Z  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">451</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    temp_Z &lt;- getME(lme, "Ztlist")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">452</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #find out which level each applies to </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">453</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    z_levels &lt;- unique(lmeVarDF[lmeVarDF$fullGroup%in%names(temp_Z),c("fullGroup","level")])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">454</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Zlist &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">455</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for (i in 2:levels){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">456</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      z_names &lt;- z_levels[z_levels$level==i,"fullGroup"]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">457</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Zlist[[i-1]] &lt;- Matrix::t(do.call(rbind, temp_Z[z_names]))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">458</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #Zlist[[i-1]] &lt;- t(as.matrix((Reduce(rbind, temp_Z[z_names]))))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">459</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">460</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #seperating into single random effects using the pointers</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">461</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    pointers &lt;- getME(lme, "Gp")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">462</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">463</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #find levels at which z applies</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">464</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    grp_level &lt;- lmeVarDF$level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">465</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    names(grp_level) &lt;- lmeVarDF$grp</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">466</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">467</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ref_comps &lt;- names(getME(lme, "cnms"))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">468</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Zlevels &lt;- unique(grp_level[ref_comps])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">469</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">470</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">   </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">471</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # group id needs to be incremetally increasing starting at 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">472</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # as factor then as numeric should take care of this; also store a crosswalk</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">473</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    group_id_list &lt;- lapply(all_groups, FUN=function(x){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">474</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      res &lt;- data.frame(data[,x], as.numeric(as.factor(data[,x])))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">475</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      colnames(res) &lt;- c(x, "index")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">476</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      res</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">477</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">478</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # this as one big matrix</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">479</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    group_id &lt;- do.call(cbind, group_id_list)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">480</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    cn &lt;- c()</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">481</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # give group_id good names; necessary for : and / to work</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">482</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    names(all_groups) &lt;- make.names(all_groups)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">483</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(i in 1:length(all_groups)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">484</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cn &lt;- c(cn, all_groups[i], paste0(all_groups[i], "_index"))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">485</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">486</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    colnames(group_id) &lt;- cn</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">487</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    group_id &lt;- group_id[ , c(all_groups, paste0(all_groups, "_index"))]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">488</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    weights_list &lt;- lapply(1:length(weights), FUN=function(wi) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">489</td>
                    <td class="coverage">40<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(wi == 1) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">490</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # sort by incoming index, so no resorting</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">491</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        return(weights[[wi]]$w)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">492</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">493</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # not lowest level, sort by numeric(factor())</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">494</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      x &lt;- weights[[wi]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">495</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      x &lt;- x[order( as.numeric(as.factor(x$index)) ), ]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">496</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      x$w</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">497</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">498</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">499</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # if level &gt;2 then set up conditional weigths</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">500</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    weights_list_cond &lt;- weights_list</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">501</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(levels &gt; 2 ){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">502</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cWeights &lt;- cbind(group_id, data[ , weights0])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">503</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for (level in 1:(levels-1)){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">504</td>
                    <td class="coverage">12<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        cWeights[ , weights0[level]] &lt;- cWeights[ , weights0[level]] / cWeights[ , weights0[level + 1]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">505</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">506</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      weights_list_cond[[1]] &lt;- cWeights[ , weights0[1]] #first level weights dont get grouped </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">507</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">508</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for (level in 2:levels){</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">509</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # grab the first element, sorted as the data came</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">510</td>
                    <td class="coverage">12<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        weights_list_cond[[level]] &lt;- cWeights[!duplicated(cWeights[,all_groups[level-1]]), weights0[level]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">511</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">512</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">513</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    theta &lt;- getME(lme, "theta")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">514</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    theta1 &lt;- theta</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">515</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(i in 1:length(theta1)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">516</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      theta1[i] &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">517</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">518</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    group_id &lt;- group_id[ , c(paste0(all_groups, "_index"), all_groups)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">519</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    bsqG &lt;- devG(y, X, Zlist=Zlist, Zlevels=Zlevels, weights=weights_list, weightsC = weights_list_cond,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">520</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 groupID = group_id,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">521</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 lmeVarDF = lmeVarDF,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">522</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 v0=theta1)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">523</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">524</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      message("Fitting weighted model.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">525</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">526</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">527</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    opt &lt;- bobyqa(fn=bsqG, par=theta)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">528</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">529</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    names(opt$par) &lt;- names(theta)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">530</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">531</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #opt$par are the theta estimates</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">532</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    bsq &lt;- bsqG(opt$par, getBS=TRUE) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">533</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">534</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">535</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      message("Estimating covariance.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">536</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">537</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    bhatq &lt;- bsq(opt$par, robustSE=TRUE) #calculate robust SE</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">538</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    b2 &lt;- function(f, optpar, b, sigma0, inds) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">539</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      function(x) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">540</td>
                    <td class="coverage">387<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        sigma &lt;- x[length(x)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">541</td>
                    <td class="coverage">387<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        x &lt;- x[-length(x)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">542</td>
                    <td class="coverage">387<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xp &lt;- optpar</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">543</td>
                    <td class="coverage">387<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xp[inds] &lt;- x</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">544</td>
                    <td class="coverage">387<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        names(xp) &lt;- names(optpar)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">545</td>
                    <td class="coverage">387<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        f(v=xp, sigma=sigma, beta=b)$lnl</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">546</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">547</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">548</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varDF &lt;- lmeVarDF[,c("grp", "var1", "var2", "vcov", "ngrp", "level")]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">549</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varVC &lt;- list(Residual=bhatq$sigma^2)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">550</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varDF$vcov &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">551</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varDF$SEvcov &lt;- NA</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">552</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #set up list jaccobian of gradient for post hoc wald test</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">553</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    j_mat_list &lt;- list() #set up to hold jaccobian </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">554</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(li in 2:levels) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">555</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      iDelta &lt;- bhatq$iDelta[[li]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">556</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      iDeltai &lt;- bhatq$sigma^2 * (iDelta %*% t(iDelta))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">557</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # varDF for just this level, this is a temp df that is used just in this loop and then not stored</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">558</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      varDFi &lt;- varDF[varDF$level %in% c(li,1),]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">559</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # names of the thetas, minus the sigma term which we add back manually when needed</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">560</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      thetaNamesi &lt;- ifelse(is.na(varDFi$var2), paste0(varDFi$grp,".", varDFi$var1), paste0(varDFi$grp, ".", varDFi$var2, ".", varDFi$var1))[-nrow(varDFi)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">561</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      inds &lt;- names(opt$par) %in% thetaNamesi</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">562</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      ihes &lt;- -1*getHessian(b2(f=bsq, optpar=opt$par, b=bhatq$b, sigma0=bhatq$sigma, inds=inds),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">563</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                           x=c(opt$par[inds], sigma=bhatq$sigma))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">564</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      eihes &lt;- eigen(ihes)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">565</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(max(eihes$values)/min(eihes$values) &lt;= 400*sqrt(.Machine$double.eps)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">566</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        warning("Numerical instability in estimating the standard error of variance terms. Consider the variance term standard errors approximate.")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">567</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ihes &lt;- nearPD(ihes,  posd.tol=400*sqrt(.Machine$double.eps))$mat</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">568</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">569</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      theta_cov_mat &lt;- solve(ihes)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">570</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      colnames(theta_cov_mat) &lt;- rownames(theta_cov_mat) &lt;- c(names(opt$par[inds]),"sigma")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">571</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      J &lt;- bhatq$Jacobian[rownames(theta_cov_mat), colnames(theta_cov_mat)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">572</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      preVCi &lt;- theta_cov_mat %*% J %*% theta_cov_mat</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">573</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # reorder to be in the same order as varDFi</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">574</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      preVCi &lt;- preVCi[c(thetaNamesi, "sigma"), c(thetaNamesi, "sigma")]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">575</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cn &lt;- colnames(iDeltai)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">576</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      sigma2 &lt;- bhatq$sigma^2</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">577</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      j_list &lt;-  list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">578</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(ii in 1:nrow(iDeltai)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">579</td>
                    <td class="coverage">29<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(jj in ii:ncol(iDeltai)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">580</td>
                    <td class="coverage">35<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          varDFi$grad &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">581</td>
                    <td class="coverage">35<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          if(ii==jj) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">582</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # diagonal element, so it is a variance</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">583</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # at this level, var1 is the column, and var2 is NA means it is a variance</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">584</td>
                    <td class="coverage">29<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            varDF[varDF$level==li &amp; varDF$var1==cn[ii] &amp; is.na(varDF$var2),"vcov"] &lt;- iDeltai[ii,ii]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">585</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # claculate the variance of the variance. let g = grad(iDeltai[ii,ii]) wrt the elements or iDelta and sigma2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">586</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # diagonal element</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">587</td>
                    <td class="coverage">29<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            varDFi$grad[varDFi$var1 %in% rownames(iDelta)[ii] &amp; is.na(varDFi$var2)] &lt;- sigma2 * 2 * iDelta[ii,ii]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">588</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # off-diagonal elements are needed when ii &gt; 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">589</td>
                    <td class="coverage">29<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            if(ii &gt; 1){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">590</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              for(iii in 1:(ii-1)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">591</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                varDFi$grad[(varDFi$var1 %in% rownames(iDelta)[ii] | varDFi$var2 %in% rownames(iDelta)[ii]) &amp; (varDFi$var1 %in% rownames(iDelta)[iii] | varDFi$var2 %in% rownames(iDelta)[iii])] &lt;- sigma2 * 2 * iDelta[ii,iii]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">592</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">593</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">594</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # part of grad that is sigma</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">595</td>
                    <td class="coverage">29<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            varDFi$grad[nrow(varDFi)] &lt;- 2 * iDeltai[ii,ii]/sqrt(sigma2)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">596</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # this is the Taylor series gT %*% [VC of iDelta] %*% g</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">597</td>
                    <td class="coverage">29<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            varDF[varDF$level==li &amp; varDF$var1==cn[ii] &amp; is.na(varDF$var2),"SEvcov"] &lt;- sqrt(t(varDFi$grad) %*% preVCi %*% varDFi$grad)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">598</td>
                    <td class="coverage">29<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            j_list &lt;- c(j_list,list(varDFi$grad))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">599</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          } else {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">600</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # off-diagonal element, so it is a covariance</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">601</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            varDF[varDF$level %in% li &amp; varDF$var1 %in% cn[ii] &amp; varDF$var2 %in% cn[jj],"vcov"] &lt;- iDeltai[ii,jj]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">602</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            varDF[varDF$level %in% li &amp; varDF$var1 %in% cn[jj] &amp; varDF$var2 %in% cn[ii],"vcov"] &lt;- iDeltai[ii,jj]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">603</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # only if we calculate this term, this could also be iDeltai[ii,jj] == 0, but that could happen when fit</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">604</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            if(any(varDF$level==li &amp; (( varDF$var1==cn[ii] &amp; varDF$var2 %in% cn[jj]) | (varDF$var1==cn[jj] &amp; varDF$var2 %in% cn[ii])))) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">605</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              # claculate the variance of the variance. let g = grad(iDeltai[ii,ii]) wrt the elements or iDelta and sigma2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">606</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              # here the term is sigma2 * sum_{k=1}^{min(ii,jj)} (iDelta[ii,k] * iDelta[jj,k])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">607</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              for(iii in 1:min(ii, jj)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">608</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                # the derivative wrt iDelta[ii,k] is sigma2 * iDelta[jj,k]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">609</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                # since diagonal elements are on varDFi with var2=NA, not var2=var1, they need special handeling</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">610</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                if(ii == iii) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">611</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  varDFi$grad[(varDFi$var1 %in% rownames(iDelta)[ii] | varDFi$var2 %in% rownames(iDelta)[ii]) &amp; is.na(varDFi$var2)] &lt;- sigma2 * iDelta[jj,iii]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">612</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">613</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  varDFi$grad[(varDFi$var1 %in% rownames(iDelta)[ii] | varDFi$var2 %in% rownames(iDelta)[ii]) &amp; (varDFi$var1 %in% rownames(iDelta)[iii] | varDFi$var2 %in% rownames(iDelta)[iii])] &lt;- sigma2 * iDelta[jj,iii]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">614</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">615</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                # the derivative wrt iDelta[jj,k] is sigma2 * iDelta[ii,k]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">616</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                if(jj == iii) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">617</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  varDFi$grad[(varDFi$var1 %in% rownames(iDelta)[jj] | varDFi$var2 %in% rownames(iDelta)[jj]) &amp; is.na(varDFi$var2)] &lt;- sigma2 * iDelta[ii,iii]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">618</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">619</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  varDFi$grad[(varDFi$var1 %in% rownames(iDelta)[jj] | varDFi$var2 %in% rownames(iDelta)[jj]) &amp; (varDFi$var1 %in% rownames(iDelta)[iii] | varDFi$var2 %in% rownames(iDelta)[iii])] &lt;- sigma2 * iDelta[ii,iii]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">620</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                } </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">621</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">622</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              # part of grad that is sigma</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">623</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              varDFi$grad[nrow(varDFi)] &lt;- 2 * iDeltai[ii,jj]/sqrt(sigma2)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">624</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              # this is the Taylor series gT %*% [VC of iDelta] %*% g</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">625</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              varDF[varDF$level==li &amp; (( varDF$var1==cn[ii] &amp; varDF$var2 %in% cn[jj]) | (varDF$var1==cn[jj] &amp; varDF$var2 %in% cn[ii])),"SEvcov"] &lt;- sqrt(t(varDFi$grad) %*% preVCi %*% varDFi$grad)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">626</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              #build Jaccobian of gradient for use in post hoc wald test </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">627</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              j_list &lt;- c(j_list,list(varDFi$grad))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">628</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">629</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">630</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">631</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">632</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">633</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      jacobian &lt;- matrix(unlist(j_list),ncol=length(j_list[[1]]),byrow=T)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">634</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">635</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      var_mat_var &lt;-  jacobian %*% preVCi %*% t(jacobian)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">636</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # add names - theta has names in   correct order so subset based on theta names also in this level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">637</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      rownames(var_mat_var) &lt;-colnames(var_mat_var)   &lt;-  names(theta)[names(theta) %in% rownames(preVCi)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">638</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      j_list &lt;-  list()  #re set for next level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">639</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      j_mat_list[[li-1]] &lt;- var_mat_var</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">640</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">641</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # one could calculate var(residual) at every level. Prefer level-2</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">642</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(li==2) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">643</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        varDF[varDF$level==1,"SEvcov"] &lt;- sqrt((2*sqrt(sigma2))^2*preVCi[nrow(preVCi),ncol(preVCi)])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">644</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">645</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      varVC &lt;- c(varVC, list(iDeltai))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">646</td>
                    <td class="coverage">23<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      names(varVC)[li] &lt;- (varDF$grp[varDF$level %in% li])[1]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">647</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">648</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    var_of_var &lt;- bdiag(j_mat_list)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">649</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">650</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    rownames(var_of_var) &lt;- colnames(var_of_var)  &lt;- unlist(sapply(j_mat_list,FUN=rownames))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">651</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #get names from names of j_mat_list </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">652</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varDF$vcov[varDF$grp=="Residual"] &lt;- bhatq$sigma^2</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">653</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varDF$fullGroup &lt;- paste0(varDF$grp,ifelse(!is.na(varDF$var1),paste0(".",varDF$var1),""))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">654</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">655</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    vars &lt;- varDF$vcov[is.na(varDF$var2)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">656</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    names(vars) &lt;- varDF$fullGroup[is.na(varDF$var2)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">657</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">658</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # other output stats</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">659</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    nobs &lt;- nrow(X)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">660</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    names(nobs) &lt;- "Number of obs"</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">661</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ngroups &lt;- c(nobs, ngrp)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">662</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">663</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #Calculate ICC </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">664</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    var_between &lt;- sum(varDF[which(!is.na(varDF$var1) &amp; is.na(varDF$var2)),"vcov"])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">665</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    var_within &lt;- varDF$vcov[varDF$grp=="Residual"]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">666</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ICC &lt;- var_between/(var_between+var_within)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">667</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">668</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # for backwards compatibility with EdSurvey 2.2.2</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">669</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    env &lt;- environment(bsq)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">670</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #covCon &lt;- get("cConstructor", env)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">671</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #lmeVarDf &lt;- get("covMat", environment(covCon))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">672</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    covMat &lt;- env$lmeVarDF</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">673</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    cc &lt;- function() {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">674</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">675</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    assign("cConstructor", value=cc, envir=env)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">676</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">677</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">678</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # now build the results</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">679</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    res &lt;-list(lnlf=bsq, lnl= bhatq$lnl, coef = bhatq$b, ranefs=bhatq$ranef,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">680</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               SE = bhatq$seBetaRobust, </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">681</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               vars= vars,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">682</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               theta=bhatq$theta, call=call,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">683</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               levels=levels, CMODE=bhatq$ranef,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">684</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               invHessian=bhatq$cov_mat, ICC=ICC,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">685</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               is_adaptive=FALSE, sigma=bhatq$sigma, cov_mat=bhatq$varBetaRobust,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">686</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               ngroups=ngroups, varDF=varDF, varVC=varVC,var_theta=var_of_var,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">687</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               wgtStats=ngrpW)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">688</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    class(res) &lt;- "WeMixResults"</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">689</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">690</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">691</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">692</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ##############################################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">693</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # 2b) Identify integration parameter for non linear models  #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">694</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ##############################################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">695</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">696</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">697</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    cat("Identifying initial integration locations estimates for random effects.\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">698</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">699</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">700</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # setup these methods that, theoretically, can be used to find the </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">701</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # adaptive integration points. For now, only MAP works.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">702</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # Note: MAP finds the maximum of the likelihood surface.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">703</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # it is not, properly, a MAP</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">704</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">705</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  MAP0 &lt;- MAP(groups=data[ , all_groups, drop=FALSE], y=y, X=X, levels=levels,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">706</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              Z=Z, ZFull=ZFull, weights=weights, k=k,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">707</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              qp=gauss.quad(nQuad, "hermite"),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">708</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              covariance_constructor=covarianceConstructor, verbose=verbose,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">709</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              nlmevar=nrow(lmeVarDF)-1, nz=nz, acc=acc0, family=family)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">710</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # notes: BLUE finds the expected value of the likelihood surface</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">711</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # it is not, properly, a BLUE</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">712</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  BLUE0 &lt;- BLUE(groups=data[,all_groups,drop=FALSE], y=y, X=X, levels=levels,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">713</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                Z=Z, ZFull=ZFull, weights=weights, k=k,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">714</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                qp=gauss.quad(nQuad, "hermite"),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">715</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                covariance_constructor=covarianceConstructor, verbose=verbose,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">716</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                nlmevar=nrow(lmeVarDF)-1, nz=nz, acc=acc0, family=family)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">717</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">718</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # form omega0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">719</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # omega0 is a list of matricies where each list element represents a level</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">720</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # each matrix column represents the value of b for all units at the level </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">721</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  bvec &lt;- getME(lme, "b") #get b values from lme results</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">722</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  bvecCuts &lt;- getME(lme, "Gp") #find out indices corresponding to different levels</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">723</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  blist &lt;- vector("list", levels) # NULL for level 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">724</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">725</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #startLoc helps transform the z vector into a z matrix, starting from the beginning ( index of 1)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">726</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  startLoc &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">727</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">728</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # number of rows that the Z matrix has at level (l-1), skipped 1 here</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">729</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # this is used exclusively to form bmat</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">730</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # the issue is that bvecCuts doesn't have cuts for factor levels</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">731</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # the n_rows_z code fixes thatS</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">732</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  comps &lt;- names(getME(lme,"cnms")) #has same n as bvec and tells you group and var</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">733</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  n_rows_z &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">734</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for (i in 1:length(comps)){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">735</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    n_rows_z[i] &lt;- lmeVarDF[lmeVarDF$grp == comps[i],"ngrp"][1]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">736</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">737</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">738</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #forming matrixes of b values </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">739</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  blist &lt;- vector("list", levels) # NULl for level 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">740</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(cuti in 2:length(bvecCuts)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">741</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    bmat &lt;- matrix(bvec[startLoc:bvecCuts[cuti]], nrow=n_rows_z[[cuti-1]])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">742</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    li &lt;- unique(lmeVarDF$level[lmeVarDF$ngrp==nrow(bmat)])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">743</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    blist[[li]] &lt;- cbind(blist[[li]], bmat)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">744</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    startLoc &lt;- bvecCuts[cuti] + 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">745</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">746</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">747</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  omega0 &lt;- blist</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">748</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">749</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # make MAP estimate with b values and parameter estimates </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">750</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  a0 &lt;- MAP0(omega0=omega0, par0=est0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">751</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">752</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # add determinant to scale z values</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">753</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # created the adapted quadrature locaiton by moving original points based on curvature Q</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">754</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # follows equation of Hartzel et al, pg 87 (Reference in main vignette)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">755</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  zScale &lt;- lapply(a0$Qi0, function(Qi0i) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">756</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     if(is.null(Qi0i)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">757</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                       return(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">758</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">759</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     df &lt;- data.frame(detQ=sapply(Qi0i,det))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">760</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     # add group labels</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">761</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     for(i in 1:length(groupNames)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">762</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                       if(length(unique(data[,groupNames[i]])) == nrow(df)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">763</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         df[,groupNames[i]] &lt;- unique(data[,groupNames[i]])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">764</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         attr(df,"groups") &lt;- c(attr(df, "groups"), groupNames[i])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">765</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                       }  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">766</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">767</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     df</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">768</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">769</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">770</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  index &lt;- data.frame(data[,c(groupNames)])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">771</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  names(index) &lt;- groupNames</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">772</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #add column with determinant of Q to the Z infomration (join by index which is group name)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">773</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(wi in 2:length(weights)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">774</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Zgrps &lt;- attr(zScale[[wi]], "groups")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">775</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    weights[[wi]] &lt;- merge(weights[[wi]],zScale[[wi]][,c(Zgrps, "detQ")],by.x="index", by.y=Zgrps)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">776</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">777</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">778</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # first guess</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">779</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  est &lt;- est0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">780</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">781</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # use lnl function to optimize</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">782</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  qp &lt;- gauss.quad(nQuad,"hermite")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">783</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # the covariance constructor maps the variance terms that are less than 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">784</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # to exp(x-1) to avoid negative variance terms.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">785</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # fn0 does not use this map and can be easily used by the user</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">786</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # fn0R does use that map and is intended for use by the optimizer</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">787</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # these calls are otherwise identical.</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">788</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  fn0 &lt;- param.lnl.quad(y=y,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">789</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        X=X,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">790</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        levels=levels,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">791</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        Z=Z,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">792</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        ZFull=ZFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">793</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        Qi=a0$Qi,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">794</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        QiFull=a0$QiFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">795</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        omega=a0$omega,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">796</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        omegaFull=a0$omegaFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">797</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        W=weights,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">798</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        k=k,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">799</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        qp=qp,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">800</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        cConstructor=covarianceConstructor,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">801</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        acc0=acc0,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">802</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        mappedDefault=FALSE,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">803</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        family=family)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">804</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">805</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  fn0R &lt;- param.lnl.quad(y=y,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">806</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         X=X,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">807</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         levels=levels,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">808</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         Z=Z,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">809</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         ZFull=ZFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">810</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         Qi=a0$Qi,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">811</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         QiFull=a0$QiFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">812</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         omega=a0$omega,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">813</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         omegaFull=a0$omegaFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">814</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         W=weights,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">815</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         k=k,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">816</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         qp=qp,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">817</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         cConstructor=covarianceConstructor,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">818</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         acc0=acc0,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">819</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         mappedDefault=TRUE, </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">820</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         family=family)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">821</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">822</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!run) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">823</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # if run option is false the function terminates here, returning the components used in the optimization</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">824</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # without performing the optimization</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">825</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(list(lnlf=fn0R, parlme=parlme, omega0=a0$omega0, lme=lme, adapt=a0, weights=weights))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">826</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">827</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">828</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #############################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">829</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #     3) Maximum Likelihood estimation      #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">830</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #############################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">831</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">832</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  d1 &lt;- rep(Inf, length(est)) #d1 represent first derivatives of estimates </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">833</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  oldlnl &lt;- fn0(est, varFloor=-3.59) # evaluate the likelihood with the estimated coefficients before adaptive quadrature </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">834</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">835</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  a00 &lt;- a0 # start from previous estimates (MAP estimates) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">836</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">837</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">838</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    cat("Starting Newton steps.\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">839</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">840</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">841</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #select just variances that are &gt; -3 to aviod continued adaptation below 0 </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">842</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  covs_and_vars &lt;- est[-(1:k)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">843</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  vars &lt;- covs_and_vars[which(is.na(lmeVarDF$var2))]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">844</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  not_0_vars &lt;- which(vars&gt;-3)+k</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">845</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  est[-(1:k)]  &lt;- ifelse(est[-(1:k)]&lt; -4.6,-4.6,est[-(1:k)])  #reset variance that get below threshold</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">846</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # v is the full Newton step vector. Here set to a stub value</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">847</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  v &lt;- d1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">848</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">849</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # Newton steps continue until step size is under threshold, excluding variances &lt; -3</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">850</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # the denominator prevents relative changes that are indistinguishable from 0 from being</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">851</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # included.</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">852</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  skipNextHessian &lt;- FALSE</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">853</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # every step is of all parts, this works best.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">854</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # but leave this in here since we may later enounter a situation where it helps</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">855</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  defStepsInds &lt;- list(1:length(est0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">856</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  stepIndQueue &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">857</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  dd1 &lt;- d1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">858</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  dd2 &lt;- outer(dd1,dd1) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">859</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  iteration &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">860</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varFloorBinding &lt;- FALSE</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">861</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  oldest &lt;- est</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">862</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">863</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # first condition, a variance is 0.01, so we look just for fitted values to not change</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">864</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # second condition, look for derivatives to be small</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">865</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  while(all(iteration &lt; max_iteration,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">866</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            any(varFloorBinding &amp; max(est - oldest) &gt; 1e-5 ,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">867</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               !varFloorBinding &amp; max(abs(dd1[c(1:k, not_0_vars)]/pmax(abs(est[c(1:k, not_0_vars)]), 1e-5))) &gt; 1E-5)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">868</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               )) { </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">869</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    iteration &lt;- iteration + 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">870</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    oldest &lt;- est</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">871</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(length(stepIndQueue)==0) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">872</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      stepIndQueue &lt;- defStepsInds</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">873</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">874</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    thisStepInds &lt;- stepIndQueue[[1]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">875</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # calls helper function to get both first and second derivative </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">876</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    d1 &lt;- getGrad(fn0, est, thisStepInds)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">877</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # update full length grad</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">878</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    dd1[thisStepInds] &lt;- d1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">879</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(!skipNextHessian) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">880</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      d2 &lt;- getHessian(fn0, est, thisStepInds)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">881</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # update full size Hessian</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">882</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      dd2[thisStepInds, thisStepInds] &lt;- d2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">883</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">884</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # use most recent Hessian</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">885</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    d2 &lt;- dd2[thisStepInds, thisStepInds]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">886</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    fact &lt;- 1 # scaling factor by which this step is multiplied </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">887</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    v &lt;- rep(0, length(est0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">888</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    v[thisStepInds] &lt;- solve(d2) %*% d1 # the Newton step</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">889</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">890</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cat("step:", iteration, "/", max_iteration, "\n")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">891</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cat("lnl:", oldlnl, " max (relative) derivative=", max(abs(dd1[c(1:k,not_0_vars)]/pmax(abs(est[c(1:k,not_0_vars)]), 1e-5))), " ")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">892</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cat("\nCurrent solution, gradient, and Newton step:\n")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">893</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      prnt &lt;- cbind(oldEstimate=est, firstDeriv=dd1, proposedNewtonEstimate=est - v)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">894</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      rownames(prnt) &lt;- c(names(est0)[1:k], paste0("ln var ", names(est0)[-(1:k)], ""))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">895</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      colnames(prnt) &lt;- c("previous Est", "firstDeriv", "Newton Step")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">896</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      print(prnt)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">897</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">898</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">899</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # create new estimate by stepping in the direction idicated by gradient and scaled by fact</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">900</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    newest &lt;- est - fact * v</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">901</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    newlnl &lt;- fn0(newest, varFloor=-3.59)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">902</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stp &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">903</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">904</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # make sure Newton step is a step improves lnl</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">905</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    while(newlnl &lt; oldlnl) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">906</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      stp &lt;- stp + 1</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">907</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">908</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        cat("Halving step size.\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">909</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">910</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      fact &lt;- fact/2</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">911</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(stp &gt; 5 &amp; fact &gt; 0) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">912</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">913</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          cat("Reversing step direction.\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">914</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">915</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ##reverse direction if more than 5 steps have been taken, avoid newtons method getting stuck </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">916</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        fact &lt;- -1</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">917</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        stp &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">918</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">919</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if (stp&gt;10) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">920</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # bad search direction, do nothing</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">921</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        fact &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">922</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        oldlnl &lt;- oldlnl - 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">923</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">924</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      newest &lt;- est - fact * v</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">925</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      newlnl &lt;- fn0(newest, varFloor=-3.59)      </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">926</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } # end while(newlnl &lt; oldlnl)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">927</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">928</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cat("\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">929</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">930</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # update current estimate with the step we decided on</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">931</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    est &lt;- est - fact * v</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">932</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # update the lnl</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">933</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    oldlnl &lt;- newlnl</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">934</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">935</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # now, worry about threshold</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">936</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(any(est[-(1:k)] &lt; -3.59)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">937</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      est[-(1:k)]  &lt;- ifelse(est[-(1:k)] &lt; -3.59, -3.59, est[-(1:k)])  #reset variance that get below threshold</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">938</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      varFloorBinding &lt;- TRUE</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">939</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # no need up update oldlnl, this varFloor is always enforced</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">940</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">941</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #adapts new quadrature points if parameter keepAdapting is true  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">942</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(keepAdapting) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">943</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">944</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        cat("Adapting random effect estimates.\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">945</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">946</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # adapter is never BLUE now</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">947</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(adapter == "BLUE") {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">948</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        a0 &lt;- BLUE0(omega0=a0$omega0, par0=est0, Qi0=a0$Qi0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">949</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } else {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">950</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # update the b and Q parameters</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">951</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        a0 &lt;- MAP0(omega0=a0$omega0,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">952</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   par0=est,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">953</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   verb=FALSE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">954</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">955</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">956</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #recacluate scaled Z values based on new Q (Curvature)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">957</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      zScale &lt;- lapply(a0$Qi0, function(Qi0i) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">958</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   if(is.null(Qi0i)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">959</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     return(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">960</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">961</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   df &lt;- data.frame(detQ=sapply(Qi0i,det))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">962</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   # add group labels</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">963</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   for(i in 1:length(groupNames)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">964</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     if(length(unique(data[,groupNames[i]])) == nrow(df)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">965</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                       df[,groupNames[i]] &lt;- unique(data[,groupNames[i]])</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">966</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                       attr(df,"groups") &lt;- c(attr(df, "groups"), groupNames[i])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">967</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     }  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">968</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">969</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   df</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">970</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">971</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">972</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # move new values of detQ on to dataframes in weights list </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">973</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(wi in 2:length(weights)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">974</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        weights[[wi]]$detQ &lt;- NULL</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">975</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Zgrps &lt;- attr(zScale[[wi]], "groups")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">976</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        weights[[wi]] &lt;- merge(weights[[wi]],zScale[[wi]][,c(Zgrps, "detQ")],by.x="index", by.y=Zgrps)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">977</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">978</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">979</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # update function for unser and function for optimization</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">980</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      fn0 &lt;- param.lnl.quad(y=y,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">981</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            X=X,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">982</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            levels=levels,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">983</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            Z=Z,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">984</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            ZFull=ZFull,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">985</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            Qi=a0$Qi,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">986</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            QiFull=a0$QiFull,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">987</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            omega=a0$omega,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">988</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            omegaFull=a0$omegaFull,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">989</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            W=weights,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">990</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            k=k,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">991</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            qp=qp,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">992</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            cConstructor=covarianceConstructor,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">993</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            acc0=acc0,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">994</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            mappedDefault=FALSE,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">995</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            family=family)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">996</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">997</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      fn0R &lt;- param.lnl.quad(y=y,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">998</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             X=X,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">999</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             levels=levels,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1000</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             Z=Z,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1001</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             ZFull=ZFull,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1002</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             Qi=a0$Qi,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1003</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             QiFull=a0$QiFull,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1004</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             omega=a0$omega,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1005</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             omegaFull=a0$omegaFull,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1006</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             W=weights,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1007</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             k=k,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1008</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             qp=qp,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1009</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             cConstructor=covarianceConstructor,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1010</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             acc0=acc0,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1011</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             mappedDefault=TRUE,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1012</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             family=family)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1013</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1014</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # Process of adapting stops when there the relative difference between chosen points is below threshold </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1015</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(max(abs(a00$omega0[[2]] - a0$omega0[[2]])/pmax(abs(a0$omega0[[2]]),1E-10)) &lt; 1E-2) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1016</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1017</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          cat("Done adapting; the mode is not changing sufficiently.\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1018</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1019</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        keepAdapting &lt;- FALSE</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1020</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1021</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(keepAdapting &amp; max(abs(d1)) &lt;= 1E-3) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1022</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1023</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          cat("Done adapting: close to a solution.\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1024</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1025</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        keepAdapting &lt;- FALSE</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1026</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1027</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      a00 &lt;- a0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1028</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # the lnl function may have shifted enough that we need to update the current lnl</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1029</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # so update it based on these new quad points</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1030</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      oldlnl &lt;- fn0(est, varFloor=-3.59)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1031</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } # end if(keepAdapting)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1032</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #end of the Newton's method while loop</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1033</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1034</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #re updates the index of vars that are greater than -3 based on new est values </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1035</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    covs_and_vars &lt;- est[-(1:k)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1036</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    vars &lt;- covs_and_vars[which(is.na(lmeVarDF$var2))] #select only vars not covars </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1037</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    not_0_vars &lt;- which(vars &gt; -3) + k</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1038</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if((!skipNextHessian &amp; max(sum(abs(fact*v)/abs(est))) &lt; (.Machine$double.eps)^0.25) &amp; max(abs(dd2)) &lt; Inf) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1039</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      skipNextHessian &lt;- TRUE</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1040</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1041</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      skipNextHessian &lt;- FALSE</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1042</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1043</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } # end of while(max(abs(d1/pmax(abs(est),1e-5))) &gt; 1E-5)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1044</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1045</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    message("Itterations complete.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1046</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1047</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if (iteration &gt;= max_iteration){</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1048</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #warning("Model exceeded maximum number of iterations and may not have converged.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1049</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1050</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #############################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1051</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #            4) Post Estimation             #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1052</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #############################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1053</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"> </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1054</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  hessian &lt;- dd2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1055</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1056</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # For each "random effect" calculate the maximum of the likelihood surface (MAP)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1057</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # and the expected value of the likelihood surface (BLUE)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1058</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  MAP &lt;- MAP0(omega0=a0$omega0, par0=est, verb=FALSE)$omega0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1059</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  BLUE &lt;- BLUE0(omega0=a0$omega0, par0=est, Qi0=a0$Qi0, adapt=FALSE, verb=FALSE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1060</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1061</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # make est numeric</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1062</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  est &lt;- as.numeric(est)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1063</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1064</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # make sure the names agree with lmer</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1065</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  names(est) &lt;- names(parlme)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1066</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1067</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # fix vars that are less than one to be mapped</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1068</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  covs_and_vars &lt;- est[-(1:k)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1069</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  vars &lt;- covs_and_vars[which(is.na(lmeVarDF$var2))] #select only vars not covars </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1070</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  need_fix_vars &lt;- which(vars &lt; 1)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1071</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  covs_and_vars[need_fix_vars] &lt;- exp(covs_and_vars[need_fix_vars] - 1)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1072</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1073</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # get vars and name them</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1074</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  vars &lt;- covs_and_vars</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1075</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  names(vars) &lt;- gsub(":NA", "", paste(lmeVarDF$grp, lmeVarDF$var1, lmeVarDF$var2, sep=":"))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1076</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1077</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # If any of variances got re mapped, re calculate hessian just inside the line, and </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1078</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # share the limitation on WeMix estimation and the model wit the user.</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1079</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if (length(need_fix_vars) &gt; 0){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1080</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    warning(paste0("Group variances too small to estimate accurately. The estimated variance in the group level terms(s) ", paste(dQuote(names(vars)[need_fix_vars]), collapse=", "), " is near zero.",</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1081</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   " Very low variance suggests that the data is not hierarchical and that a model without these levels should be considered.",</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1082</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   " If this removes all groups then a non-hierarchical model, such as logistic regression, should be considered."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1083</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # calculate hessian, moving covariances to just larger values so the Hessian is internal</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1084</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    hessian &lt;- getHessian(fn0R, c(est[1:k], covs_and_vars+0.0002*need_fix_vars))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1085</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1086</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1087</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #calculate interclass corelation (ICC) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1088</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  var_between &lt;- sum(vars[which(!is.na(lmeVarDF$var1) &amp; is.na(lmeVarDF$var2))])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1089</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  var_within &lt;- vars[which(lmeVarDF$grp=="Residual")]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1090</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ICC &lt;- var_between/(var_between+var_within)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1091</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1092</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # it is possible for the lnl to have changed slightly, so update it to avoid confusion</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1093</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  nobs &lt;- nrow(X)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1094</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  names(nobs) &lt;- "Number of obs"</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1095</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ngroups &lt;- c(nobs, ngrp)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1096</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1097</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #set up the variance covariance matrix </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1098</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varDF &lt;- lmeVarDF[,c("grp", "var1", "var2", "vcov", "ngrp", "level")]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1099</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1100</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varDF$vcov &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1101</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varDF$fullGroup &lt;- paste0(varDF$grp,ifelse(!is.na(varDF$var1),paste0(".",varDF$var1),""))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1102</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1103</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varDF$vcov &lt;- vars #re assign in variance from mix.  This works without formatting because only 2 level models are posisble</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1104</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1105</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  res &lt;- list(lnlf=fn0R, lnl=fn0(est, varFloor=-3.59), coef=est[1:k], vars=vars,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1106</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              call=call, levels=levels, ICC=ICC, CMODE=BLUE,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1107</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              invHessian=hessian, is_adaptive=TRUE, ngroups=ngroups, varDF=varDF,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1108</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              wgtStats=ngrpW)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1109</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  class(res) &lt;- "WeMixResults"</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1110</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1111</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1112</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1113</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1114</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># finds expected value of the "random effects" likelihood surfaces</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1115</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># this function cannot find these without input estimates; it cannot be used for adapting.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1116</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @author Paul Bailey</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1117</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">BLUE &lt;- function(groups, y, X, levels, Z, ZFull, weights0, k, qp,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1118</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 covariance_constructor, verbose, nlmevar, nz, acc,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1119</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 family) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1120</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1121</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # must define one of Qi or Qi0. Defining Qi is faster</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1122</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #this is the function that is returned when BLUE is called </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1123</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  function(omega0, par0, Qi=NULL, Qi0=NULL, verb=verbose, adapt=TRUE) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1124</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1125</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # form the Q matrixes from weights</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1126</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    weights &lt;- weights0 #start with original weights </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1127</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(is.null(Qi)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1128</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Qi &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1129</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      QiFull &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1130</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for( oi in 2:length(omega0)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1131</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        map &lt;- groups[,oi-1] # decrement index by one because the first groups data frame doesnt have a column for level 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1132</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        umap &lt;- unique(map)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1133</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        nzi &lt;- ncol(Z[[oi]]) # find number of z variables at this level </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1134</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Qi[[oi]] &lt;- matrix(0, nrow=nzi, ncol=nzi*nrow(weights[[oi-1]]))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1135</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(i in 1:nrow(weights[[oi-1]])) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1136</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">           #shape Qi, a list with one element per model level</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1137</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          #each element of Qi has one row for each random effect (Z) and one column for each observation in the level below-random effect combination</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1138</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          #values are being moved over from Qi0 which is the MAP estimates at the group level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1139</td>
                    <td class="coverage">180<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          Qi[[oi]][1:nzi,(i-1)*nzi+1:nzi] &lt;- Qi0[[oi]][[(1:length(umap))[map[i]==umap] ]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1140</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1141</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        QiFull[[oi]] &lt;- matrix(0, nrow=nzi, ncol=nzi*nrow(X))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1142</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(i in 1:nrow(X)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1143</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          #Also  full version which as one row for each Z and one column for each obs-random effect combination</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1144</td>
                    <td class="coverage">180<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          QiFull[[oi]][1:nzi,(i-1)*nzi+1:nzi] &lt;- Qi0[[oi]][[(1:length(umap))[map[i]==umap] ]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1145</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1146</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } # ends  for( oi in 2:length(omega0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1147</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } # ends if(is.null(Qi)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1148</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1149</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # function that creates dataframe to be used to scale Z value by the scaling factor calculated as the determinate of the curvature Q</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1150</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    zScale &lt;- lapply(Qi0, function(Qi0i) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1151</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 if(is.null(Qi0i)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1152</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   return(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1153</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1154</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 df &lt;- data.frame(detQ=sapply(Qi0i,det))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1155</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 # add group labels </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1156</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 for(i in 1:ncol(groups)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1157</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   if(length(unique(groups[,i])) == nrow(df)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1158</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     df[,colnames(groups)[i]] &lt;- unique(groups[,i])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1159</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                     attr(df,"groups") &lt;- c(attr(df, "groups"), colnames(groups)[i])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1160</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1161</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1162</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 df</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1163</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1164</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1165</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # for  each data frame in weightes merger on the scaling factor determinat of</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1166</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # curvature (detQ)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1167</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(wi in 2:length(weights)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1168</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      weights[[wi]]$detQ &lt;- NULL</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1169</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Zgrps &lt;- attr(zScale[[wi]], "groups")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1170</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      weights[[wi]] &lt;- merge(weights[[wi]], zScale[[wi]][,c(Zgrps, "detQ")],by.x="index", by.y=Zgrps)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1171</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1172</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">     </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1173</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # make new omega</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1174</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    omega &lt;- buildOmega(omega0=omega0, groups=groups, nrowX=nrow(X))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1175</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    omegaFull &lt;- buildOmega(omega0=omega0, groups=groups, nrowX=nrow(X), full=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1176</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # make stubs</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1177</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Qi0_ &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1178</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Qi_ &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1179</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    tmpomega &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1180</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for( oi in 2:length(omega0)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1181</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      omg0 &lt;- omega0[[oi]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1182</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      omg1 &lt;- 2*omg0  #increment up to allow while loop to run</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1183</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">       </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1184</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # keep looking for the mean</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1185</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      while( max(abs( (omg1 - omg0) / pmax(abs(omg0), 1E-5))) &gt; 1E-3) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1186</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omg1 &lt;- omg0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1187</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        tmpomega_ &lt;- c(tmpomega, list(omg0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1188</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        nzi &lt;- ncol(Z[[oi]]) # number of Z columns at olvl</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1189</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        f &lt;- param.lnl.quad(y, X, oi, Z, ZFull=ZFull, Qi=Qi, QiFull=QiFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1190</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            omega, omegaFull=omegaFull, W=weights, k, qp,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1191</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            covariance_constructor, bobyqa=FALSE, verbose=TRUE, acc0=acc,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1192</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            mappedDefault=FALSE, family=family)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1193</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(ici in 1:ncol(omg0)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1194</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          f0 &lt;- f(par0, top=FALSE, integralMultiplierExponent=0, integralZColumn=ici)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1195</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          f1 &lt;- f(par0, top=FALSE, integralMultiplierExponent=1, integralZColumn=ici)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1196</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # f1 is not logged, f0 is</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1197</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          omg0[ , ici] &lt;- as.numeric(f1/f0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1198</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1199</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # make omega</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1200</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omega0p &lt;- c(tmpomega, list(omg0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1201</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        while( length(omega0p) &lt; length(omega0)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1202</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          omega0p[[length(omega0p)+1]] &lt;- omega0[[length(omega0p)+1]] </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1203</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1204</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omega &lt;- buildOmega(omega0=omega0p, groups=groups, nrowX=nrow(X))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1205</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omegaFull &lt;- buildOmega(omega0=omega0p, groups=groups, nrowX=nrow(X), full=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1206</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(!adapt) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1207</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # no need to loop, this is the BLUE</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1208</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          omg1 &lt;- omg0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1209</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1210</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1211</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(verb &amp; adapt) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1212</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        cat("BLUE estimates:\n")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1213</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        print(omg0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1214</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1215</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # move the integration points to the new BLUE estiamtes and update</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1216</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(adapt) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1217</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omg0Full &lt;- buildOmega(omega0=tmpomega_, groups=groups, nrowX=nrow(X), full=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1218</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        derivatives &lt;- genD(adapterLnL(y, X, levels, Z, ZFull, weights, k, qp,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1219</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                       covariance_constructor, omega,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1220</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                       omg0Full,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1221</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                       tmpomega_, par0, verb, Qi, QiFull, oi,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1222</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                       acc, family),</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1223</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                            rep(0,sum(unlist(nz)[1:oi], na.rm=TRUE)))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1224</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        d2 &lt;- derivatives$D[,-(1:nzi),drop=FALSE] # remove first derivatives</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1225</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        drv &lt;- d2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1226</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # assumes there are exactly two levels</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1227</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Qi0_[[oi]] &lt;- lapply(1:nrow(drv), function(i) { </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1228</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          scaleQuadPoints(drv[i,], nzi)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1229</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        })</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1230</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        map &lt;- groups[,oi-1]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1231</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        umap &lt;- unique(map)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1232</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Qi_[[oi]] &lt;- matrix(0, nrow=nzi, ncol=nzi*nrow(X))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1233</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(i in 1:nrow(X)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1234</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          Qi_[[oi]][1:nzi,(i-1)*nzi+1:nzi] &lt;- Qi0_[[oi]][[(1:length(umap))[map[i]==umap] ]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1235</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        } </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1236</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        QiFull[[oi]] &lt;- matrix(0, nrow=nzi, ncol=nzi*nrow(X))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1237</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(i in 1:nrow(X)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1238</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          QiFull[[oi]][1:nz,(i-1)*nz+1:nz] &lt;- Qi0[[oi]][[(1:length(umap))[map[i]==umap] ]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1239</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1240</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1241</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # now, actually add this to the tmpomega</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1242</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      tmpomega &lt;- c(tmpomega, list(omg0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1243</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      omg0Full &lt;- buildOmega(omega0=tmpomega, groups=groups, nrowX=nrow(X), full=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1244</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1245</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(adapt) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1246</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      return(list(omega0=tmpomega, omega=omega, omegaFull=omg0Full, Qi0=Qi0_, Qi=Qi_, QiFull=QiFull))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1247</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1248</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      return(tmpomega)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1249</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1250</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1251</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1252</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1253</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1254</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># finds the maximum of the likelihood surface and (approximate) SD, per "random effect"</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1255</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># this function can find these without input estimates. This is used for adapting</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1256</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">MAP &lt;- function(groups, y, X, levels, Z, ZFull, weights, k, qp,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1257</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                covariance_constructor, verbose, nlmevar, nz, acc, family) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1258</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ####################################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1259</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #                        Outline:                  #   </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1260</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #        1) Find points for MAP estimation         #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1261</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #        2) MAP estimate                           #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1262</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #         3) Estimate variance                     #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1263</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ####################################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1264</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1265</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # when you call adapter, it returns this function that can be called with omega0 and par0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1266</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # and will find a new MAP and SD for each RE</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1267</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  function(omega0, par0, verb=verbose) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1268</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #####################################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1269</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #        1) Find points for MAP estimation         #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1270</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #####################################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1271</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1272</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # make omega, which is omega0 at the level one  data length</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1273</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    omega &lt;- buildOmega(omega0=omega0, groups=groups, nrowX=nrow(X))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1274</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    omegaFull &lt;- buildOmega(omega0=omega0, groups=groups, nrowX=nrow(X), full=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1275</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">   </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1276</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # f returns the log(likelihood * posterior), per group</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1277</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # use Newton's method, per group, to find the maximum of the a posterori surface</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1278</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Qi0 &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1279</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Qi &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1280</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    QiFull &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1281</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    tmpomega &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1282</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    tmpomegaFull &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1283</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    u0 &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1284</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(oi in 2:length(omega0)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1285</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # Over all levels &gt;1 </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1286</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      omg0 &lt;- omega0[[oi]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1287</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      omg1 &lt;- 1E20*(omg0+1E-15)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1288</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      nzi &lt;- nz[[oi]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1289</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      iter &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1290</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      while( iter &lt; 25 &amp; max(abs( (omg1 - omg0) / pmax(abs(omg0), 1E-5))) &gt; 1E-3) { # iterate while Omega continues to change more than threshold</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1291</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(iter &gt;= 1) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1292</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          u0 &lt;- max(c(u0, as.vector(abs( (omg1 - omg0) ))))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1293</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1294</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        iter &lt;- iter + 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1295</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omg1 &lt;- omg0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1296</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        tmpomega_ &lt;- c(tmpomega, list(omg0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1297</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        toF &lt;- buildOmega(omega0=tmpomega_, groups=groups, nrowX=nrow(X), full=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1298</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ofn &lt;- adapterLnL(y, X, levels, Z, ZFull, weights, k, qp,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1299</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                          covariance_constructor, omega, toF,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1300</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                          tmpomega_, par0, verb, Qi, QiFull, oi, acc,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1301</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                          family)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1302</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # this is just second derivatives</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1303</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        d1 &lt;- getJacobian(ofn, rep(0, nz[[oi]], na.rm=TRUE), m=nrow(omg0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1304</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        d2 &lt;- getHessian(ofn, rep(0, nz[[oi]], na.rm=TRUE))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1305</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1306</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ######################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1307</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        #        2) MAP estimate            #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1308</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ######################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1309</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1310</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # this is the Newton step, per group</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1311</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omg0 &lt;- lapply(1:length(d2),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1312</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                       function(i) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1313</td>
                    <td class="coverage">126<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         step &lt;- solve(d2[[i]]) %*% d1[[i]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1314</td>
                    <td class="coverage">126<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         if(iter &gt;= 3) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1315</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           # first, nudge down to 1/2 step for everything</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1316</td>
                    <td class="coverage">72<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           step &lt;- 1/2 * step</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1317</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           # contract to no larger than the initial step</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1318</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           # slowly moving that max down as iteration number increases</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1319</td>
                    <td class="coverage">72<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           ii &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1320</td>
                    <td class="coverage">72<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           while(any(abs(step) &gt; 3*u0/iter)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1321</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             ii &lt;- ii + 1</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1322</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             step &lt;- 1/2 * step</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1323</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             if(ii &gt; 20) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1324</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                              stop("Ridiculous Newton step proposed, MAP not converging.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1325</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1326</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1327</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         } else {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1328</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           # contract just a bit</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1329</td>
                    <td class="coverage">54<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           step &lt;- 1/2 * step</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1330</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1331</td>
                    <td class="coverage">126<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         omg0[i,] - step</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1332</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                       })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1333</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1334</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # this recudes that to a vector</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1335</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omg0 &lt;- t(do.call(cbind, omg0))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1336</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # make omega</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1337</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omega0p &lt;- c(tmpomega, list(omg0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1338</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        while( length(omega0p) &lt; length(omega0)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1339</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          omega0p[[length(omega0p)+1]] &lt;- omega0[[length(omega0p)+1]] </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1340</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1341</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omega &lt;- buildOmega(omega0=omega0p, groups=groups, nrowX=nrow(X))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1342</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        omegaFull &lt;- buildOmega(omega0=omega0p, groups=groups, nrowX=nrow(X), full=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1343</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1344</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } # end while( max(abs( (omg1 - omg0) / pmax(abs(omg0),1E-5))) &gt; 1E-3)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1345</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(verb) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1346</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        cat("Estimates:\n")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1347</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        print(omg0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1348</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1349</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #####################################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1350</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #         3) Estimate variance (Fishers I)          #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1351</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #####################################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1352</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1353</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # add this to the tmpomega</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1354</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      tmpomega &lt;- c(tmpomega, list(omg0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1355</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      tmpomegaFull &lt;- omegaFull</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1356</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # get Qi</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1357</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      drv &lt;- d2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1358</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # assumes there are exactly two levels</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1359</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Qi0[[oi]] &lt;- lapply(1:length(drv), function(i) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1360</td>
                    <td class="coverage">36<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ss &lt;- scaleQuadPoints(drv[[i]], nzi)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1361</td>
                    <td class="coverage">36<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(j in 1:nrow(ss)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1362</td>
                    <td class="coverage">36<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          if(ss[j,j] &gt; abs(omg0[i,j])) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1363</td>
                    <td class="coverage">10<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            ss[j,j] &lt;- sqrt(ss[j,j]^2 + omg0[i,j]^2)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1364</td>
                    <td class="coverage">10<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            omg0[i,j] &lt;&lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1365</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1366</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1367</td>
                    <td class="coverage">36<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ss</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1368</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      })</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1369</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      map &lt;- groups[,oi-1]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1370</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      umap &lt;- unique(map)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1371</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      nzi &lt;- ncol(Z[[oi]]) # number of Z columns at olvl</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1372</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Qi[[oi]] &lt;- matrix(0, nrow=nzi, ncol=nzi*nrow(weights[[oi-1]]))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1373</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(i in 1:nrow(weights[[oi-1]])) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1374</td>
                    <td class="coverage">360<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Qi[[oi]][1:nzi,(i-1)*nzi+1:nzi] &lt;- Qi0[[oi]][[(1:length(umap))[map[i]==umap] ]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1375</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1376</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      QiFull[[oi]] &lt;- matrix(0, nrow=nzi, ncol=nzi*nrow(X))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1377</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(i in 1:nrow(X)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1378</td>
                    <td class="coverage">360<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        QiFull[[oi]][1:nzi,(i-1)*nzi+1:nzi] &lt;- Qi0[[oi]][[(1:length(umap))[map[i]==umap] ]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1379</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1380</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # add to weights for further MAP calculations only</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1381</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(oi &lt; length(omega0)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1382</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # add detQ</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1383</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        df &lt;- data.frame(detQ=sapply(Qi0[[oi]],det))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1384</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # add group labels</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1385</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        groupNames &lt;- colnames(groups)[oi-1]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1386</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(i in 1:length(groupNames)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1387</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          df[,groupNames[i]] &lt;- unique(groups[,groupNames[i]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1388</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1389</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # add detQ to weights for later iterations to use</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1390</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        weights[[oi]] &lt;- merge(weights[[oi]],df[,c(groupNames, "detQ")],by.x="index", by.y=groupNames)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1391</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1392</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } # ends for( oi in 2:length(omega0))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1393</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1394</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    list(omega0=tmpomega, omega=omega, omegaFull=tmpomegaFull, Qi0=Qi0, Qi=Qi, QiFull=QiFull)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1395</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1396</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1397</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1398</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1399</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># helper functions for adapter:</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1400</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1401</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># turn the genD output into the Cholesky of the inverse Fisher information</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1402</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom Matrix nearPD</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1403</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">scaleQuadPoints &lt;- function(d2, nz){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1404</td>
                    <td class="coverage">36<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  solved &lt;- solve(-1*d2)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1405</td>
                    <td class="coverage">36<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  res &lt;- NULL</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1406</td>
                    <td class="coverage">36<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  tryCatch(res &lt;- chol(solved),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1407</td>
                    <td class="coverage">36<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">           error= function(e) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1408</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">             # if solved matrix is not positive definite (PD), use nearPD</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1409</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">             # to find the nearest positive definite matrix.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1410</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">             # If that fails, because matrix is near negative semi-definite, use</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1411</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">             # the absolute value of the diagonal as an approximation</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1412</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">             tryCatch(solved &lt;- nearPD(solved)$mat,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1413</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                      error=function(e){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1414</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        solved &lt;&lt;- diag(abs(diag(solved)))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1415</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                      })</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1416</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">             res &lt;&lt;- chol(solved)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1417</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">           })</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1418</td>
                    <td class="coverage">36<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  res</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1419</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1420</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1421</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># turn omega0 (which has the same number of rows as there are units at each level</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1422</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># into omega (which has the same number of rows as the X data) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1423</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">buildOmega &lt;- function(omega0, groups, nrowX, full=FALSE) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1424</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  omega &lt;- list(NULL)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1425</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  oind &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1426</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(o0i in 2:length(omega0)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1427</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    omega0i &lt;- as.matrix(omega0[[o0i]])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1428</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    res &lt;- matrix(0, nrow=nrowX, ncol=ncol(omega0i))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1429</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    noind &lt;- ncol(omega0i) # number of columns to copy over</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1430</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    map &lt;- groups[,o0i-1]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1431</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    umap &lt;- unique(map)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1432</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(i in 1:length(umap)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1433</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # for each unique level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1434</td>
                    <td class="coverage">540<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(oindi in 1:noind) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1435</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # copy over data by column (oindi) on omega0i</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1436</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # effectively duplicated each value of omega0  a number of times coresponding to how many obs there are in that group</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1437</td>
                    <td class="coverage">540<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        res[which(map==umap[i]),oindi] &lt;- omega0i[i,oindi]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1438</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1439</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1440</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(o0i &gt; 2 &amp; !full) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1441</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      res &lt;- res[!duplicated(groups[,o0i-2]),]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1442</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1443</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    omega &lt;- c(omega, list(res))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1444</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    oind &lt;- oind + noind</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1445</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } # closes main for loop for(o0i in 2:length(omega0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1446</td>
                    <td class="coverage">30<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  omega</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1447</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1448</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1449</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># function that returns the likelihood, by group, evaulated at a point</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1450</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">adapterLnL &lt;- function(y, X, levels, Z, ZFull, weights, k, qp,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1451</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                       covariance_constructor, omega, omegaFull, omega0, par0,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1452</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                       verbose, Qi, QiFull, olvl, acc, family) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1453</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # olvl is the level we are optimizing now</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1454</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  function(par, long=FALSE) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1455</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # notice par here is a new displacement in the random effect location</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1456</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # not par0, which is a set of mixed model parameters</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1457</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    yadj &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1458</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    o0 &lt;- omega0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1459</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    nzi &lt;- 0 # number of Z columns at olvl</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1460</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"> </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1461</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(i in 1:olvl) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1462</td>
                    <td class="coverage">2030<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(!is.null(Z[[i]])) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1463</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ki &lt;- ncol(Z[[i]])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1464</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(i == olvl) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1465</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          nzi &lt;- ki</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1466</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1467</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(ki &gt;= 1) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1468</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # keep track of update in omega for calculation of prior prob</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1469</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # yadj is moved by omega, but also to account for an addition change </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1470</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # controlled by par</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1471</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          zAdjust &lt;- apply(ZFull[[i]] * omegaFull[[i]],1,sum)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1472</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          if(olvl == i) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1473</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            zAdjust &lt;- zAdjust + ZFull[[i]] %*% par[1:ki]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1474</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            for(kii in 1:ki) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1475</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              o0[[i]][,kii] &lt;- o0[[i]][,kii] + par[kii]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1476</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1477</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            par &lt;- par[-(1:ki)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1478</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1479</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # for olvl &gt; 2, zAdjust has the wrong number of rows and need to be mapped</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1480</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # back to yp using the weights</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1481</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          yadj &lt;- yadj + zAdjust</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1482</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        } # ends if  if(ki &gt;= 1) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1483</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } # ends  if(!is.null(Z[[i]]))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1484</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } #ends for(i in 1:olvl)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1485</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # evaluate the likelihood</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1486</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    beta &lt;- par0[1:k]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1487</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    parC &lt;- covariance_constructor(par0[-(1:k)])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1488</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1489</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # Set curavtures Q for lower level to matrix of 0 </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1490</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # This is becasue the curvature is 0 at the maximum </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1491</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # used for calculated likelihood by groups. </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1492</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Qi_ &lt;- matrix(0, nrow=nzi, ncol=nzi*nrow(weights[[olvl-1]])) # this needs to be the Qi for lower levels</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1493</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Qi__ &lt;- c(Qi, list(Qi_))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1494</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    QiFull_ &lt;- matrix(0, nrow=nzi, ncol=nzi*nrow(X)) # this needs to be the Qi for lower levels</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1495</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    QiFull__ &lt;- c(Qi, list(QiFull_))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1496</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1497</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #use helper funciton to return the likelihood contribution of teach group </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1498</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">   </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1499</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    loglikelihoodByGroup &lt;- calc.lin.lnl.quad(y=y, yhat=X %*% beta + yadj, level=olvl,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1500</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                              Z, Qi=Qi__,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1501</td>
                    <td class="coverage">2030<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                              omega=lapply(omega, function(omegai) {0*omegai}),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1502</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                              W=weights, C=parC, qp, top=FALSE,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1503</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                              atPoint=TRUE, verbose=verbose,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1504</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                              acc=acc, ZFull=ZFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1505</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                              omegaFull=omegaFull, QiFull=QiFull__,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1506</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                              family=family)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1507</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Cl &lt;- parC[[olvl]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1508</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # apply multivatiate normal pdf to get posterior for each gorup </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1509</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    posteriorByGroup &lt;- apply(o0[[olvl]], MARGIN=1, function(p) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1510</td>
                    <td class="coverage">18270<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      mvnpdfC(as.matrix(p), rep(0, length = length(p)), varcovM=Cl%*%t(Cl), Log=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1511</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        })</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1512</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(long) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1513</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      return(list(res=loglikelihoodByGroup + posteriorByGroup,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1514</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  loglikelihoodByGroup=loglikelihoodByGroup,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">1515</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  posteriorByGroup=posteriorByGroup))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1516</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1517</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #final return </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1518</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    loglikelihoodByGroup + posteriorByGroup</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">1519</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } #ends  funciton to be return function(par, long=FALSE) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">1520</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">} </pre>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="R/analyticSolve.R" class="hidden">
              <table class="table-condensed">
                <tbody>
                  <tr class="never">
                    <td class="num">1</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">2</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">3</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># The main function which calculates the analytic solution to the linear mixed effects model. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">4</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param weights level-1 weights</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">5</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param y outcome measure. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">6</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param X the X matrix.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">7</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param Zlist, a list of matrixes with the Z values for each level. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">8</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param Zlevels, the level corresponding to each matrix in Zlist. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">9</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param weights a list of unconditional weights for each model level. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">10</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param weightsC a list of conditional weights for each model level. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">11</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param groupID a matrix containing the group ids for each level in the model. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">12</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param lmeVardf a dataframe containing the variances and covariance of the random effects, in the same format as returned from lme. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">13</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom Matrix Diagonal Matrix bdiag diag</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">14</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom methods as .hasSlot rbind2 </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">15</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">analyticSolve &lt;- function(y, X, Zlist, Zlevels, weights, weightsC=weights, groupID, lmeVarDF, analyticJacobian=FALSE, forcebaseQR=FALSE, qr_=qr_0, v0, lndetLz0=NULL) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">16</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">17</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(! inherits(groupID, c("matrix", "data.frame")) ) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">18</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop(paste0("Variable", dQuote("groupID")," must be a matrix  or data.frame with IDs at a level per column."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">19</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">20</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # this has the indexes, but we do not need those. Save them here</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">21</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  groupID0 &lt;- groupID</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">22</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # now winnow down to just the expected number of columns</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">23</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  groupID &lt;- as.matrix(groupID[ , 1:(length(weights)-1), drop=FALSE])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">24</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!inherits(y, "numeric")) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">25</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop(paste0(dQuote("y"), " must be a numeric vector."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">26</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">27</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ny &lt;- length(y)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">28</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  X &lt;- as.matrix(X)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">29</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  nX &lt;- nrow(X)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">30</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(nX != ny) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">31</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop(paste0("Length of the ", dQuote("y"), " vector and the ", dQuote("X"), " matrix must agree."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">32</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">33</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(length(Zlist) != length(Zlevels)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">34</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop(paste0("Length of the ", dQuote("Zlist"), " and ", dQuote("Zlevels"), " must agree."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">35</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">36</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  nW1 &lt;- length(weights[[1]])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">37</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(nW1 != nX) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">38</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop(paste0("Number of rows in ", dQuote("weights[[1]]") , " must agree with number of rows in ", dQuote("X"),"."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">39</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">40</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  nWc1 &lt;- length(weightsC[[1]])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">41</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(nWc1 != nX) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">42</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop(paste0("Number of rows in ", dQuote("weightsC[[1]]") , " must agree with number of rows in ", dQuote("X"),"."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">43</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">44</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ngid &lt;- nrow(groupID)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">45</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(ngid != nX) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">46</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    stop(paste0("Number of rows in ", dQuote("groupID") , " must agree with number of rows in ", dQuote("X"),"."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">47</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">48</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # groupID needs to be one indexed, so enforce that (this is used for robustSE)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">49</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  groupID[,ncol(groupID)] &lt;- as.numeric(as.factor(groupID[,ncol(groupID)]))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">50</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # get the number of groups per level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">51</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  nc &lt;- apply(groupID, 2, function(x) {length(unique(x))} )</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">52</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">53</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # for level 1 cast Z for lowest level as a matrix and transpose to get Zt</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">54</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Zt &lt;- Matrix::t(as(Zlist[[1]], "Matrix"))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">55</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">56</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # for level, build PsiVec, the diagonal of the Psi  (weights) matrix</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">57</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  PsiVec &lt;- rep(weights[[Zlevels[1]]], ncol(Zlist[[1]])/nc[1])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">58</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">59</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # Assemble the Zt matrix and psi Vector for levels &gt;1 </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">60</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ZColLevels &lt;- rep(Zlevels[1], ncol(Zlist[[1]]))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">61</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(length(Zlist) &gt; 1) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">62</td>
                    <td class="coverage">32<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(zi in 2:length(Zlist)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">63</td>
                    <td class="coverage">32<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Zt &lt;- rbind(Zt, Matrix::t(as(Zlist[[zi]], "Matrix")))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">64</td>
                    <td class="coverage">32<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      ZColLevels &lt;- c(ZColLevels, rep(Zlevels[zi], ncol(Zlist[[zi]])))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">65</td>
                    <td class="coverage">32<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      PsiVec &lt;- c(PsiVec, rep(weights[[Zlevels[zi]]], ncol(Zlist[[zi]])/nc[Zlevels[zi]-1]))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">66</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">67</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">68</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"> </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">69</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # get unit weights</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">70</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  W0 &lt;- weights[[1]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">71</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Psi &lt;- Diagonal(n=nrow(Zt), x=PsiVec) #matrix of weights at level one</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">72</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Psi12 &lt;- Diagonal(n=nrow(Zt), x=sqrt(PsiVec)) #matrix of square root of level one weights</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">73</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  W &lt;- Diagonal(x=(W0))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">74</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  W12 &lt;- Diagonal(x=sqrt(W0))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">75</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">76</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # calculate  conditional weights matrix where level one weights are scaled by level two wieghts</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">77</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  W12cDiag &lt;- W0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">78</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  L1groups &lt;- unique(groupID[,1])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">79</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(gi in 1:length(L1groups)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">80</td>
                    <td class="coverage">618<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    rowsGi &lt;- groupID[,1] == L1groups[gi]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">81</td>
                    <td class="coverage">618<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    W12cDiag[rowsGi] &lt;- sqrt(W12cDiag[rowsGi] / weights[[2]][gi])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">82</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">83</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  W12c &lt;- Diagonal(x=W12cDiag)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">84</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Z &lt;- Matrix::t(Zt)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">85</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  options(Matrix.quiet.qr.R=TRUE) #supress extra print outs </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">86</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">87</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  M0 &lt;- Matrix(data=0, ncol=ncol(X), nrow=nrow(Zt))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">88</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">89</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # to build the Z we need iDelta, which requires a theta.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">90</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # but theta changes by evaluation. So build a pseudo-Delta (not actual theta)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">91</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # only to allow Z to be cached. iDelta is needed only for dimensions,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">92</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # no values are used.</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">93</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  iDelta &lt;- Delta &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">94</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  levels &lt;- max(lmeVarDF$level)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">95</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for (l in 2:levels) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">96</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #set up matrix of zeros with rows and columns for each random effect</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">97</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #number of random effect is the number of variance terms at that level (not including covariance terms )</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">98</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    n_ref_lev  &lt;- nrow(lmeVarDF[lmeVarDF$level==l &amp; is.na(lmeVarDF$var2),] ) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">99</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    lambda_i  &lt;- matrix(0,nrow=n_ref_lev,ncol=n_ref_lev)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">100</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    row.names(lambda_i) &lt;- lmeVarDF[lmeVarDF$level==l &amp; is.na(lmeVarDF$var2),"var1"]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">101</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    colnames(lambda_i) &lt;- lmeVarDF[lmeVarDF$level==l &amp; is.na(lmeVarDF$var2),"var1"]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">102</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #get only v for this level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">103</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    group &lt;- lmeVarDF[lmeVarDF$level==l ,"grp"][1]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">104</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    v_lev &lt;- v0[grep(paste0("^",group,"."),names(v0))]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">105</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #fill in lambda_i from theta using names</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">106</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for (vi in 1:length(v_lev)){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">107</td>
                    <td class="coverage">386<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      row_index &lt;- strsplit(names(v_lev[vi]),".",fixed=TRUE)[[1]][2]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">108</td>
                    <td class="coverage">386<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      col_index &lt;- ifelse(length(strsplit(names(v_lev[vi]),".",fixed=TRUE)[[1]])&gt;2, strsplit(names(v_lev[vi]),".",fixed=TRUE)[[1]][3], row_index)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">109</td>
                    <td class="coverage">386<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lambda_i[row_index,col_index] &lt;- v_lev[vi]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">110</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">111</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    fixed &lt;- solveFix(lambda_i) # correct non-invertable matrixes to nearby matrixes</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">112</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    iDelta[[l]] &lt;- fixed$lambda</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">113</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Delta[[l]] &lt;- fixed$lambdaInv</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">114</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } # end for (l in 2:levels)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">115</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ZiAl &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">116</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  l0 &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">117</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in 1:ncol(groupID)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">118</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    l0 &lt;- c(l0, list(NULL))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">119</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">120</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  uvl &lt;- lapply(unique(groupID[ , ncol(groupID)]), function(tid) { l0 } )</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">121</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  uv0 &lt;- 1:ncol(Z)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">122</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # build Z to cache it</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">123</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(level in 1:ncol(groupID)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">124</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    groups &lt;- unique(groupID[,level])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">125</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Deltai &lt;- Delta[[level+1]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">126</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    topLevel &lt;- level == ncol(groupID)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">127</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Zl &lt;- Z[,ZColLevels==(level+1),drop=FALSE] # level l Z</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">128</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    uv0l &lt;- uv0[ZColLevels==(level+1)] # base of possible RE for every group at this level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">129</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    goalN &lt;- length(uv0l)/length(groups)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">130</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(gi in 1:length(groups)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">131</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # get Z rows</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">132</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Zrows &lt;- groupID[,level] == groups[gi]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">133</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(level == 1 || level &lt; ncol(groupID)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">134</td>
                    <td class="coverage">618<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(!topLevel) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">135</td>
                    <td class="coverage">216<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          lp1 &lt;- unique(groupID[Zrows,level+1])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">136</td>
                    <td class="coverage">216<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          if(length(lp1) &gt; 1) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">137</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">            stop("Not a nested model; WeMix only fits nested models.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">138</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">139</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">140</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">141</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # filter to the rows for this group, also filter to just columns</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">142</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # for this level of the model</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">143</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # Zi, used for forming ZiA (stored in ZiAl)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">144</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # Zil, used for finding pointers (stored in uvl)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">145</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(level == 1 || level &lt; ncol(groupID)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">146</td>
                    <td class="coverage">618<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Zi &lt;- Z[Zrows,,drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">147</td>
                    <td class="coverage">618<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Zil &lt;- Zl[Zrows,,drop=FALSE] </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">148</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">149</td>
                    <td class="coverage">52<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Zil &lt;- Zi &lt;- Zl[Zrows,,drop=FALSE] # Zi associated with the random effect (~ Z_g in the specs)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">150</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">151</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # within columns for this level, only the non-zero columns</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">152</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # regard this unit, so filter it thusly</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">153</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # the below code uses the pointers from the sparse matrix to identify non zero rows</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">154</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # it is equivalent to</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">155</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # Zcols &lt;- apply(Zi,2,nozero)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">156</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">157</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(.hasSlot(Zi,"p")){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">158</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        z_pointers &lt;- Zi@p</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">159</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        len_pointers &lt;- length(z_pointers)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">160</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Zcols &lt;- which(z_pointers[1:(len_pointers-1)]  - z_pointers[2:len_pointers] !=  0) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">161</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        z_pointers &lt;- Zil@p</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">162</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        len_pointers &lt;- length(z_pointers)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">163</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Zcolsl &lt;- which(z_pointers[1:(len_pointers-1)]  - z_pointers[2:len_pointers] !=  0) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">164</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">165</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Zcols &lt;- apply(Zi, 2, nozero)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">166</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Zcolsl &lt;- apply(Zil, 2, nozero)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">167</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">168</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(length(Zcolsl) &lt; goalN) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">169</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # if there is a Z column that was identified</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">170</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(length(Zcolsl) &gt; 0) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">171</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # grab the name of this group</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">172</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          colname &lt;- colnames(Zil)[Zcolsl[1]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">173</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # and select all columns with that name</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">174</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          Zcols &lt;- (1:ncol(Z))[colnames(Z) == colname]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">175</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          Zcolsl &lt;- (1:ncol(Z))[colnames(Z) == colname &amp; ZColLevels==(level+1)]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">176</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          if(length(Zcols) != goalN) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">177</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">            stop("Unable to construct Z matrix.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">178</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">179</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        } else {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">180</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # Z is entirely 0, so we can just take the first goalN columns</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">181</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # because we know they are all 0</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">182</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          Zi &lt;- Zil &lt;- Zi[,1:goalN,drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">183</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          Zcols &lt;- Zcolsl &lt;- NULL</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">184</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">185</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } # end if(length(Zcolsl) &lt; goalN)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">186</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(!is.null(Zcols)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">187</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # subset Zi to just columns for this level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">188</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Zi &lt;- Zi[,Zcols,drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">189</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">190</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # uvi is the column indexes for Zi for this group, at this level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">191</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      uvi &lt;- uv0l[Zcolsl]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">192</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">193</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(level == 1 || level &lt; ncol(groupID)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">194</td>
                    <td class="coverage">618<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ZiA &lt;- W12cDiag[Zrows] * Zi</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">195</td>
                    <td class="coverage">618<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ZiAl &lt;- c(ZiAl, list(ZiA))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">196</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">197</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      tgi &lt;- groupID[groupID[,level]==groups[gi],ncol(groupID)][1]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">198</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # store the Z columns for REs at this level for this group in uvl</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">199</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # for non-top level, this should be many REs.</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">200</td>
                    <td class="coverage">670<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      uvl[[tgi]][[level]] &lt;- c(uvl[[tgi]][[level]], list(uvi))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">201</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } # end for(gi in 1:length(groups))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">202</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } # end for(level in 1:ncol(groupID))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">203</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">204</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  preKR &lt;- lapply(2:levels, function(l) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">205</td>
                    <td class="coverage">276<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    diag(1, unique(lmeVarDF[lmeVarDF$level==l &amp; is.na(lmeVarDF$var2),"ngrp"]))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">206</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">207</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">208</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  function(v, verbose=FALSE, beta=NULL, sigma=NULL, robustSE=FALSE, returnBetaf=FALSE, getGrad=FALSE, lndetLz0u=TRUE) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">209</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    beta0 &lt;- beta</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">210</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    sigma0 &lt;- sigma</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">211</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    omegaVec &lt;- v</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">212</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">213</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #Create list delta and lambda Matrixes for each level</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">214</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # iDelta is the inverse Delta (lambda pre kronecker) for forming VC estimates in the end</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">215</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    iDelta &lt;- Delta &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">216</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    lambda_by_level &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">217</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">218</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    levels &lt;- max(lmeVarDF$level)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">219</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">   </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">220</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for (l in 2:levels){</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">221</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #set up matrix of zeros with rows and columns for each random effect</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">222</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #number of random effect is the number of variance terms at that level (not including covariance terms )</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">223</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      n_ref_lev &lt;- nrow(lmeVarDF[lmeVarDF$level==l &amp; is.na(lmeVarDF$var2),] ) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">224</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lambda_i &lt;- matrix(0, nrow=n_ref_lev, ncol=n_ref_lev)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">225</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      row.names(lambda_i) &lt;- lmeVarDF[lmeVarDF$level==l &amp; is.na(lmeVarDF$var2), "var1"]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">226</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      colnames(lambda_i) &lt;- lmeVarDF[lmeVarDF$level==l &amp; is.na(lmeVarDF$var2), "var1"]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">227</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">228</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #get only v for this level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">229</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      group &lt;- lmeVarDF[lmeVarDF$level==l, "grp"][1]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">230</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      v_lev &lt;- v[grep(paste0("^",group,"."), names(v))]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">231</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">232</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #fill in lambda_i from theta using names</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">233</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for (vi in 1:length(v_lev)){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">234</td>
                    <td class="coverage">5127<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        row_index &lt;- strsplit(names(v_lev[vi]), ".", fixed=TRUE)[[1]][2]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">235</td>
                    <td class="coverage">5127<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        col_index &lt;- ifelse(length(strsplit(names(v_lev[vi]), ".", fixed=TRUE)[[1]])&gt;2, strsplit(names(v_lev[vi]), ".", fixed=TRUE)[[1]][3], row_index)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">236</td>
                    <td class="coverage">5127<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        lambda_i[row_index,col_index] &lt;- v_lev[vi]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">237</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">238</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      fixed &lt;- solveFix(lambda_i) # correct non-invertable matrixes to nearby matrixes</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">239</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      iDelta[[l]] &lt;- fixed$lambda</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">240</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Delta[[l]] &lt;- fixed$lambdaInv</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">241</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #assemble blockwise lambda by level matrix </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">242</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lambda_by_level[[l]] &lt;- kronecker(lambda_i, preKR[[l-1]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">243</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">244</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">245</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #Create lambda matrix from diagonal of all lamdas </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">246</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    lambda &lt;- bdiag(lambda_by_level[2:length(lambda_by_level)]) # vignette equation 21</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">247</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">248</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    yaugmented &lt;- c(as.numeric(W12 %*% y), rep(0, nrow(Zt))) # first matrix in vingette equation 25 and 60 </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">249</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">250</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    A &lt;- rbind(cbind(W12 %*% Z %*% lambda, W12 %*% X),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">251</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">               cbind(Psi12,M0)) # second matrix in equation (60)/(25). </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">252</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    qr_a &lt;- qr_(A, allowPermute=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">253</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # equation (26)/ stack vector (u: top part for fixed effects coef estimate, b: bottom part for random effects vector (i.e. of length n_group * n_random_effects)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">254</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    suppressWarnings(ub &lt;- Matrix::qr.coef(qr_a, yaugmented))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">255</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">256</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # get the gradients</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">257</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(getGrad) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">258</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      b &lt;- ub[-(1:ncol(Z))]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">259</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      u &lt;- ub[1:ncol(Z)]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">260</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      R &lt;- chr_(A, qr_a)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">261</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Rrows &lt;- nrow(R)-length(b):1+1</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">262</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Rrows &lt;- Rrows[Rrows &gt; length(u)]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">263</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      RX &lt;- R[Rrows,ncol(R)-length(b):1+1,drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">264</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      db &lt;- beta0 - b</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">265</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      db &lt;- db[colnames(RX)]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">266</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      db[is.na(db)] &lt;- beta0[is.na(db)]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">267</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      res0 &lt;- res &lt;- 0 * db</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">268</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(bi in 1:length(b)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">269</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ei &lt;- 0 * res</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">270</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ei[bi] &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">271</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        #(RX*RX) is elementwise multiplication</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">272</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        res[bi] &lt;- -1*(db[bi]) * sum((RX*RX) %*% ei)/sigma^2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">273</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">274</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">275</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">276</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">277</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # get ln of determinant of Lz matrix (Bates et al. 2015 notation) / calculation of alpha</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">278</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # or the final product in Pinheiro and Bates 2.13 (formula used for weights)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">279</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    lndetLz &lt;- 0 # lndetLz is alpha in the specs</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">280</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    lndetLzg &lt;- list() # by top level group lnldetLz</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">281</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # used to find columns with no-non-zero elements</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">282</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # grab and the random effect vector</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">283</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    u &lt;- ub[1:ncol(Z)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">284</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(lndetLz0u) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">285</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # only evaluate all of this if we do not already have an lnldetZ value</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">286</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(level in 1:ncol(groupID)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">287</td>
                    <td class="coverage">2967<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        groups &lt;- unique(groupID[ , level])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">288</td>
                    <td class="coverage">2967<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Deltai &lt;- Delta[[level+1]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">289</td>
                    <td class="coverage">2967<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        sDeltai0 &lt;- as(Delta[[level+1]], "sparseMatrix")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">290</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # R11 notation from Bates and Pinheiro, 1998</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">291</td>
                    <td class="coverage">2967<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        R11 &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">292</td>
                    <td class="coverage">2967<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        topLevel &lt;- level == ncol(groupID)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">293</td>
                    <td class="coverage">2967<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(gi in 1:length(groups)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">294</td>
                    <td class="coverage">21132<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          if(level == 1 || level &lt; ncol(groupID)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">295</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # get Zi</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">296</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            ZiA &lt;- ZiAl[[gi]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">297</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            if(!topLevel) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">298</td>
                    <td class="coverage">8820<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              Zrows &lt;- groupID[ , level] == groups[gi]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">299</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              # unit ID for level above this</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">300</td>
                    <td class="coverage">8820<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              lp1 &lt;- unique(groupID[Zrows, level+1])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">301</td>
                    <td class="coverage">8820<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              qp1 &lt;- nrow(Delta[[level+2]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">302</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">303</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            qi &lt;- nrow(Deltai) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">304</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            #shape delta, used to rbind like this:</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">305</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            #Delta0 &lt;- Matrix(data=0, nrow=qi, ncol=ncol(ZiA)-ncol(Deltai))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">306</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            #Delta0 &lt;- sparseMatrix(i=integer(0), j=integer(0), dims=c(qi, ncol(ZiA)-ncol(Deltai)))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">307</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            #ZiA &lt;- rbind(ZiA, cbind(Deltai, Delta0))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">308</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # expand sDeltai as if we rbinded, much faster</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">309</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            sDeltai &lt;- sDeltai0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">310</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            if(ncol(ZiA) &lt; ncol(sDeltai)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">311</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">              ZiA &lt;- cbind(ZiA, matrix(0, nrow=nrow(ZiA), ncol=ncol(sDeltai) - ncol(ZiA)))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">312</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">313</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              sDeltai@Dim &lt;- c(sDeltai@Dim[1], sDeltai@Dim[2] + ncol(ZiA) - ncol(Deltai))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">314</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              sDeltai@Dimnames[[2]] &lt;- rep("", sDeltai@Dim[2])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">315</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              sDeltai@p &lt;- c(sDeltai@p, rep(max(sDeltai@p), ncol(ZiA) - ncol(Deltai)))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">316</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">317</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # rbind manually, used to do this:</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">318</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            ZiA &lt;- rbind2(ZiA, sDeltai)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">319</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # in this section we decompose Zi * A using qr decomposition,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">320</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # following equation 43 in the vingette.</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">321</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            ZiAR &lt;- qr_qrr(ZiA) # this is faster than getchr(ZiA)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">322</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            R22 &lt;- ZiAR[1:qi, 1:qi, drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">323</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            lndetLzi &lt;- weights[[level+1]][gi] * (- as.numeric(determinant(Deltai)$mod) + sum(log(abs(Matrix::diag(R22)[1:ncol(Deltai)])))) # equation (92)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">324</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # save R11 for next level up, if there is a next level up</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">325</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            if (!topLevel) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">326</td>
                    <td class="coverage">8820<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              R11i &lt;- sqrt(weightsC[[level+1]][gi])*ZiAR[-(1:qi),qi+1:qp1, drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">327</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              # load in R11 to the correct level</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">328</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              # this if/else allows lp1 to be out of order</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">329</td>
                    <td class="coverage">8820<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              if(length(R11) &lt; lp1 || is.null(R11[[lp1]])) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">330</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                # there was no R11, so start it off with this R11</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">331</td>
                    <td class="coverage">2076<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                R11[[lp1]] &lt;- R11i</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">332</td>
                    <td class="coverage">2076<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                lndetLzg[[lp1]] &lt;- lndetLzi</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">333</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">334</td>
                    <td class="coverage">6744<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                R11[[lp1]] &lt;- rbind(R11[[lp1]], R11i)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">335</td>
                    <td class="coverage">6744<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                lndetLzg[[lp1]] &lt;- lndetLzg[[lp1]] + lndetLzi</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">336</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">337</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">338</td>
                    <td class="coverage">10236<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              lndetLzg[[groups[gi]]] &lt;- lndetLzi</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">339</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">340</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          } # end if(level == 1 || level &lt; ncol(groupID))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">341</td>
                    <td class="coverage">21132<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          if (level&gt;=2) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">342</td>
                    <td class="coverage">2076<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            ZiA &lt;- rbind(pR11[[groups[gi]]], Deltai)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">343</td>
                    <td class="coverage">2076<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            R &lt;- qr_qrr(ZiA) # probably faster than getchr(ZiA)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">344</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # weight the results</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">345</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            # groups goes back to this unit</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">346</td>
                    <td class="coverage">2076<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            lndetLzi &lt;- weights[[level+1]][groups[gi]]*(- (as.numeric(determinant(Deltai)$mod)) +</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">347</td>
                    <td class="coverage">2076<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        sum(log(abs(Matrix::diag(R)[1:ncol(Deltai)])))) # equation 92</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">348</td>
                    <td class="coverage">2076<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            lndetLzg[[groups[gi]]] &lt;- lndetLzg[[groups[gi]]] + lndetLzi</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">349</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">350</td>
                    <td class="coverage">21132<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          lndetLz &lt;- lndetLz + lndetLzi</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">351</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        } # end for(gi in 1:length(groups))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">352</td>
                    <td class="coverage">2967<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(level &lt; ncol(groupID)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">353</td>
                    <td class="coverage">642<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          pR11 &lt;- R11</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">354</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        } </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">355</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } #end for(level in 1:ncol(groupID))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">356</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } # end if(is.null(lndetLz0))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">357</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # this is the beta vector</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">358</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    b &lt;- ub[-(1:ncol(Z))]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">359</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(!is.null(beta0)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">360</td>
                    <td class="coverage">2224<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(length(b) != length(beta0)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">361</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        stop(paste0("The argument ", dQuote("beta"), " must be a vector of length ", length(b), "."))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">362</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">363</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">364</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">365</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # wrap the random effect vector to matrix format so that each row regards one group</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">366</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    bb &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">367</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    vc &lt;- matrix(nrow=1+length(v), ncol=1+length(v))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">368</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    u0 &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">369</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(li in 2:length(lambda_by_level)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">370</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lli &lt;- lambda_by_level[[li]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">371</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      ni &lt;- nrow(lli)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">372</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      bb[[li]] &lt;- lli %*% u[u0 + 1:ni]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">373</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      u0 &lt;- u0 + ni</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">374</td>
                    <td class="coverage">3473<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      vc[li,li] &lt;- 1/(ni) * sum((bb[[li]])^2) # mean already 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">375</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">376</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">377</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # the discrepancy ||W12(y-Xb-Zu)||^2 + ||Psi(u)||^2</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">378</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    discrep &lt;- discf(y, Zt, X, lambda, u, Psi12, W12, b)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">379</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # the R22 matrix, bottom right of the big R, conforms with b</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">380</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    R &lt;- chr_(A, qr_a)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">381</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Rrows &lt;- nrow(R) - length(b):1 +1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">382</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Rrows &lt;- Rrows[Rrows &gt; length(u)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">383</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    RX &lt;- R[Rrows, ncol(R) - length(b):1 +1, drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">384</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    nx &lt;- sum(W0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">385</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # residual</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">386</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    sigma &lt;- ifelse(is.null(sigma0), sqrt(discrep / nx), sigma0)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">387</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    dev &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">388</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(lndetLz0u) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">389</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # lndetLz may be a Matrix, convert it</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">390</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      dev &lt;- 2*as.numeric(lndetLz)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">391</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else{</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">392</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      dev &lt;- 2*lndetLz0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">393</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lndetLz &lt;- lndetLz0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">394</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">395</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    dev &lt;- dev + nx*log(2*pi*(sigma^2)) + discrep/sigma^2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">396</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # fix rank-deficent RX by setting values to 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">397</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    Rprob &lt;- !rkfnS(R) # do the diagonals add to rank</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">398</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # to be on the diagonal of RX, it needs to both be a row and a column</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">399</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    RXprob &lt;- Rprob[intersect(Rrows, ncol(R)-length(b):1+1)] # for RX</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">400</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(any(RXprob)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">401</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Matrix::diag(RX)[RXprob] &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">402</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">403</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # add R22 term if beta is not beta-hat</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">404</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(returnBetaf) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">405</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # a function that returns the lnl varying beta only</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">406</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      f &lt;- function(beta0) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">407</td>
                    <td class="coverage">908<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        db &lt;- beta0 - b</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">408</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # for an illconditioned (or uninvertable) A-matrix there will be NAs</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">409</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # if there is an NA, then use the beta value--that is, assume betahat is 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">410</td>
                    <td class="coverage">908<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        db[is.na(db)] &lt;- beta0[is.na(db)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">411</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # RX will be reordered if X has all 0 columns, db needs to be rearanged similarly</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">412</td>
                    <td class="coverage">908<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        db &lt;- db[colnames(RX)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">413</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # Matrix::qr.R makes bad colnames, fix that</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">414</td>
                    <td class="coverage">908<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        db[is.na(db)] &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">415</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # deviance</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">416</td>
                    <td class="coverage">908<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        dev &lt;- dev + sum( (RX %*% db)^2 )/sigma^2</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">417</td>
                    <td class="coverage">908<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        res &lt;- return(dev/-2)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">418</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">419</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      return(f)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">420</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">421</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # add in term for beta not beta-hat</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">422</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    db &lt;- 0 * b</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">423</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    dbTerm &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">424</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(!is.null(beta0)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">425</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # difference in beta and betahat (b)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">426</td>
                    <td class="coverage">1770<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      db &lt;- beta0 - b</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">427</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # if there is an NA, then use the beta value--that is, assume betahat is 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">428</td>
                    <td class="coverage">1770<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      db[is.na(db)] &lt;- beta0[is.na(db)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">429</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # RX will be reordered if X has all 0 columns, db needs to be rearanged similarly</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">430</td>
                    <td class="coverage">1770<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      db &lt;- db[colnames(RX)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">431</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # deviance</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">432</td>
                    <td class="coverage">1770<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      dbTerm &lt;- sum( (RX %*% db)^2 )/sigma^2</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">433</td>
                    <td class="coverage">1770<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      dev &lt;- dev + dbTerm</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">434</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">435</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #Variance of Beta, from Bates et.al. 2015</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">436</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # qr matrix rank, tolerance value and method based on Matrix::rankMatrix API</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">437</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(rkfn(R) == ncol(A)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">438</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      RXi &lt;- Matrix::solve(RX)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">439</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cov_mat &lt;- (sigma^2) * RXi %*% Matrix::t(RXi)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">440</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      varBeta &lt;- Matrix::diag(cov_mat)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">441</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">442</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      cov_mat &lt;- NULL</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">443</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      varBeta &lt;- rep(NA, length(b))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">444</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">445</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">446</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    sigma &lt;- ifelse(is.null(sigma0), sqrt(discrep / nx), sigma0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">447</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">448</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    res &lt;- list(b=b, u=u, ranef=bb, discrep=discrep, sigma=sigma, dev=dev,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">449</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                lnl=dev/-2, theta=v, varBeta=varBeta, vars=NULL, cov_mat=cov_mat,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">450</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                lndetLz=lndetLz, iDelta=iDelta, db=db, dbTerm=dbTerm, nx=nx, RX=RX, R=R)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">451</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(robustSE) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">452</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #Calculate robust standardize effect</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">453</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # based on the sandwich estimator of Rabe-Hesketh and Skrondal 2006</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">454</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # this whole calculation focuses on calculating the liklihood at the top group level </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">455</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      fgroupID &lt;- groupID[ , ncol(groupID)] </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">456</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      uf &lt;- unique(fgroupID) # unique final groupIDs</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">457</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # store lnl to check later</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">458</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lnli2 &lt;- lnli &lt;- vector(length=length(uf))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">459</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Jacobian &lt;- matrix(NA, nrow=length(uf), ncol=length(b)+length(v)+1)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">460</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      bwiL &lt;- list()</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">461</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #this code block seperates wieghts into the set of weights belonging to each top level group </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">462</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # components of discrep</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">463</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      wres &lt;- W12 %*% (y - Matrix::t(Zt) %*% lambda %*% u - X %*% b) # residual</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">464</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      ures &lt;- Psi12 %*% u # augmented ehat</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">465</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(gi in 1:length(uf)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">466</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        giuf &lt;- uf[gi] # index for this unit</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">467</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        sgi &lt;- fgroupID == giuf # subset for group gi</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">468</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        weightsPrime &lt;- list(weights[[1]][sgi])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">469</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        weightsCPrime &lt;- list(weightsC[[1]][sgi])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">470</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(i in 2:length(weights)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">471</td>
                    <td class="coverage">253<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          theseGroups &lt;- unique(groupID[sgi, i-1])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">472</td>
                    <td class="coverage">253<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          weightsPrime[[i]] &lt;- weights[[i]][theseGroups]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">473</td>
                    <td class="coverage">253<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          weightsCPrime[[i]] &lt;- weightsC[[i]][theseGroups]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">474</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">475</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        condenseZ &lt;- function(z, uvi) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">476</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          res &lt;- z[sgi, uvi, drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">477</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">478</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        groupIDi &lt;- groupID[sgi,,drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">479</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        lmeVarDFi &lt;- lmeVarDF</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">480</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        lmeVarDFi$ngrp[lmeVarDFi$level==1] &lt;- sum(sgi)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">481</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(i in 2:length(weights)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">482</td>
                    <td class="coverage">253<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          lmeVarDFi$ngrp[lmeVarDFi$level==i] &lt;- length(unique(groupIDi[,i-1]))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">483</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">484</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        #calculate the group level likelihood by applying the function to only the x or y within the group indexed by sgi</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">485</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # overall dev (lnl=dev/-2) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">486</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # dev &lt;- 2*lndetLz + nx*log(2*pi*(sigma^2)) + discrep/sigma^2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">487</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # VERIFIED: uvl is mapped to the index ID, so use giuf</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">488</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        lnli2[gi] &lt;- 2*lndetLzg[[giuf]]/-2 + sum(sum(W0[sgi]))*log(2*pi*sigma^2)/-2 + sum(wres[sgi]^2)/sigma^2/-2 + sum(ures[unlist(uvl[[giuf]])]^2)/sigma^2/-2</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">489</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # zero index for this level, used in Zlist argument a few lines down</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">490</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        ind0 &lt;- c(0,cumsum(lapply(Zlist, ncol)))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">491</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        bwi &lt;- analyticSolve(y=y[sgi], X=X[sgi,,drop=FALSE],</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">492</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  Zlist=lapply(1:length(Zlist), function(lvl) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">493</td>
                    <td class="coverage">253<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                      cols &lt;- sort(unlist(uvl[[giuf]][[lvl]])) - ind0[lvl]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">494</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                      tryCatch(Zlist[[lvl]][sgi, cols, drop=FALSE], error=function(e){stop("Could not build Zlist.")})</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">495</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                    }),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">496</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  Zlevels=Zlevels,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">497</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  weights=weightsPrime,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">498</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  weightsC=weightsCPrime,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">499</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  groupID=groupIDi,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">500</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  lmeVarDF=lmeVarDFi,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">501</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  v0=v,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">502</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  lndetLz0=lndetLzg[[giuf]])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">503</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        tryCatch(lnli[gi] &lt;- bwi(v=v, verbose=verbose, beta=b, sigma=sigma, robustSE=FALSE)$lnl,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">504</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 error= function(e) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">505</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                   lnli[gi] &lt;&lt;- NA</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">506</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 })</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">507</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if( abs(lnli2[gi] - lnli[gi]) &gt; 0.001) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">508</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # sometimes Matrix::qr tries to solve a singular system and fails</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">509</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # normally base::qr works in these cases, so use that instead</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">510</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          bwi &lt;- analyticSolve(y=y[sgi], X[sgi,,drop=FALSE],</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">511</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               Zlist=lapply(1:length(Zlist), function(lvl) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">512</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                       cols &lt;- sort(unlist(uvl[[giuf]][[lvl]])) - ind0[lvl]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">513</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                       tryCatch(Zlist[[lvl]][sgi, cols, drop=FALSE], error=function(e){stop("Could not build Zlist.")})</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">514</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                      }),</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">515</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               Zlevels=Zlevels,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">516</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               weights=weightsPrime,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">517</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               weightsC=weightsCPrime,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">518</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               groupID=groupIDi,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">519</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               lmeVarDF=lmeVarDFi,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">520</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               qr_=qr_s,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">521</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               v0=v,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">522</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                               lndetLz0=lndetLzg[[giuf]]) </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">523</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">           bwiL &lt;- c(bwiL, list(bwi))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">524</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">           tryCatch(lnli[gi] &lt;- bwi(v=v, verbose=verbose, beta=b, sigma=sigma, robustSE=FALSE)$lnl,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">525</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                    error= function(e) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">526</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                      lnli[gi] &lt;&lt;- NA</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">527</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                    })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">528</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">529</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">           bwiL &lt;- c(bwiL, list(bwi))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">530</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">531</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">532</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # if the function can be evaluated for this group.</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">533</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(!is.na(lnli[gi])) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">534</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # function for partials with respect to beta</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">535</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          bwiW &lt;- function(bwi, v, sigma, b, ind) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">536</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            bwip &lt;- bwi(v=v, verbose=FALSE,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">537</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        b=b, sigma=sigma,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">538</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                        robustSE=FALSE, returnBetaf=TRUE, lndetLz0u=FALSE)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">539</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            function(par) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">540</td>
                    <td class="coverage">908<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              b[ind] &lt;- par</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">541</td>
                    <td class="coverage">908<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              bwip(b)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">542</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">543</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">544</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # function for partials with respect to theta</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">545</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          bwiT &lt;- function(bwi, v, sigma, t, ind) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">546</td>
                    <td class="coverage">578<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            function(par) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">547</td>
                    <td class="coverage">1156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              if(ind &gt; length(v)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">548</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                sigma &lt;- par</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">549</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">550</td>
                    <td class="coverage">702<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                v[ind] &lt;- par</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">551</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">552</td>
                    <td class="coverage">1156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              bwi(v=v, verbose=FALSE,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">553</td>
                    <td class="coverage">1156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  b=b, sigma=sigma, robustSE=FALSE, lndetLz0u=TRUE)$lnl</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">554</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">555</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">556</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          if(analyticJacobian) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">557</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">            Jacobian[gi,1:length(b)] &lt;- bwi(v=v, sigma=sigma, b=b, robustSE=FALSE, getGrad=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">558</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">559</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            for(j in 1:length(b)){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">560</td>
                    <td class="coverage">454<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">              Jacobian[gi,j] &lt;- d(bwiW(bwi, v=v, sigma=sigma, b=b, ind=j), par=b[j])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">561</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">562</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">563</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          for(j in 1:(1+length(v))) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">564</td>
                    <td class="coverage">578<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            v0 &lt;- c(v, sigma)[j]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">565</td>
                    <td class="coverage">578<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">            Jacobian[gi,length(b)+j] &lt;- d(bwiT(bwi, v=v, sigma=sigma, b=b, ind=j), par=v0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">566</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">567</td>
                    <td class="coverage">244<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        } else { # end if(!is.na(lnli[gi]))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">568</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          warning("Some top level units variance component cannot be computed. Try combining top level units.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">569</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">570</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">571</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lnl1 &lt;- dev/-2</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">572</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      lnliT &lt;- sum(lnli)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">573</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(!is.na(lnliT)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">574</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if( abs(lnl1 - lnliT) &gt; 0.5) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">575</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # this would be a large difference</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">576</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          warning("Likelihood estimated at the top group level and summed disagrees with overall likelihood. Standard errrors may not be accurate.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">577</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">578</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">579</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      J &lt;- matrix(0,ncol=ncol(Jacobian), nrow=ncol(Jacobian))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">580</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      nr &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">581</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # a cross product that removes rows (groups) where lnl cannot be evaluated</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">582</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for (i in 1:nrow(Jacobian)){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">583</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(!is.na(lnli[i])) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">584</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          J  &lt;- J  + Jacobian[i,]  %*% t(Jacobian[i,])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">585</td>
                    <td class="coverage">227<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          nr &lt;- nr + 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">586</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">587</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">588</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      J &lt;- (nr/(nr-1))*J</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">589</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # just beta part of J</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">590</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      varBetaRobust &lt;- as(cov_mat %*% J[1:length(b), 1:length(b)] %*% cov_mat , "matrix")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">591</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      colnames(J) &lt;- rownames(J) &lt;- c(names(b), names(v), "sigma")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">592</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      res &lt;- c(res, list(varBetaRobust=varBetaRobust,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">593</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         seBetaRobust=sqrt(diag(varBetaRobust)), iDelta=iDelta,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">594</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                         Jacobian=J))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">595</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">596</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">597</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">598</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">599</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">600</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># helpers just for analyticSolve</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">601</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">602</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#discrepency function for calculating least squares solution. Follows from Bates et al. 2015 eq 14 and 15</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">603</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">discf &lt;- function(y, Zt, X, lambda, u, Psi12, W12, b) { # return ehatT * ehat</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">604</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(any(is.na(b))) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">605</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    X &lt;- X[,!is.na(b),drop=FALSE]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">606</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    b &lt;- b[!is.na(b)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">607</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">608</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  wres &lt;- W12 %*% (y - Matrix::t(Zt) %*% lambda %*% u - X %*% b) # residual</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">609</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ures &lt;- Psi12 %*% u # augmented ehat</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">610</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  as.numeric(sum(wres^2) + sum(ures^2))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">611</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">612</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">613</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># the sparse QR permultes rows, which causes problems for the method of solving</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">614</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># used in WeMix. qr_0 is robust to that, and wehn allowPermulte=TRUE it will</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">615</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># sense that Matrix::qr did that and instead use base::qr.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">616</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">qr_0 &lt;- function(X, allowPermute=FALSE) { </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">617</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # Matrix::qr does not do well in this case, use base::qr</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">618</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(nrow(X) &lt; ncol(X)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">619</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # here base QR elegantly removes coefficients and returns NAs in their place</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">620</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    X &lt;- as(X, "matrix")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">621</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(base::qr(X))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">622</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">623</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # try to use Matrix</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">624</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  qr1 &lt;- Matrix::qr(X)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">625</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(allowPermute || inherits(qr1,"qr")) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">626</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # if allowPermute (allow Matrix::qr to use permutations) or this is a base::qr, just return</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">627</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(qr1)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">628</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">629</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # do not allow permutations. Test if they happened. If they did, use base::qr instead</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">630</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if( any(range( order(qr1@q) - 0:max(qr1@q)) &gt; 0) ) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">631</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    X &lt;- as(X, "matrix")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">632</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(base::qr(X))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">633</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">634</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # base case, return the non-permuted Matrix::qr result</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">635</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(qr1)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">636</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">637</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">638</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># just use base:qr when qr_s is selected</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">639</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">qr_s &lt;- function(X, allowPermute=FALSE) { </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">640</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  X &lt;- as(X, "matrix")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">641</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(base::qr(X))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">642</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">643</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">644</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># run QR and return R</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">645</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">qr_qrr &lt;- function(X) { </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">646</td>
                    <td class="coverage">21132<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(nrow(X) &lt; ncol(X)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">647</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    X &lt;- as(X, "matrix")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">648</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(base::qr.R(base::qr(X)))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">649</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">650</td>
                    <td class="coverage">21132<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  qr1 &lt;- Matrix::qr(X)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">651</td>
                    <td class="coverage">21132<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(inherits(qr1,"qr")) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">652</td>
                    <td class="coverage">2076<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(base::qr.R(qr1))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">653</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">654</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # check for permutations and use base if there are some</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">655</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if( any(range( order(qr1@q) - 0:max(qr1@q)) &gt; 0) ) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">656</td>
                    <td class="coverage">19056<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(base::qr.R(base::qr(X)))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">657</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">658</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # we can use Matrix:qr</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">659</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(Matrix::qrR(qr1, backPermute=FALSE))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">660</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">661</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">662</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># return R from a QR</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">663</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">qrr_ &lt;- function(QR) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">664</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(inherits(QR, "qr")) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">665</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(base::qr.R(QR))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">666</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">667</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(Matrix::qrR(QR, backPermute=FALSE))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">668</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">669</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">670</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">671</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># run a chol of AtA and return R</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">672</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">getchr &lt;- function(A) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">673</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #sometimes we pass an illconditioned matrix and don't care, so eat the warnings</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">674</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  suppressWarnings(m0 &lt;- as(Matrix::chol(Matrix::t(A) %*% A, pivot=FALSE), "Matrix"))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">675</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  colnames(m0) &lt;- colnames(A) # allowable because pivot=FALSE</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">676</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(m0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">677</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">678</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">679</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># get R robust to uninvertable matrixes, falling back on the qr when needed</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">680</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">chr_ &lt;- function(A, qr) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">681</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  m &lt;- tryCatch(getchr(A),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">682</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                error=function(e) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">683</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  if(inherits(qr,"qr")) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">684</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                    return(base::qr.R(qr))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">685</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">686</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                    A &lt;- as(A, "matrix")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">687</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                    return(base::qr.R(base::qr(A)))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">688</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">689</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                })</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">690</td>
                    <td class="coverage">2779<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(m)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">691</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">692</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">693</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># rank of a qr</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">694</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">rkfn &lt;- function(qr_R) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">695</td>
                    <td class="coverage">2325<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  sum(rkfnS(qr_R))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">696</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">697</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">698</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># is this element of the diag &gt; the tolerance (does it add a value to rank)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">699</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">rkfnS &lt;- function(qr_R) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">700</td>
                    <td class="coverage">5104<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  d &lt;- Matrix::diag(qr_R)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">701</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # add 1 to tolerance to account for imprecision in .Machine$double.eps</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">702</td>
                    <td class="coverage">5104<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  tol &lt;- (length(d)+1) * .Machine$double.eps</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">703</td>
                    <td class="coverage">5104<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  proposed &lt;- abs(d) &gt; max(abs(d)) * tol</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">704</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # the condition is a bit different for a "matrix" than a "Matrix"</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">705</td>
                    <td class="coverage">5104<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(is.matrix(qr_R)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">706</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # increase until condition number of remaining matrix agrees with rank from base package</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">707</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    while(sum(proposed) &gt; 0 &amp; rcond(qr_R[proposed,proposed]) &lt;= .Machine$double.eps) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">708</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      proposed[proposed][which.min(abs(d[proposed]))] &lt;- FALSE</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">709</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">710</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">711</td>
                    <td class="coverage">5104<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(proposed)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">712</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">713</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">714</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># a wrapper for analyticSolve that allows it to be called from an optimizer. Takes the same arguments as analyticSolve. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">715</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param weights level-1 weights</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">716</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param y outcome measure. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">717</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param X the X matrix.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">718</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param Zlist, a list of matrixes with the Z values for each level. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">719</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param Zlevels, the level corresponding to each matrix in Zlist. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">720</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param weights a list of unconditional weights for each model level. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">721</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param weightsC a list of conditional weights for each model level. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">722</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param  groupID a matrix containing the group ids for each level in the model. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">723</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param  lmeVardf a dataframe containing the variances and covariance of the random effects, in the same format as returned from lme. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">724</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom Matrix Diagonal Matrix</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">725</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom methods as</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">726</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">devG &lt;- function(y, X, Zlist, Zlevels, weights, weightsC=weights, groupID, lmeVarDF, v0) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">727</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  bs &lt;- analyticSolve(y=y, X=X, Zlist=Zlist, Zlevels=Zlevels, weights=weights, weightsC=weightsC, lmeVarDF=lmeVarDF,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">728</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">           groupID=groupID, v0=v0)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">729</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  function(v, getBS=FALSE) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">730</td>
                    <td class="coverage">555<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(getBS) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">731</td>
                    <td class="coverage">17<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      return(bs)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">732</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">733</td>
                    <td class="coverage">538<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    bhat &lt;- bs(v)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">734</td>
                    <td class="coverage">538<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(bhat$dev)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">735</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">736</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">737</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">738</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">solveFix &lt;- function(lambda_i) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">739</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # try QR based fix, which may fail</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">740</td>
                    <td class="coverage">3749<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  res &lt;- try(qrFix(lambda_i), silent=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">741</td>
                    <td class="coverage">3749<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(inherits(res, "try-error")) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">742</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    res &lt;- try(eigenFix(lambda_i), silent=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">743</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(inherits(res, "try-error")) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">744</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      return(svdFix(lambda_i))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">745</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">746</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">747</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } else{</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">748</td>
                    <td class="coverage">3749<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">749</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">750</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # then try eigenvalue based fix</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">751</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">752</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">753</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># return a matrix and its inverse, being robust to 0s</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">754</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">qrFix &lt;- function(lambda_i) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">755</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #set any 0s to smallest non zero number to enable solve in next step</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">756</td>
                    <td class="coverage">3749<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  diag(lambda_i)[abs(diag(lambda_i)) &lt; .Machine$double.eps] &lt;- .Machine$double.eps</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">757</td>
                    <td class="coverage">3749<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(list(lambda=lambda_i, lambdaInv=solve(lambda_i)))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">758</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">759</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">760</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># return a matrix and its inverse, being robust to 0s</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">761</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">eigenFix &lt;- function(lambda_i) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">762</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # qrfix was singular, so use eigen</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">763</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  eig &lt;- eigen(lambda_i, symmetric=FALSE)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">764</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  eigV &lt;- eig$values</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">765</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  eigV[abs(eigV) &lt; 2 * .Machine$double.eps * max(abs(eigV))] &lt;- 2 * .Machine$double.eps * max(abs(eigV))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">766</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  eigLambdai &lt;- diag(1/eigV, nrow=length(eigV))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">767</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  eigQ &lt;- eig$vectors</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">768</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  eigQinv &lt;- solve(eigQ)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">769</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  eigInv &lt;- eigQ %*% eigLambdai %*% eigQinv</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">770</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  eig &lt;- eigQ %*% diag(eigV, nrow=length(eigV)) %*% eigQinv</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">771</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  dimnames(eig) &lt;- dimnames(eigInv) &lt;- dimnames(lambda_i)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">772</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(list(lambda=eig, lambdaInv=eigInv))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">773</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">774</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">775</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">svdFix &lt;- function(lambda_i) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">776</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  svdi &lt;- svd(lambda_i)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">777</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  s &lt;- svdi$d</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">778</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  s[s &lt; 2*.Machine$double.eps * max(s)]  &lt;- 2 * .Machine$double.eps * max(s)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">779</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lambda &lt;- svdi$u %*% diag(s) %*% svdi$v</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">780</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lambdaInv &lt;- t(svdi$v) %*% diag(1/s) %*% t(svdi$u)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">781</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(list(lambda=lambda, lambdaInv=lambdaInv))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">782</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="R/drv.R" class="hidden">
              <table class="table-condensed">
                <tbody>
                  <tr class="never">
                    <td class="num">1</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># calculate a numerical central derivative </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">2</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">d &lt;- function(f, par, delta=1E-5) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">3</td>
                    <td class="coverage">1032<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  res &lt;- rep(NA, length(par))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">4</td>
                    <td class="coverage">1032<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in 1:length(par)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">5</td>
                    <td class="coverage">1032<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    d &lt;- rep(0,length(par))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">6</td>
                    <td class="coverage">1032<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    d[i] &lt;- delta/2</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">7</td>
                    <td class="coverage">1032<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    fp &lt;- f(par + d)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">8</td>
                    <td class="coverage">1032<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    fm &lt;- f(par - d)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">9</td>
                    <td class="coverage">1032<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    res[i] &lt;- (fp - fm) / delta</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">10</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">11</td>
                    <td class="coverage">1032<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  res</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">12</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">13</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">14</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># this function finds the Hessian of a function that has an odd return type</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">15</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># x adjusts all of the outputs associated with any x at once</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">16</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># diag = TRUE to calculate the diagonal</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">17</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">getHessian2 &lt;- function(func, x, inputs=1:length(x), f0=NULL, diag=TRUE) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">18</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # use a wide net</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">19</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  k &lt;- length(inputs)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">20</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(is.null(f0)){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">21</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    f0 &lt;- func(x)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">22</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">23</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # do not let h get smaller than the fourth root of the machine precision</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">24</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # but let it scale up when x is large</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">25</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  h &lt;- (abs(x) + 1) * (.Machine$double.eps)^0.25 </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">26</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # derivatives at a larger x (fp, for f plus h) and smaller x (fm for f minus h)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">27</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  hess &lt;- lapply(1:length(f0), </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">28</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                 function(i) { matrix(NA, nrow=k, ncol=k)}  )</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">29</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in 1:k) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">30</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(j in i:k) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">31</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      xpp &lt;- xmm &lt;- xmp &lt;- xpm &lt;- xm &lt;- xp &lt;- x</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">32</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(i!=j) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">33</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # e.g. xpm is x with (x[1], x[2], ..., x[i] + h[i], ..., x[j] - h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">34</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # so the first index (p, in the example) indicates x[i] is incrimented</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">35</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # by h[i] while the second index (m in the example) indicates x[j]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">36</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # is decrimented by h[j].</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">37</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xpp = (x[1], ..., x[i] + h[i], ..., x[j] + h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">38</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xpp[inputs[i]] &lt;- x[inputs[i]] + h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">39</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xpp[inputs[j]] &lt;- x[inputs[j]] + h[inputs[j]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">40</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xmm = (x[1], ..., x[i] - h[i], ..., x[j] - h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">41</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xmm[inputs[i]] &lt;- x[inputs[i]] - h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">42</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xmm[inputs[j]] &lt;- x[inputs[j]] - h[inputs[j]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">43</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xmp = (x[1], ..., x[i] + h[i], ..., x[j] - h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">44</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xpm[inputs[i]] &lt;- x[inputs[i]] + h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">45</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xpm[inputs[j]] &lt;- x[inputs[j]] - h[inputs[j]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">46</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xmp = (x[1], ..., x[i] - h[i], ..., x[j] + h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">47</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xmp[inputs[i]] &lt;- x[inputs[i]] - h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">48</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xmp[inputs[j]] &lt;- x[inputs[j]] + h[inputs[j]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">49</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # find \partial^2 f(x) / \partial x[i] \partial x[j]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">50</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # Start with u(x) = \partial f(x) / \partial x[i] = ( f(xp_i) - f(xm_i)) / (2h_i)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">51</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # and apply that same formula to hess[i,j] = \partial u(x) / \partial x[j]</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">52</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        res &lt;- (func(xpp) - func(xpm) - func(xmp) + func(xmm)) / (4* h[inputs[i]]*h[inputs[j]])</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">53</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(resi in 1:length(res)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">54</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          hess[[resi]][j,i] &lt;- hess[[resi]][i,j] &lt;- res[resi]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">55</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">56</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">57</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(diag) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">58</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # xp = (x[1], ..., x[i] + h[i], ...)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">59</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          xp[inputs[i]] &lt;- x[inputs[i]] + h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">60</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # xm = (x[1], ..., x[i] - h[i], ...)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">61</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          xm[inputs[i]] &lt;- x[inputs[i]] - h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">62</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # xpp = (x[1], ..., x[i] + 2*h[i], ...)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">63</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          xpp[inputs[i]] &lt;- x[inputs[i]] + 2*h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">64</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # xmm = (x[1], ..., x[i] - 2*h[i], ...)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">65</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          xmm[inputs[i]] &lt;- x[inputs[i]] - 2*h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">66</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # the above formula would suggest</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">67</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # (func(xpp) - 2*f0 + func(xmm)) / (4*h[inputs[i]]^2)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">68</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # but this is more o(h^4) as opposed to o(h^2) above,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">69</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # and the diagonal is critical, so use it</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">70</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          res &lt;- (-1*func(xmm) + 16*func(xp) - 30*f0 + 16*func(xm)-1*func(xpp)) / (12*h[inputs[i]]^2)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">71</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          for(resi in 1:length(res)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">72</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">            hess[[resi]][i,i] &lt;- res[resi]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">73</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">74</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">75</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">76</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">77</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">78</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(hess)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">79</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">80</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">81</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This function returns the second derivative of func with</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">82</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># respect to the elements of x as a matrix</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">83</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">getHessian &lt;- function(func, x, inputs=1:length(x), f0=NULL) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">84</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # use a wide net</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">85</td>
                    <td class="coverage">159<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  k &lt;- length(inputs)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">86</td>
                    <td class="coverage">159<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(is.null(f0)){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">87</td>
                    <td class="coverage">33<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    f0 &lt;- func(x)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">88</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">89</td>
                    <td class="coverage">159<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(length(f0) &gt; 1) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">90</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(lapply(1:length(f0),</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">91</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  function(i) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">92</td>
                    <td class="coverage">126<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                    f2 &lt;- function(x) { </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">93</td>
                    <td class="coverage">504<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                      func(x)[i]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">94</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">95</td>
                    <td class="coverage">126<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                    getHessian(f2, x, inputs, f0=f0[i])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">96</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                  }))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">97</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">98</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # do not let h get smaller than the fourth root of the machine precision</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">99</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # but let it scale up when x is large</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">100</td>
                    <td class="coverage">152<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  h &lt;- (abs(x) + 1) * (.Machine$double.eps)^0.25 </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">101</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # derivatives at a larger x (fp, for f plus h) and smaller x (fm for f minus h)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">102</td>
                    <td class="coverage">152<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  hess &lt;- matrix(NA, nrow=k, ncol=k)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">103</td>
                    <td class="coverage">152<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in 1:k) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">104</td>
                    <td class="coverage">188<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(j in i:k) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">105</td>
                    <td class="coverage">235<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      xpp &lt;- xmm &lt;- xmp &lt;- xpm &lt;- xm &lt;- xp &lt;- x</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">106</td>
                    <td class="coverage">235<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(i!=j) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">107</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # e.g. xpm is x with (x[1], x[2], ..., x[i] + h[i], ..., x[j] - h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">108</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # so the first index (p, in the example) indicates x[i] is incrimented</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">109</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # by h[i] while the second index (m in the example) indicates x[j]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">110</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # is decrimented by h[j].</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">111</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xpp = (x[1], ..., x[i] + h[i], ..., x[j] + h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">112</td>
                    <td class="coverage">47<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xpp[inputs[i]] &lt;- x[inputs[i]] + h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">113</td>
                    <td class="coverage">47<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xpp[inputs[j]] &lt;- x[inputs[j]] + h[inputs[j]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">114</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xmm = (x[1], ..., x[i] - h[i], ..., x[j] - h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">115</td>
                    <td class="coverage">47<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xmm[inputs[i]] &lt;- x[inputs[i]] - h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">116</td>
                    <td class="coverage">47<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xmm[inputs[j]] &lt;- x[inputs[j]] - h[inputs[j]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">117</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xmp = (x[1], ..., x[i] + h[i], ..., x[j] - h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">118</td>
                    <td class="coverage">47<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xpm[inputs[i]] &lt;- x[inputs[i]] + h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">119</td>
                    <td class="coverage">47<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xpm[inputs[j]] &lt;- x[inputs[j]] - h[inputs[j]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">120</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xmp = (x[1], ..., x[i] - h[i], ..., x[j] + h[j], ...)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">121</td>
                    <td class="coverage">47<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xmp[inputs[i]] &lt;- x[inputs[i]] - h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">122</td>
                    <td class="coverage">47<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xmp[inputs[j]] &lt;- x[inputs[j]] + h[inputs[j]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">123</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # find \partial^2 f(x) / \partial x[i] \partial x[j]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">124</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # Start with u(x) = \partial f(x) / \partial x[i] = ( f(xp_i) - f(xm_i)) / (2h_i)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">125</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # and apply that same formula to hess[i,j] = \partial u(x) / \partial x[j]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">126</td>
                    <td class="coverage">47<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        hess[j,i] &lt;- hess[i,j] &lt;- (func(xpp) - func(xpm) - func(xmp) + func(xmm)) / (4* h[inputs[i]]*h[inputs[j]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">127</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } else {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">128</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xp = (x[1], ..., x[i] + h[i], ...)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">129</td>
                    <td class="coverage">188<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xp[inputs[i]] &lt;- x[inputs[i]] + h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">130</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xm = (x[1], ..., x[i] - h[i], ...)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">131</td>
                    <td class="coverage">188<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xm[inputs[i]] &lt;- x[inputs[i]] - h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">132</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xpp = (x[1], ..., x[i] + 2*h[i], ...)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">133</td>
                    <td class="coverage">188<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xpp[inputs[i]] &lt;- x[inputs[i]] + 2*h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">134</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # xmm = (x[1], ..., x[i] - 2*h[i], ...)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">135</td>
                    <td class="coverage">188<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        xmm[inputs[i]] &lt;- x[inputs[i]] - 2*h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">136</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # the above formula would suggest</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">137</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # (func(xpp) - 2*f0 + func(xmm)) / (4*h[inputs[i]]^2)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">138</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # but this is more o(h^4) as opposed to o(h^2) above,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">139</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # and the diagonal is critical, so use it</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">140</td>
                    <td class="coverage">188<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        hess[i,i] &lt;- (-1*func(xmm) + 16*func(xp) - 30*f0 + 16*func(xm)-1*func(xpp)) / (12*h[inputs[i]]^2)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">141</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">142</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">143</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">144</td>
                    <td class="coverage">152<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(hess)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">145</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">146</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">147</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># func(x) returns a vector of length m</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">148</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># this returns the list of first derivative</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">149</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">getJacobian &lt;- function(func, x, inputs=1:length(x), m=length(func(x))) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">150</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # this function allows you to specify a function and an output member</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">151</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # and get an function that returns only the results at that value.</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">152</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  f2 &lt;- function(fn, i) { </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">153</td>
                    <td class="coverage">126<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    function(x) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">154</td>
                    <td class="coverage">504<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      fn(x)[i]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">155</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">156</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">157</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  lapply(1:m,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">158</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">         function(i) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">159</td>
                    <td class="coverage">126<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">           getGrad(f2(func, i), x, inputs)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">160</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">         })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">161</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">162</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">163</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This function returns the first derivative of func with</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">164</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># respect to each element of x</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">165</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">getGrad &lt;- function(func, x, inputs=1:length(x), highAccuracy=TRUE) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">166</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # use a wide net</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">167</td>
                    <td class="coverage">130<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  k &lt;- length(inputs)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">168</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # calculate the gradient</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">169</td>
                    <td class="coverage">130<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  grad &lt;- vector(mode="numeric", length=k)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">170</td>
                    <td class="coverage">130<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  h &lt;- (abs(x) + 1) * sqrt(.Machine$double.eps)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">171</td>
                    <td class="coverage">130<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in 1:length(inputs)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">172</td>
                    <td class="coverage">138<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    xpp &lt;- xmm &lt;- xm &lt;- xp &lt;- x</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">173</td>
                    <td class="coverage">138<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    xp[inputs[i]] &lt;- x[inputs[i]] + h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">174</td>
                    <td class="coverage">138<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    xpp[inputs[i]] &lt;- x[inputs[i]] + 2*h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">175</td>
                    <td class="coverage">138<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    xm[inputs[i]] &lt;- x[inputs[i]] - h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">176</td>
                    <td class="coverage">138<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    xmm[inputs[i]] &lt;- x[inputs[i]] - 2*h[inputs[i]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">177</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # forward difference, does not work near max (imagine if h takes you past the max)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">178</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # (func(xp) - f0)/h[i]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">179</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # central differences work better</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">180</td>
                    <td class="coverage">138<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(highAccuracy) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">181</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # this is the o(h^4) five point stencil method (the middle points has weight 0)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">182</td>
                    <td class="coverage">138<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      ff &lt;- ( (fxmm &lt;- func(xmm)) - 8*func(xm) + 8*func(xp) - func(xpp))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">183</td>
                    <td class="coverage">138<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if( abs(80*fxmm) * .Machine$double.eps &gt; abs(ff) ) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">184</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # too close, set to zero</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">185</td>
                    <td class="coverage">21<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        grad[i] &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">186</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } else {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">187</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        # not too close to zero, use normal equation</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">188</td>
                    <td class="coverage">117<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        grad[i] &lt;- ff / (12*h[inputs[i]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">189</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">190</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">191</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      ff &lt;- (func(xp) - func(xm))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">192</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if( abs(10*fxmm) * .Machine$double.eps &gt; abs(ff) ) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">193</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        grad[i] &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">194</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">195</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # this is the o(h^2) central first difference (again, no middle point needed)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">196</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      grad[i] &lt;- ff / (2*h[inputs[i]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">197</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">198</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">199</td>
                    <td class="coverage">130<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(grad)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">200</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="R/covarianceConstructors.R" class="hidden">
              <table class="table-condensed">
                <tbody>
                  <tr class="never">
                    <td class="num">1</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># constructs a list where each element is the variance covariance matrix at that level</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">2</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param covMat data frame of variance and covariences  in the shape of the dataframe of the summary of the varcov term of results of lmer </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">3</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @description</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">4</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># Returns a function that takes the current parameter values and uses them to construct a list, </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">5</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># each element index i of the list corresponds to the variance covariance matrix at level i. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">6</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># Variances less than .01 are transformed using the function exp(var-1) in order to prevent evaluation problems caused by variaces close to 0. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">7</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># If internal parameter "mapped" is set to TRUE then this variance transformation is not performed.  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">8</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @keywords internal</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">9</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @author Claire Kelley </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">10</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">covMat2Cov &lt;- function(covMat) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">11</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  covMat$sdcor &lt;- NULL</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">12</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # returnFull- if true return both the variance-covariance matrix and the data frame (in the shape of the variance df from lme) of variance and covariances</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">13</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #             used only in debugging</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">14</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # mapped - if mapped is TRUE then variances &lt;.01 are NOT transformed using function exp(var-1)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">15</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # this transformation is continuous and allows more accurate estimation of variances close to 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">16</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # so mapped defaults  FALSE </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">17</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  function(par, returnFull=FALSE, mapped=FALSE) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">18</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ############ Outline ############</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">19</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ## 1) handle mapping very small variances to exp(var-1) in order to get more accurate ests</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">20</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ## 2) reshape data from the pairwise data frame (ie rows are  Var1,Var2,Cov) provided by lme into </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">21</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ##    list of square variance covariance matrixes for each level of the model </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">22</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">23</td>
                    <td class="coverage">1189<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    covMat$vcov &lt;- par</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">24</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">25</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ## 1) handle mapping very small variances to exp(var-1) in order to get more accurate ests</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">26</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # any variances (ie has a blank in var 2) are exponentiatied if &lt;- 0 to avoid problems around 0</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">27</td>
                    <td class="coverage">1189<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(!mapped) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">28</td>
                    <td class="coverage">1164<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      covMat$vcov &lt;- ifelse(is.na(covMat$var2) &amp; (covMat$vcov&lt;1),exp(pmax(covMat$vcov-1,-4.6)),covMat$vcov)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">29</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">30</td>
                    <td class="coverage">25<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(any(is.na(covMat$var2) &amp; (covMat$vcov &lt; 0))) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">31</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        stop("All variances must be positive.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">32</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">33</td>
                    <td class="coverage">25<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(any(is.na(covMat$var2) &amp; (covMat$vcov &lt; exp(-4.6)))) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">34</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        warning("Result may not be exact, variance too small. Try setting variance to a value over 0.01.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">35</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">36</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">37</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">38</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ## 2) reshape data</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">39</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # add the residual variance to the result list</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">40</td>
                    <td class="coverage">1189<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    res &lt;- list(s=sqrt(abs(covMat$vcov[covMat$grp=="Residual"]))) #level one variance is the residual variance </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">41</td>
                    <td class="coverage">1189<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ulvl &lt;- unique(covMat$level)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">42</td>
                    <td class="coverage">1189<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ulvl &lt;- ulvl[ulvl!=1] # remove level 1, we have already done that</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">43</td>
                    <td class="coverage">1189<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(lvli in sort(ulvl)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">44</td>
                    <td class="coverage">1195<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      covMati &lt;- covMat[covMat$level==lvli,]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">45</td>
                    <td class="coverage">1195<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      ki &lt;- length(unique(covMati$var1))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">46</td>
                    <td class="coverage">1195<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      vci &lt;- matrix(0, nrow=ki, ncol=ki)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">47</td>
                    <td class="coverage">1195<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      colnames(vci) &lt;- rownames(vci) &lt;- unique(covMati$var1)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">48</td>
                    <td class="coverage">1195<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(ii in 1:nrow(covMati)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">49</td>
                    <td class="coverage">1202<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        if(is.na(covMati$var2[ii])) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">50</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # when there is no var2 it is a diagonal element (ie variance rather than covariance)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">51</td>
                    <td class="coverage">1201<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          vci[rownames(vci)==covMati$var1[ii],colnames(vci)==covMati$var1[ii]] &lt;- sqrt(abs(covMati$vcov[ii]))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">52</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        } else {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">53</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          # this is an off diagonal element (ie covariance), find its matrix spot by matching row and column names</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">54</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          vci[rownames(vci)==covMati$var1[ii],colnames(vci)==covMati$var2[ii]] &lt;- sign(covMati$vcov[ii]) * sqrt(abs(covMati$vcov[ii]))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">55</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">          vci[rownames(vci)==covMati$var2[ii],colnames(vci)==covMati$var1[ii]] &lt;- sign(covMati$vcov[ii]) * sqrt(abs(covMati$vcov[ii]))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">56</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">57</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">58</td>
                    <td class="coverage">1195<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      res &lt;- c(res, list(vci))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">59</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">60</td>
                    <td class="coverage">1189<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(returnFull) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">61</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      return(list(cov=res, covMat=covMat))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">62</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">63</td>
                    <td class="coverage">1189<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">64</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">65</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="R/lnl.R" class="hidden">
              <table class="table-condensed">
                <tbody>
                  <tr class="never">
                    <td class="num">1</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This function is meant to be called internally for optimization.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">2</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># It is called recursively (it calls itself) with each recursion decreasing</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">3</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># the level of the requested likelihood by 1 (so, l decreases by one).</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">4</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @description</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">5</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># calculates the log-likelihood of an l level mixed model using GH quadrature.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">6</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># the genral model is y = Xb + ZU + e</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">7</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># but that values of beta and U are not included in the call. Instead this information</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">8</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># is contained in yhat which incorporates Xb at the top level and all relevant </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">9</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># Zu information at lower levels.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">10</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param y numeric vector of y values </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">11</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param X numeric matrix of X values </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">12</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param Z a list of the Z matricies where the index of Z indicates the level.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">13</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#           of the Z matricies. Z[[1]] is NULL because there is no individual lavel Zs.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">14</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param ZFull Z expended such that each Z[[i]] matrix contains  one row for each observation (ie each element has same number of rows as original data)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">15</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param Qi  a list of the scaling factosr for the adaptive quadrature points (per group) where index indicated level </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">16</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param QiFull the scaling factors for adaptive quarature points duplicated so each element has one row per observation (like Zfull)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">17</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param omega numeric, list of the b estimates for each group</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">18</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param omegaFull numeric, the b estimates for each group duplicated so each element has one row per observation (like Zfull)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">19</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param W list where each element is a numeric matrix of weights at that level, must have `w` and `index` columns</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">20</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param k integer, the number of fixed effects </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">21</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param qp numeric vector (length= nQuad) the original quadrature points</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">22</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param cConstructor function, the function used to construct the covariance matrices at each level </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">23</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param bobyqa boolean, indicating whether bobyqa should be used for optimization, default false</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">24</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param verbose boolean, should additional output ususally used for debugging be printed, default true</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">25</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param acc0 numeric, integer the accuracy for mfpr </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">26</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param mappedDefault boolean, when mapped is TRUE then variances are used as is, otherwise small (less than one) variances are exponentiated. This argument sets the default for a parameter of the returned function.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">27</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">param.lnl.quad &lt;- function(y, X, levels, Z, ZFull, Qi, QiFull, omega, omegaFull,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">28</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           W, k, qp, cConstructor, bobyqa=FALSE, verbose=TRUE,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">29</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                           acc0, mappedDefault=FALSE, family=NULL) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">30</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  function(par, acc=acc0, top=TRUE, integralMultiplierExponent=NULL,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">31</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">           integralZColumn=1, mapped=mappedDefault, varFloor=NULL) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">32</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # par- the random and fixed effects and variance </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">33</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # acc -  numeric, accuracy of the mpfr</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">34</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # top - whether the top level (ie overall likelihood rather than group likelihood) is to be returned. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">35</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # integralMultiplierExponent - a single integer, the function evaluates the</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">36</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #                                   integral times the random effect to this power</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">37</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #                                   when set to 0, it is just the log-likelhood</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">38</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #                                   when set to 1, this can be used to estimate the</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">39</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #                                   expected value.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">40</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # integralZColumn is the column index of Z to use integralMultiplierExponent on.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">41</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #                        only one random effect at a time can be integrated over, and the integration happens at the top level</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">42</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # mapped- parameter to be passed to covariance constructor which indicates wether very small variances are supposed to</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">43</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # mapped to exp(var-1) space </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">44</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">45</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">46</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    parBeta &lt;- par[1:k]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">47</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(is.null(varFloor)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">48</td>
                    <td class="coverage">150<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      par &lt;- par[ -(1:k)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">49</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">50</td>
                    <td class="coverage">6<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      par &lt;- pmax(varFloor, par[ -(1:k)])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">51</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">52</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    parC &lt;- cConstructor(par, mapped=mapped)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">53</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    yyh0 &lt;- X %*% parBeta</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">54</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">55</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    res &lt;- calc.lin.lnl.quad(y=y, yhat=yyh0, level=levels, Z=Z, ZFull=ZFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">56</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             Qi=Qi, QiFull=QiFull,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">57</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             omega=omega, omegaFull=omegaFull, W=W,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">58</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             C=parC, qp = qp, top=top,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">59</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             verbose=verbose, acc=acc,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">60</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             integralMultiplierExponent=integralMultiplierExponent,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">61</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             integralZColumn=integralZColumn,</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">62</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                             family=family)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">63</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(res)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">64</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } # ends internal function call - this is what the top level function returns</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">65</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">66</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">67</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">68</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This function calcuates the liklihood of the model using integration by adaptive quadrature </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">69</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param y a numeric vector, the response.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">70</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param yhat the current predicted values of the response</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">71</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param level an integer that respresents the number of levels in the likelihood</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">72</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#          that is desired. In a two level model this function will be called</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">73</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#          with l=2 and it will recurse and call itself with l=1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">74</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param Z a list of the Z matricies where the index of Z indicates the level.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">75</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#           of the Z matri. Z[[1]] is NULL because there is no individual lavel Zs.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">76</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param ZFull Z expended such that each Z[[i]] matrix contains  one row for each observation (ie each element has same number of rows as original data)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">77</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param Qi the scaling factor for the adaptive quadratures (per group)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">78</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param QiFull the scaling factors for adaptive quarature points duplicated so each element has one row per observation (like Zfull)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">79</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param omega a list of the b estimates for ech group</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">80</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param omegaFull numeric, the b estimates for each group duplicated so each element has one row per observation (like Zfull)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">81</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param C a list of Cholesky decompositions of the Sigma matricies.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">82</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#          C[[1]] is simply the residual variance (a scalar) while C[[l]] for </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">83</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#          l &gt; 1 is a matrix with the name number of rows and columns as the </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">84</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#          Z matrix for that level.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">85</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param qp Gaussian quadrature result from statmod::gauss.quad.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">86</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param W list of weight matricies. must have `w` and `index` columns</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">87</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param top boolean set to TRUE to return a single scalar, otherwise returns a vector</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">88</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param verbose boolean set to TRUE to get verbose output</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">89</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param acc numeric, accuracy of the mpfr</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">90</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param atPoint boolean, indicates likelihood should be calculated at single point</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">91</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#                at the top level and then integrated below that. This is useful</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">92</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#                for finding the maximum posterior (or likelihood) extimate for </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">93</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#                the random effects</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">94</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param integralMultiplierExponent a single integer, the function evaluates the</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">95</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#                                   integral times the randome effect to this power</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">96</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#                                   when set to 0, it is just the log-likelhood</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">97</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#                                   when set to 1, this can be used to estimate the</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">98</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#                                   expected value.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">99</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @param integralZColumn is the column index of Z to use integralMultiplierExponent on</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">100</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#                        only one random effect at a time can be integrated over, and the integration happens at the top level</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">101</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">102</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @description</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">103</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># calculates the log-likelihood of an l level mixed model using adaptive quadrature.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">104</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># the genral model is y = Xb + ZU + e</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">105</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># but that values of beta and U are not included in the call. Instead this information</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">106</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># is contained in yhat which incorporates Xb at the top level and all relevant </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">107</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># Zu information at lower levels.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">108</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># Applies the methodlogy of Rabe-Hesketh et al. 2005 (see pg 304-305)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">109</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom Rmpfr mpfr</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">110</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom stats dnorm aggregate</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">111</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom statmod gauss.quad</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">112</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom NPflow mvnpdfC</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">113</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">calc.lin.lnl.quad &lt;- function(y, yhat, level, Z, Qi, omega, W, C, qp,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">114</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                              top=TRUE, atPoint=FALSE, integralMultiplierExponent=NULL,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">115</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                              integralZColumn=1L,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">116</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                              verbose=TRUE, acc,</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">117</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">                              omegaFull=omega, QiFull=Qi, ZFull=Z, family) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">118</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ##################################</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">119</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ######### Outline ##############</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">120</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ### 1) Set up initial values </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">121</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ### 2) Create grid of integration points</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">122</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ### 3) Evaluate likelihood at each point and apply weights </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">123</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ### 4) sum likelihood and return results </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">124</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">125</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ### 1) Set up initial values </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">126</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #Bind y to the index present in the lowest level weights </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">127</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  data &lt;- cbind(y, W[[1]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">128</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">129</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # grab matrixes for this level </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">130</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # C stands for Covariance.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">131</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #W stands for Weights and </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">132</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # Z represents the random effects. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">133</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # Q represents the scaling factors </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">134</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # the l indicates that these are lists with each element  having the covariance, weights or random effects for level l </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">135</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # Notation follows Rabe-Hesketh, 2006 and Hartzel, 2001 (see main vignette for citations)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">136</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Cl &lt;- C[[level]] # covariance </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">137</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Wl &lt;- W[[level]] # weights</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">138</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Wlm1 &lt;- W[[level-1]] # weights for next level down</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">139</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Zl &lt;- Z[[level]] </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">140</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ZFulll &lt;- ZFull[[level]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">141</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Qil &lt;- Qi[[level]]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">142</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  QiFulll &lt;- QiFull[[level]]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">143</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">144</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # replace aggregate() calls with matrix modification for speed. declaring arrays and matrices </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">145</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ni_Wl &lt;- table((Wlm1$indexp1)) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">146</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ntot &lt;- length(Wlm1$indexp1)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">147</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Wl_indices &lt;- unique(Wlm1$indexp1)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">148</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  k_indices &lt;- length(Wl_indices)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">149</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # create block diagonal matrix for later multiplication</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">150</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  diagM1 &lt;- matrix(0, k_indices, sum(ni_Wl))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">151</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  runtot &lt;- 0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">152</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # fill block diagonal matrix </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">153</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for (ii in 1:k_indices) { </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">154</td>
                    <td class="coverage">21078<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    diagM1[ii,] &lt;- c(rep(0, runtot), rep(1, ni_Wl[ii]), rep (0, ntot - ni_Wl[ii] - runtot)) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">155</td>
                    <td class="coverage">21078<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    runtot &lt;- runtot + ni_Wl[ii]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">156</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">157</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">158</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ### 2) Create grid of integration points</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">159</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">160</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #Calcuate traditional quadrature points</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">161</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(atPoint) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">162</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # if option atPoint is true whe use only one quadrature point </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">163</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    qp &lt;- gauss.quad(1,"hermite")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">164</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    qp$weights &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">165</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    nz &lt;- nrow(Cl)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">166</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">167</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">168</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  grd &lt;- as.data.frame(qp) # create data frame of quadrature point(s) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">169</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  colnames(grd)[1:2] &lt;- paste0(c("v","w"),1)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">170</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  grd$w &lt;- grd$w1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">171</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">172</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # this creates a grid of integration points over which the likelihood will be evaluated</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">173</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(nrow(Cl)&gt;1) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">174</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(i in 2:nrow(Cl)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">175</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      dfi &lt;- grd</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">176</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      colnames(dfi) &lt;- paste0(c("v","w"),i)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">177</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # by=NULL makes the Cartesian product </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">178</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      grd &lt;- merge(grd, dfi, by=NULL)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">179</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      grd$w &lt;- grd$w * grd[,paste0("w",i)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">180</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">181</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">182</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">183</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"> </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">184</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ### 3) Evaluate likelihood at each point and apply weights </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">185</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Wl$l &lt;- 0 #set inital value of likelihood to 0, this will accumulate the likelihood as we iterate through grid points</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">186</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">187</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # iterate over grid of integration points over which the likelihood will be evaluated</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">188</td>
                    <td class="coverage">1171<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in 1:nrow(grd)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">189</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # v is the IID N(0,I) vector at this integration point</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">190</td>
                    <td class="coverage">3043<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    v &lt;- t(grd[i, paste0("v", 1:ncol(Zl))])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">191</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">   </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">192</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # this result is already weighted at the individual level</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">193</td>
                    <td class="coverage">3043<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(level == 2) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">194</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # this calcuation follows the methodology described in Hartzel 2001, pg 87</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">195</td>
                    <td class="coverage">3043<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Wlm1$pts &lt;- (omega[[level]] + sqrt(2) * matrix(t(v) %*% Qil, ncol=length(v), byrow=TRUE))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">196</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # new predicted value of y </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">197</td>
                    <td class="coverage">3043<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      yyh &lt;- yhat + rowSums(Zl * Wlm1$pts)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">198</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # calculate the weigthts at this level based on the original wight and the  probabiilty </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">199</td>
                    <td class="coverage">3043<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(is.null(family)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">200</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Wlm1$ll &lt;- Wlm1$w * dnorm(y, mean=yyh, sd=C[[1]], log=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">201</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">202</td>
                    <td class="coverage">3043<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Wlm1$ll &lt;- family$lnl(y, family$linkinv(yyh), Wlm1$w, sd=C[[1]])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">203</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">204</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">205</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # similar calcualation to level 2, but at he individual observaiton level to handle level 1 probabilty </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">206</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # used below to get "prior" lnl</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">207</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Wlm1$pts &lt;- (omega[[level]] + sqrt(2) * matrix(t(v) %*% Qil, ncol=length(v), byrow=TRUE))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">208</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # used here to get lnl at these integration points</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">209</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      pts &lt;- (omegaFull[[level]] + sqrt(2) * matrix(t(v) %*% QiFulll, ncol=length(v), byrow=TRUE))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">210</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      yyh &lt;- yhat + rowSums(ZFulll * pts)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">211</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # set top=FALSE because it will not be the top level</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">212</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Wlm1$ll &lt;- calc.lin.lnl.quad(y=y, yhat=yyh, level=level-1, Z=Z, Qi=Qi,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">213</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                   omega=omega, W=W, C=C, qp=qp, top=FALSE,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">214</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                   atPoint=FALSE, integralMultiplierExponent=NULL,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">215</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                   verbose=verbose, acc=acc,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">216</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                   omegaFull=omegaFull, QiFull=QiFull, ZFull=ZFull,</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">217</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">                                   family=family)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">218</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } # ends the else part of the if (level==2 ) conditional </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">219</td>
                    <td class="coverage">3043<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(atPoint) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">220</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # replace aggregate() calls with matrix modification for speed. actual matrix multiplication</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">221</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      agg2 &lt;- diagM1 %*% Wlm1$ll</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">222</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      agg &lt;- cbind.data.frame(Wl_indices, agg2)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">223</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #the above two lines replicate what was originally done with this line below</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">224</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #agg &lt;- aggregate(ll ~ indexp1, Wlm1, sum) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">225</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      colnames(agg) &lt;- c("index", "ll")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">226</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(!top) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">227</td>
                    <td class="coverage">1015<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        return(agg$ll)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">228</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">229</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        return(sum(agg$ll))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">230</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">231</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">232</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # evaluation of quadrature if not evaluating at a single point</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">233</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Wlm1NonD &lt;- Wlm1[!duplicated(Wlm1$indexp1),] </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">234</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # get normal probabilty of points under normal distribution  using multivariate normal pdf </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">235</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Wlm1NonD$g_weight &lt;- apply(Wlm1NonD$pts, MARGIN=1, function(p) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">236</td>
                    <td class="coverage">36504<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        mvnpdfC(as.matrix(p), rep(0, length = length(p)), varcovM=Cl%*%t(Cl), Log=TRUE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">237</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      })</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">238</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #For BLUE the integralMultiplierExponent is 1 whcih calcuates the expected value rather than the log likelihood </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">239</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(!is.null(integralMultiplierExponent)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">240</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        Wlm1NonD$x &lt;- Wlm1NonD$pts[,integralZColumn]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">241</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        aggPrior &lt;- Wlm1NonD[,c("indexp1", "g_weight", "x")]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">242</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">243</td>
                    <td class="coverage">2002<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        aggPrior &lt;- Wlm1NonD[,c("indexp1", "g_weight")]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">244</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">245</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">246</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # add likelihood for all observation in each group</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">247</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">248</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # replace aggregate() calls with matrix modification for speed. actual matrix multiplication</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">249</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      agg2 &lt;- diagM1 %*% Wlm1$ll</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">250</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      agg &lt;- cbind.data.frame(Wl_indices, agg2)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">251</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #the above two lines replicate what was originally done with this line below</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">252</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #agg &lt;- aggregate(ll ~ indexp1, Wlm1, sum) </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">253</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      colnames(agg) &lt;- c("indexp1", "ll")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">254</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      names(agg)[!names(agg) %in% "indexp1"] &lt;- "lli"</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">255</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">256</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      agg &lt;- merge(agg, aggPrior, by="indexp1")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">257</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # exponetiate to reverse the log manipulations done earlier </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">258</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # using log manipulation is important for maintaining precision when likelihood is very small </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">259</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      agg$li &lt;- exp(mpfr(log(grd$w[i]) + agg$lli + agg$g_weight + sum(v*v),acc))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">260</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(!is.null(integralMultiplierExponent)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">261</td>
                    <td class="coverage">26<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        agg$li &lt;- agg$li * agg$x^integralMultiplierExponent</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">262</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">263</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      agg &lt;- agg[,c("indexp1", "li")]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">264</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Wl &lt;- merge(Wl, agg, by.x="index", by.y="indexp1")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">265</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Wl$l &lt;- Wl$l + Wl$li * 2^(ncol(Zl)/2) * Wl$detQ</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">266</td>
                    <td class="coverage">2028<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      Wl$li &lt;- NULL</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">267</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }# ends the else part of the if(atPoint) conditional starting in line 192</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">268</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">269</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # this turns the mpfr back to a double</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">270</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">271</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">272</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ### 4) sum likelihood and return results </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">273</td>
                    <td class="coverage">156<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(!is.null(integralMultiplierExponent)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">274</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    res &lt;- Wl$l</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">275</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">276</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">277</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">278</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # log likelihood is weight * log(likelihood). As.numeric converts back from mfpr number to numeric</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">279</td>
                    <td class="coverage">154<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Wl$ll &lt;- Wl$w * as.numeric(log(Wl$l))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">280</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # reset values that became - infintity </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">281</td>
                    <td class="coverage">154<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  Wl$ll[Wl$ll== -Inf] &lt;- -.Machine$double.xmax</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">282</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">283</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">284</td>
                    <td class="coverage">154<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(top) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">285</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # if user wants top level result (ie total likelihood sum all likelihood and return)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">286</td>
                    <td class="coverage">129<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    return(sum(Wl$ll, na.rm=TRUE))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">287</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">288</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">289</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # other wise return likelihood of each group </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">290</td>
                    <td class="coverage">25<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  res &lt;- Wl$ll</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">291</td>
                    <td class="coverage">25<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  names(res) &lt;- Wl$index</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">292</td>
                    <td class="coverage">25<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">293</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="R/helpers.R" class="hidden">
              <table class="table-condensed">
                <tbody>
                  <tr class="never">
                    <td class="num">1</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This helper funciton returns just the coefficient from the WeMix results object.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">2</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @method coef WeMixResults</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">3</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @export</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">4</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">coef.WeMixResults &lt;- function(object, ...) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">5</td>
                    <td class="coverage">7<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  object$coef</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">6</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">7</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">8</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This helper function prints the coefficient from the WeMix results object.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">9</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @export</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">10</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">print.WeMixResults &lt;- function(x, ...) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">11</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  print(x$coef)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">12</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">13</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">14</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This helper funciton creates a coefficient matrix from WeMix results.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">15</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># and packages variance results in a clearer way. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">16</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom stats cov2cor model.frame</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">17</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @export</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">18</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">summary.WeMixResults &lt;- function(object, ...) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">19</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  x0 &lt;- object</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">20</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">21</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #for adaptive quad models </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">22</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(object$is_adaptive){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">23</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    VC &lt;- makeSandwich(object) # calculates the sandwhich estimator of variance </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">24</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    object$vc &lt;- VC$VC #sets variances returned by model to variances calculated by sandwich estimator</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">25</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    se &lt;- VC$se[1:length(x0$coef)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">26</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    re_se &lt;- VC$se[-(1:length(x0$coef))] #not used currently </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">27</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    x0$varVC &lt;- list(NULL,VC$VC[names(x0$vars),names(x0$vars)]) #This is hard coded for 2 levels, with a NULL because the are no refs at level 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">28</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # build the var mat output, first adding SEvcov</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">29</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varDF &lt;- x0$varDF</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">30</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varDF$SEvcov &lt;- NA</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">31</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    names(re_se) &lt;- gsub(":",".",names(re_se),fixed=TRUE) # change : to .</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">32</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for(i in 1:nrow(varDF)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">33</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if(varDF$fullGroup[i] %in% names(re_se)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">34</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        varDF$SEvcov[i] &lt;- re_se[varDF$fullGroup[i]] </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">35</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">36</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">37</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } else{</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">38</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    se &lt;- object$SE</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">39</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    re_se &lt;- rep(0, length(x0$vars))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">40</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # build the var mat output from this</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">41</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varDF &lt;- x0$varDF</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">42</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">43</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  object$coef &lt;- as.matrix(data.frame(Estimate=x0$coef, "Std. Error"=se, "t value"=x0$coef/se))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">44</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # make.names breaks/fixes colnames with spaces, un-break/-fix them.</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">45</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  colnames(object$coef)[2:3] &lt;- c("Std. Error", "t value")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">46</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  rownames(object$coef) &lt;- names(x0$coef)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">47</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # build the var mat output</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">48</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varsmat &lt;- varDF[is.na(x0$varDF$var2),c("level","grp", "var1","vcov","SEvcov")]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">49</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varsmat$st &lt;- sqrt(varsmat$vcov)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">50</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  # add variance estimates</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">51</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  colnames(varsmat) &lt;- c("Level", "Group", "Name", "Variance", "Std. Error", "Std.Dev.")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">52</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(li in 2:x0$levels) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">53</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    vc &lt;- as.matrix(x0$varVC[[li]])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">54</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    cr &lt;- cov2cor(vc)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">55</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(ncol(vc)&gt;1) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">56</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      for(i in 2:ncol(cr)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">57</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        for(j in 1:(i-1)){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">58</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">          varsmat[varsmat$Level==li &amp; varsmat$Name==rownames(cr)[i],paste0("Corr",j)] &lt;- cr[i,j]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">59</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">60</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">61</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">62</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">63</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">64</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  object$varsmat &lt;- varsmat</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">65</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #this is important for compatibility  with mixed.sdf</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">66</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  object$vars  &lt;- varsmat[,4:6]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">67</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  rownames(object$vars)  &lt;- names(x0$vars)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">68</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">69</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  class(object) &lt;- "summaryWeMixResults"</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">70</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(object)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">71</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">72</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">73</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This helper function prints WeMix Wald Test Resuls.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">74</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @export</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">75</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">print.WeMixWaldTest &lt;- function(x, ...) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">76</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("Wald Test Statistic\n")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">77</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat(x$W)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">78</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("\n\np-value\n")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">79</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat(round(x$p,4))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">80</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("\n\nDegrees of Freedom\n")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">81</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat(x$df)</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">82</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("\n\nNull Hypothesis\n")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">83</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if (class(x$H0)=="matrix"){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">84</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    print(apply(x$H0,FUN=round,digits=4,MARGIN=c(1:length(dim(x$H0)))))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">85</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">86</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    print(round(x$H0,4))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">87</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">88</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("\n\nAlternative Hypothesis\n")</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">89</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if (class(x$HA)=="matrix"){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">90</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    print(apply(x$HA,FUN=round,digits=4,MARGIN=c(1:length(dim(x$H0)))))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">91</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">92</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    print(round(x$HA,4))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">93</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">94</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">95</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">96</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This helper function creates a coefficient matrix from WeMix results.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">97</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @export</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">98</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom stats printCoefmat</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">99</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">print.summaryWeMixResults &lt;- function(x, digits = max(3, getOption("digits") - 3), nsmall=2, ...) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">100</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("Call:\n")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">101</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  print(x$call)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">102</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("\nVariance terms:\n")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">103</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varsmat &lt;- x$varsmat</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">104</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  varsmat &lt;- varsmat[order(varsmat$Level, decreasing=TRUE),]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">105</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  i &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">106</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  while(paste0("Corr",i) %in% colnames(varsmat)) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">107</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # round correlations to two digits</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">108</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    varsmat[[paste0("Corr",i)]] &lt;- as.character(round(varsmat[[paste0("Corr",i)]],2))</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">109</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    i &lt;- i + 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">110</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">111</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  print(varsmat, na.print="", row.names=FALSE, digits=digits, nsmall=nsmall)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">112</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("Groups:\n")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">113</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  groupSum &lt;- varsmat[!duplicated(varsmat$Level), c("Level", "Group")]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">114</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(any(groupSum$Level==1)) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">115</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    groupSum$Group[groupSum$Level==1] &lt;- "Obs"</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">116</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">117</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    newrow &lt;- groupSum[1,]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">118</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    newrow$Level &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">119</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    newrow$Group &lt;- "Obs"</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">120</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    groupSum &lt;- rbind(groupSum, newrow)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">121</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">122</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  groupSum$"n size" &lt;- rev(x$ngroups)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">123</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for(i in 1:length(x$wgtStats)) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">124</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    groupSum$"mean wgt"[groupSum$Level == i] &lt;- x$wgtStats[[i]]$mean</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">125</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    groupSum$"sum wgt"[groupSum$Level == i] &lt;- x$wgtStats[[i]]$sum</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">126</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">127</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  print(groupSum, na.print="", row.names=FALSE, digits=digits, nsmall=nsmall)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">128</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("\nFixed Effects:\n")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">129</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  printCoefmat(x$coef, digits=digits, ...)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">130</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  cat("\nlnl=",format(x$lnl, nsmall=nsmall),"\n")</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">131</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if(length(x$ICC) &gt; 0) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">132</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">    cat("Intraclass Correlation=",format(x$ICC, nsmall=nsmall, digits=digits),"\n")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">133</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">134</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">135</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">136</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' Mixed Model Wald Tests</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">137</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @description</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">138</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' This function calculates the Wald test for either fixed effects or variance parameters.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">139</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param fittedModel a  model of class \code{WeMixResults} that is the result of a call to \code{\link{mix}} </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">140</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param type a string, one of "beta" (to test the fixed effects) or "Lambda" (to test the variance-covariance parameters for the random effects)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">141</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param coefs a vector containing the names of the coefficients to test. For \code{type="beta"} these must be</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">142</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'              the variable names exactly as they appear in the fixed effects table of the summary. For \code{type="Lambda"}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">143</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'              these must be the names exactly as they appear in the theta element of the fitted model. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">144</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @param hypothesis the hypothesized values of beta or Lambda. If \code{NA} (the default) 0 will be used. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">145</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @details</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">146</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' By default this function tests against the null hypothesis that all coefficients are zero.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">147</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' To identify which coefficients to test use the name exactly as it appears in </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">148</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' the summary of the object.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">149</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @return Object of class \code{WeMixWaldTest}. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">150</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' This is a list with the following elements: </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">151</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{wald}{the value of the test statistic.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">152</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{p}{the p-value for the test statistic. Based on the probabilty of the test statistic</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">153</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' under the chi-squared distribution.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">154</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{df}{degrees of freedom used to calculate p-value.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">155</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{H0}{The vector (for a test of beta) or matrix (for tests of Lambda) containing the </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">156</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' null hypothesis for the test.}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">157</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \item{HA}{The vector (for a test of beta) or matrix (for tests of Lambda) containing the </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">158</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' alternative hypothesis for the test (i.e. the values calculated by the fitted model being </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">159</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' tested.)} </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">160</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @examples </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">161</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' \dontrun{</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">162</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' library(lme4) #to use the example data </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">163</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' sleepstudyU &lt;- sleepstudy</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">164</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' sleepstudyU$weight1L1 &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">165</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' sleepstudyU$weight1L2 &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">166</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' wm0 &lt;- mix(Reaction ~ Days + (1|Subject), data=sleepstudyU, </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">167</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'             weights=c("weight1L1", "weight1L2"))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">168</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' wm1 &lt;- mix(Reaction ~ Days + (1 +Days|Subject), data=sleepstudyU, </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">169</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'            weights=c("weight1L1", "weight1L2"))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">170</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">171</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' waldTest(wm0, type="beta")  #test all betas </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">172</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' #test only beta for days </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">173</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' waldTest(wm0, type="beta", coefs="Days")  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">174</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' #test only beta for intercept against hypothesis that it is 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">175</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' waldTest(wm0, type="beta", coefs="(Intercept)", hypothesis=c(1))  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">176</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">177</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' waldTest(wm1,type="Lambda")  #test all values of Lambda</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">178</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#'  #test only some Lambdas.The names are the same as names(wm1$theta)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">179</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' waldTest(wm1,type="Lambda", coefs="Subject.(Intercept)") </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">180</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' #specify  test values</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">181</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' waldTest(wm1,type="Lambda", coefs="Subject.(Intercept)", hypothesis=c(1))  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">182</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">183</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom stats pchisq </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">184</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @export</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">185</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">waldTest &lt;- function(fittedModel, type=c("beta", "Lambda") , coefs=NA, hypothesis=NA) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">186</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  type &lt;- match.arg(type,c("beta", "Lambda"))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">187</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  if (type == "Lambda"){</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">188</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # names of the coefs </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">189</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if (all(is.na(coefs))) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">190</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      coef_names &lt;- names(fittedModel$theta)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">191</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">192</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      coef_names &lt;- coefs</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">193</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">194</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">195</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #number of parameters </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">196</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    q &lt;- length(coef_names)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">197</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">198</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #total coefficients </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">199</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    p &lt;- length(fittedModel$theta)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">200</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">201</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # this block sets up R, the hypothesis matrix </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">202</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # it has a row for each parameter to be tested (q) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">203</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # it has a column for each parameter that exists in the model</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">204</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    R &lt;-  matrix(0, nrow=q, ncol=p)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">205</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    rownames(R) &lt;- coef_names</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">206</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    colnames(R) &lt;- names(fittedModel$theta)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">207</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">208</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # Fill in one for each  each coefficient to  be tested in the relevant row</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">209</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for (coef in coef_names){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">210</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if (any(!coef_names %in% names(fittedModel$theta))){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">211</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        stop("Names of coefficients to test must be the same as names of theta in the fitted model.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">212</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">213</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      R[coef, coef] &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">214</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">215</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">216</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #this block sets up the r vector of hypothesized values for theta</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">217</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if (all(is.na(hypothesis))){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">218</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      r &lt;- rep(0,q)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">219</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">220</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if (length(hypothesis) != q){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">221</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">        stop("Length of hypothesized values must be same as number of coefficients to test.")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">222</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">223</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      r &lt;- hypothesis</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">224</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">225</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    names(r) &lt;- coef_names</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">226</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">227</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # get variance covariance matrix </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">228</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    V_hat &lt;- fittedModel$var_theta</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">229</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">230</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #estimates </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">231</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ests &lt;- fittedModel$theta</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">232</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">233</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #create var-cov matrix for null and alternative hypothesis </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">234</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    variances &lt;- fittedModel$varDF[!is.na(fittedModel$varDF$var1) &amp; is.na(fittedModel$varDF$var2),"fullGroup"]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">235</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    h0  &lt;- matrix(0,nrow=length(variances),ncol=length(variances))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">236</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    rownames(h0) &lt;- colnames(h0)  &lt;- variances</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">237</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ha &lt;- h0</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">238</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">   </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">239</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #fill with theta values (for null hypothesis) - but only those related to the parameters  we are test</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">240</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #handle positioning covariance</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">241</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for (i  in 1:length(r)){</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">242</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #decompose name into parts</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">243</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      var &lt;- r[i]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">244</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      parts &lt;- unlist(strsplit(names(var),".",fixed=T))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">245</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if (length(parts)&gt;2){  #These are covariances </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">246</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        group &lt;- parts[1]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">247</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        v1 &lt;-paste0(group,".",parts[2])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">248</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        v2 &lt;-paste0(group,".",parts[3])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">249</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }  else { #these are variances </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">250</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        group &lt;- parts[1]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">251</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        v1 &lt;-paste0(group,".",parts[2])</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">252</td>
                    <td class="coverage">3<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">        v2 &lt;-paste0(group,".",parts[2])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">253</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">254</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      #put value alue into var-covar matrix</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">255</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      h0[v1,v2] &lt;- var</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">256</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      h0[v2,v1] &lt;- var</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">257</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">258</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      ha[v1,v2] &lt;- fittedModel$theta[names(var)]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">259</td>
                    <td class="coverage">5<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      ha[v2,v1] &lt;- fittedModel$theta[names(var)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">260</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">261</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } else { # end if (type == "Lambda")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">262</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # wald test for beta values</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">263</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # names of the coefs </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">264</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if  (all(is.na(coefs))) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">265</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      coef_names &lt;- names(fittedModel$coef)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">266</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">267</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      coef_names &lt;- coefs</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">268</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">269</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">270</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #number of parameters </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">271</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    q &lt;- length(coef_names)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">272</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">273</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #total coefficients </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">274</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    p &lt;- length(fittedModel$coef)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">275</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">276</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # this block sets up  R the hypothesis matrix </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">277</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # it has a row for each parameter to be tested (q) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">278</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # it has a column for each parameter that exists in the model</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">279</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    R &lt;-  matrix(0,nrow=q,ncol=p)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">280</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    rownames(R) &lt;- coef_names</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">281</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    colnames(R) &lt;- names(fittedModel$coef)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">282</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">283</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # Fill in one for each  each coefficient to  be tested in the relevant row</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">284</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    for (coef in coef_names){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">285</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if (any(!coef_names %in% names(fittedModel$coef))){stop("Names of coefficients to test must be the same as names of beta in the fitted model.")}</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">286</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      R[coef,coef] &lt;- 1</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">287</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">288</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">289</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #this block sets up the r vector of hypothesized values for theta</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">290</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if (all(is.na(hypothesis))){</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">291</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      r &lt;- rep(0,q)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">292</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">293</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      if (length(hypothesis) != q){stop("Length of hypothesized values must be same as number of coefficients to test.")}</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">294</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      r &lt;- hypothesis</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">295</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">296</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">297</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    # Covariance matrix of beta</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">298</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    if(fittedModel$is_adaptive){</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">299</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      # this is a glm</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">300</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      VC &lt;- makeSandwich(fittedModel) # calculates the sandwhich estimator of variance </pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">301</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">      V_hat &lt;- VC$VC[1:(q+1), 1:(q+1)]</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">302</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    } else {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">303</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">      V_hat &lt;- fittedModel$cov_mat</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">304</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    }</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">305</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">   </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">306</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #estimates </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">307</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ests &lt;- fittedModel$coef</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">308</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">309</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    #Make hypothesis vectors to return</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">310</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    h0 &lt;- ests[coef_names]</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">311</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    ha &lt;- r </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">312</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    names(ha) &lt;- coef_names</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">313</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  } #end else for if (type == "beta")</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">314</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">315</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #Wald test using the following equation</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">316</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #W = (Rb - r)^T (RVR^T)^-1 (Rb - r)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">317</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  W = as.numeric(t(R%*%ests - r)  %*% solve(R  %*% V_hat  %*% t(R)) %*% (R%*%ests - r))</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">318</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  ch = 1 - pchisq(W, df=q)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">319</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  res &lt;- list("Wald"=W,"p"=ch ,"df"=q,"H0"= h0,"HA"=ha)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">320</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  class(res) &lt;- "WeMixWaldTest"</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">321</td>
                    <td class="coverage">4<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(res)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">322</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">323</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">324</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This function calculates robust standard errors using the sandwich estimator of the standard errors  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">325</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># following Rabe-Hesketh &amp; Skrondal 2006. For linear models, robust standard errors are returned from the main estimation function. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">326</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># This function is only used for post-hoc estimation for non-linear models. </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">327</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">#' @importFrom numDeriv jacobian</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">328</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">makeSandwich &lt;- function(fittedModel) {</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">329</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #make same estimator based on </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">330</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">331</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  par &lt;- c(fittedModel$coef, fittedModel$vars)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">332</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  FisherInfInverse &lt;- solve(fittedModel$invHessian)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">333</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">334</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">335</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  L &lt;- jacobian(fittedModel$lnlf, par, top=FALSE)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">336</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  nGroups &lt;- nrow(L)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">337</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  nParams &lt;- length(par)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">338</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  J &lt;- matrix(0,ncol=nParams, nrow=nParams)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">339</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  for (i in 1:nGroups){</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">340</td>
                    <td class="coverage">18<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">    J &lt;- J + L[i,] %*% t(L[i,])</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">341</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  }</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">342</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  J &lt;- (nGroups/(nGroups-1))*J</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">343</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  SE &lt;- FisherInfInverse%*%J%*%FisherInfInverse</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">344</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  colnames(SE) &lt;- rownames(SE)&lt;-names(par)</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">345</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  se &lt;- sqrt(diag(SE)) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">346</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">347</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  #return NA for obs with variance below threshold </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">348</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  se[which(log(fittedModel$vars) &lt; -3.6) + length(fittedModel$coef) ] &lt;- NA</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">349</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  diag(SE) &lt;- se^2 </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">350</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">351</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  names(se) &lt;- colnames(SE)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">352</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  </pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">353</td>
                    <td class="coverage">1<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  return(list(VC=SE,se=se)) </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">354</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"> </pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">355</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">356</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">357</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"></pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">358</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># TRUE if x has no zeros in it. False if it does have a zero.</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">359</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># useful for finding columns with non-zero entries in lapply</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">360</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">nozero &lt;- function(x) {</pre>
                    </td>
                  </tr>
                  <tr class="missed">
                    <td class="num">361</td>
                    <td class="coverage">!</td>
                    <td class="col-sm-12">
                      <pre class="language-r">  any(x != 0)</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">362</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="R/zzz.R" class="hidden">
              <table class="table-condensed">
                <tbody>
                  <tr class="never">
                    <td class="num">1</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r"># @author Paul Bailey</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">2</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">.onAttach &lt;- function(libname, pkgname) {</pre>
                    </td>
                  </tr>
                  <tr class="covered">
                    <td class="num">3</td>
                    <td class="coverage">2<em>x</em></td>
                    <td class="col-sm-12">
                      <pre class="language-r">  packageStartupMessage(paste0("WeMix v", utils::packageDescription("WeMix")$Version, "\n"))</pre>
                    </td>
                  </tr>
                  <tr class="never">
                    <td class="num">4</td>
                    <td class="coverage"></td>
                    <td class="col-sm-12">
                      <pre class="language-r">}</pre>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <script>$('div#files pre').each(function(i, block) {
    hljs.highlightBlock(block);
});</script>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
